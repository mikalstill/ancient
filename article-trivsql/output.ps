%!PS-Adobe-2.0
%%Creator: dvips(k) 5.86 Copyright 1999 Radical Eye Software
%%Title: output.dvi
%%Pages: 76
%%PageOrder: Ascend
%%BoundingBox: 0 0 596 842
%%DocumentFonts: Helvetica-Bold Palatino-Bold Palatino-Roman Courier
%%+ Palatino-Italic
%%EndComments
%DVIPSWebPage: (www.radicaleye.com)
%DVIPSCommandLine: dvips -q output.dvi -o output.ps
%DVIPSParameters: dpi=600, compressed
%DVIPSSource:  TeX output 2002.10.09:1912
%%BeginProcSet: texc.pro
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/id 0 N/rw 0 N/rc 0 N/gp 0 N/cp 0 N/G 0 N/CharBuilder{save 3
1 roll S A/base get 2 index get S/BitMaps get S get/Cd X pop/ctr 0 N Cdx
0 Cx Cy Ch sub Cx Cw add Cy setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx
sub Cy .1 sub]/id Ci N/rw Cw 7 add 8 idiv string N/rc 0 N/gp 0 N/cp 0 N{
rc 0 ne{rc 1 sub/rc X rw}{G}ifelse}imagemask restore}B/G{{id gp get/gp
gp 1 add N A 18 mod S 18 idiv pl S get exec}loop}B/adv{cp add/cp X}B
/chg{rw cp id gp 4 index getinterval putinterval A gp add/gp X adv}B/nd{
/cp 0 N rw exit}B/lsh{rw cp 2 copy get A 0 eq{pop 1}{A 255 eq{pop 254}{
A A add 255 and S 1 and or}ifelse}ifelse put 1 adv}B/rsh{rw cp 2 copy
get A 0 eq{pop 128}{A 255 eq{pop 127}{A 2 idiv S 128 and or}ifelse}
ifelse put 1 adv}B/clr{rw cp 2 index string putinterval adv}B/set{rw cp
fillstr 0 4 index getinterval putinterval adv}B/fillstr 18 string 0 1 17
{2 copy 255 put pop}for N/pl[{adv 1 chg}{adv 1 chg nd}{1 add chg}{1 add
chg nd}{adv lsh}{adv lsh nd}{adv rsh}{adv rsh nd}{1 add adv}{/rc X nd}{
1 add set}{1 add clr}{adv 2 chg}{adv 2 chg nd}{pop nd}]A{bind pop}
forall N/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "22 June 1996",
%   filename = "8r.enc",
%   email = "kb@@mail.tug.org",
%   address = "135 Center Hill Rd. // Plymouth, MA 02360",
%   codetable = "ISO/ASCII",
%   checksum = "119     662    4424",
%   docstring = "Encoding for TrueType or Type 1 fonts to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there down to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def

%%EndProcSet
%%BeginProcSet: texps.pro
%!
TeXDict begin/rf{findfont dup length 1 add dict begin{1 index/FID ne 2
index/UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type/integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics/Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont/setfont cvx]cvx def}def/ObliqueSlant{
dup sin S cos div neg}B/SlantFont{4 index mul add}def/ExtendFont{3 -1
roll mul exch}def/ReEncodeFont{CharStrings rcheck{/Encoding false def
dup[exch{dup CharStrings exch known not{pop/.notdef/Encoding true def}
if}forall Encoding{]exch pop}{cleartomark}ifelse}if/Encoding exch def}
def end

%%EndProcSet
%%BeginProcSet: special.pro
%!
TeXDict begin/SDict 200 dict N SDict begin/@SpecialDefaults{/hs 612 N
/vs 792 N/ho 0 N/vo 0 N/hsc 1 N/vsc 1 N/ang 0 N/CLIP 0 N/rwiSeen false N
/rhiSeen false N/letter{}N/note{}N/a4{}N/legal{}N}B/@scaleunit 100 N
/@hscale{@scaleunit div/hsc X}B/@vscale{@scaleunit div/vsc X}B/@hsize{
/hs X/CLIP 1 N}B/@vsize{/vs X/CLIP 1 N}B/@clip{/CLIP 2 N}B/@hoffset{/ho
X}B/@voffset{/vo X}B/@angle{/ang X}B/@rwi{10 div/rwi X/rwiSeen true N}B
/@rhi{10 div/rhi X/rhiSeen true N}B/@llx{/llx X}B/@lly{/lly X}B/@urx{
/urx X}B/@ury{/ury X}B/magscale true def end/@MacSetUp{userdict/md known
{userdict/md get type/dicttype eq{userdict begin md length 10 add md
maxlength ge{/md md dup length 20 add dict copy def}if end md begin
/letter{}N/note{}N/legal{}N/od{txpose 1 0 mtx defaultmatrix dtransform S
atan/pa X newpath clippath mark{transform{itransform moveto}}{transform{
itransform lineto}}{6 -2 roll transform 6 -2 roll transform 6 -2 roll
transform{itransform 6 2 roll itransform 6 2 roll itransform 6 2 roll
curveto}}{{closepath}}pathforall newpath counttomark array astore/gc xdf
pop ct 39 0 put 10 fz 0 fs 2 F/|______Courier fnt invertflag{PaintBlack}
if}N/txpose{pxs pys scale ppr aload pop por{noflips{pop S neg S TR pop 1
-1 scale}if xflip yflip and{pop S neg S TR 180 rotate 1 -1 scale ppr 3
get ppr 1 get neg sub neg ppr 2 get ppr 0 get neg sub neg TR}if xflip
yflip not and{pop S neg S TR pop 180 rotate ppr 3 get ppr 1 get neg sub
neg 0 TR}if yflip xflip not and{ppr 1 get neg ppr 0 get neg TR}if}{
noflips{TR pop pop 270 rotate 1 -1 scale}if xflip yflip and{TR pop pop
90 rotate 1 -1 scale ppr 3 get ppr 1 get neg sub neg ppr 2 get ppr 0 get
neg sub neg TR}if xflip yflip not and{TR pop pop 90 rotate ppr 3 get ppr
1 get neg sub neg 0 TR}if yflip xflip not and{TR pop pop 270 rotate ppr
2 get ppr 0 get neg sub neg 0 S TR}if}ifelse scaleby96{ppr aload pop 4
-1 roll add 2 div 3 1 roll add 2 div 2 copy TR .96 dup scale neg S neg S
TR}if}N/cp{pop pop showpage pm restore}N end}if}if}N/normalscale{
Resolution 72 div VResolution 72 div neg scale magscale{DVImag dup scale
}if 0 setgray}N/psfts{S 65781.76 div N}N/startTexFig{/psf$SavedState
save N userdict maxlength dict begin/magscale true def normalscale
currentpoint TR/psf$ury psfts/psf$urx psfts/psf$lly psfts/psf$llx psfts
/psf$y psfts/psf$x psfts currentpoint/psf$cy X/psf$cx X/psf$sx psf$x
psf$urx psf$llx sub div N/psf$sy psf$y psf$ury psf$lly sub div N psf$sx
psf$sy scale psf$cx psf$sx div psf$llx sub psf$cy psf$sy div psf$ury sub
TR/showpage{}N/erasepage{}N/copypage{}N/p 3 def @MacSetUp}N/doclip{
psf$llx psf$lly psf$urx psf$ury currentpoint 6 2 roll newpath 4 copy 4 2
roll moveto 6 -1 roll S lineto S lineto S lineto closepath clip newpath
moveto}N/endTexFig{end psf$SavedState restore}N/@beginspecial{SDict
begin/SpecialSave save N gsave normalscale currentpoint TR
@SpecialDefaults count/ocount X/dcount countdictstack N}N/@setspecial{
CLIP 1 eq{newpath 0 0 moveto hs 0 rlineto 0 vs rlineto hs neg 0 rlineto
closepath clip}if ho vo TR hsc vsc scale ang rotate rwiSeen{rwi urx llx
sub div rhiSeen{rhi ury lly sub div}{dup}ifelse scale llx neg lly neg TR
}{rhiSeen{rhi ury lly sub div dup scale llx neg lly neg TR}if}ifelse
CLIP 2 eq{newpath llx lly moveto urx lly lineto urx ury lineto llx ury
lineto closepath clip}if/showpage{}N/erasepage{}N/copypage{}N newpath}N
/@endspecial{count ocount sub{pop}repeat countdictstack dcount sub{end}
repeat grestore SpecialSave restore end}N/@defspecial{SDict begin}N
/@fedspecial{end}B/li{lineto}B/rl{rlineto}B/rc{rcurveto}B/np{/SaveX
currentpoint/SaveY X N 1 setlinecap newpath}N/st{stroke SaveX SaveY
moveto}N/fil{fill SaveX SaveY moveto}N/ellipse{/endangle X/startangle X
/yrad X/xrad X/savematrix matrix currentmatrix N TR xrad yrad scale 0 0
1 startangle endangle arc savematrix setmatrix}N end

%%EndProcSet
%%BeginProcSet: color.pro
%!
TeXDict begin/setcmykcolor where{pop}{/setcmykcolor{dup 10 eq{pop
setrgbcolor}{1 sub 4 1 roll 3{3 index add neg dup 0 lt{pop 0}if 3 1 roll
}repeat setrgbcolor pop}ifelse}B}ifelse/TeXcolorcmyk{setcmykcolor}def
/TeXcolorrgb{setrgbcolor}def/TeXcolorgrey{setgray}def/TeXcolorgray{
setgray}def/TeXcolorhsb{sethsbcolor}def/currentcmykcolor where{pop}{
/currentcmykcolor{currentrgbcolor 10}B}ifelse/DC{exch dup userdict exch
known{pop pop}{X}ifelse}B/GreenYellow{0.15 0 0.69 0 setcmykcolor}DC
/Yellow{0 0 1 0 setcmykcolor}DC/Goldenrod{0 0.10 0.84 0 setcmykcolor}DC
/Dandelion{0 0.29 0.84 0 setcmykcolor}DC/Apricot{0 0.32 0.52 0
setcmykcolor}DC/Peach{0 0.50 0.70 0 setcmykcolor}DC/Melon{0 0.46 0.50 0
setcmykcolor}DC/YellowOrange{0 0.42 1 0 setcmykcolor}DC/Orange{0 0.61
0.87 0 setcmykcolor}DC/BurntOrange{0 0.51 1 0 setcmykcolor}DC
/Bittersweet{0 0.75 1 0.24 setcmykcolor}DC/RedOrange{0 0.77 0.87 0
setcmykcolor}DC/Mahogany{0 0.85 0.87 0.35 setcmykcolor}DC/Maroon{0 0.87
0.68 0.32 setcmykcolor}DC/BrickRed{0 0.89 0.94 0.28 setcmykcolor}DC/Red{
0 1 1 0 setcmykcolor}DC/OrangeRed{0 1 0.50 0 setcmykcolor}DC/RubineRed{
0 1 0.13 0 setcmykcolor}DC/WildStrawberry{0 0.96 0.39 0 setcmykcolor}DC
/Salmon{0 0.53 0.38 0 setcmykcolor}DC/CarnationPink{0 0.63 0 0
setcmykcolor}DC/Magenta{0 1 0 0 setcmykcolor}DC/VioletRed{0 0.81 0 0
setcmykcolor}DC/Rhodamine{0 0.82 0 0 setcmykcolor}DC/Mulberry{0.34 0.90
0 0.02 setcmykcolor}DC/RedViolet{0.07 0.90 0 0.34 setcmykcolor}DC
/Fuchsia{0.47 0.91 0 0.08 setcmykcolor}DC/Lavender{0 0.48 0 0
setcmykcolor}DC/Thistle{0.12 0.59 0 0 setcmykcolor}DC/Orchid{0.32 0.64 0
0 setcmykcolor}DC/DarkOrchid{0.40 0.80 0.20 0 setcmykcolor}DC/Purple{
0.45 0.86 0 0 setcmykcolor}DC/Plum{0.50 1 0 0 setcmykcolor}DC/Violet{
0.79 0.88 0 0 setcmykcolor}DC/RoyalPurple{0.75 0.90 0 0 setcmykcolor}DC
/BlueViolet{0.86 0.91 0 0.04 setcmykcolor}DC/Periwinkle{0.57 0.55 0 0
setcmykcolor}DC/CadetBlue{0.62 0.57 0.23 0 setcmykcolor}DC
/CornflowerBlue{0.65 0.13 0 0 setcmykcolor}DC/MidnightBlue{0.98 0.13 0
0.43 setcmykcolor}DC/NavyBlue{0.94 0.54 0 0 setcmykcolor}DC/RoyalBlue{1
0.50 0 0 setcmykcolor}DC/Blue{1 1 0 0 setcmykcolor}DC/Cerulean{0.94 0.11
0 0 setcmykcolor}DC/Cyan{1 0 0 0 setcmykcolor}DC/ProcessBlue{0.96 0 0 0
setcmykcolor}DC/SkyBlue{0.62 0 0.12 0 setcmykcolor}DC/Turquoise{0.85 0
0.20 0 setcmykcolor}DC/TealBlue{0.86 0 0.34 0.02 setcmykcolor}DC
/Aquamarine{0.82 0 0.30 0 setcmykcolor}DC/BlueGreen{0.85 0 0.33 0
setcmykcolor}DC/Emerald{1 0 0.50 0 setcmykcolor}DC/JungleGreen{0.99 0
0.52 0 setcmykcolor}DC/SeaGreen{0.69 0 0.50 0 setcmykcolor}DC/Green{1 0
1 0 setcmykcolor}DC/ForestGreen{0.91 0 0.88 0.12 setcmykcolor}DC
/PineGreen{0.92 0 0.59 0.25 setcmykcolor}DC/LimeGreen{0.50 0 1 0
setcmykcolor}DC/YellowGreen{0.44 0 0.74 0 setcmykcolor}DC/SpringGreen{
0.26 0 0.76 0 setcmykcolor}DC/OliveGreen{0.64 0 0.95 0.40 setcmykcolor}
DC/RawSienna{0 0.72 1 0.45 setcmykcolor}DC/Sepia{0 0.83 1 0.70
setcmykcolor}DC/Brown{0 0.81 1 0.60 setcmykcolor}DC/Tan{0.14 0.42 0.56 0
setcmykcolor}DC/Gray{0 0 0 0.50 setcmykcolor}DC/Black{0 0 0 1
setcmykcolor}DC/White{0 0 0 0 setcmykcolor}DC end

%%EndProcSet
TeXDict begin 39158280 55380996 1000 600 600 (output.dvi)
@start
%DVIPSBitmapFont: Fa cmmi9 9 2
/Fa 2 63 df<171C177EEE01FEEE07FCEE1FF0EE7FC0923801FF00ED07FCED1FF0ED7FC0
4A48C7FCEC07FCEC1FF0EC7FC04948C8FCEB07FCEB1FF0EB7FC04848C9FCEA07FCEA1FF0
EA7FC048CAFCA2EA7FC0EA1FF0EA07FCEA01FF38007FC0EB1FF0EB07FCEB01FF9038007F
C0EC1FF0EC07FCEC01FF9138007FC0ED1FF0ED07FCED01FF9238007FC0EE1FF0EE07FCEE
01FEEE007E171C2F2E7AA93C>60 D<127012FCB4FCEA7FC0EA1FF0EA07FCEA01FF38007F
C0EB1FF0EB07FCEB01FF9038007FC0EC1FF0EC07FCEC01FF9138007FC0ED1FF0ED07FCED
01FF9238007FC0EE1FF0EE07FCEE01FEA2EE07FCEE1FF0EE7FC0923801FF00ED07FCED1F
F0ED7FC04A48C7FCEC07FCEC1FF0EC7FC04948C8FCEB07FCEB1FF0EB7FC04848C9FCEA07
FCEA1FF0EA7FC048CAFC12FC12702F2E7AA93C>62 D E
%EndDVIPSBitmapFont
/Fb 106[40 149[{TeXBase1Encoding ReEncodeFont}1 66.4176
/Palatino-Roman rf /Fc 135[51 2[56 30 51 36 1[56 56 56
81 25 2[25 56 56 30 51 56 51 1[51 13[61 1[71 61 3[56
4[71 1[61 66 66 8[30 18[25 39[{TeXBase1Encoding ReEncodeFont}28
91.3242 /Helvetica-Bold rf /Fd 134[42 42 1[42 46 28 32
32 38 42 37 46 65 23 37 1[23 42 42 23 32 42 34 38 37
1[42 11[46 1[65 4[46 8[55 1[60 6[21 42 42 42 42 42 42
42 42 42 42 25 21 28 2[32 39[44 2[{TeXBase1Encoding ReEncodeFont}45
83.022 /Palatino-Italic rf /Fe 107[45 15[45 5[45 45 45
45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45
45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45
45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45
45 45 45 45 45 45 45 45 45 1[45 45 45 45 45 45 45 45
45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45 45
45 33[{TeXBase1Encoding ReEncodeFont}95 74.7198 /Courier
rf /Ff 205[25 25 49[{TeXBase1Encoding ReEncodeFont}2
49.8132 /Palatino-Roman rf /Fg 107[42 42 24[42 46 43
69 47 50 27 35 33 46 50 45 48 73 24 46 19 24 48 46 28
40 51 37 46 42 7[55 1[83 60 65 51 44 55 65 50 65 69 79
51 2[28 69 63 46 51 64 59 51 65 1[37 3[21 21 5[42 42
42 42 1[50 21 28 21 1[32 28 28 23 3[42 31[50 50 2[{
TeXBase1Encoding ReEncodeFont}68 83.022 /Palatino-Roman
rf /Fh 134[56 2[56 61 33 56 39 61 61 61 61 89 28 2[28
61 61 33 56 61 56 61 56 9[95 1[73 61 67 1[78 4[61 2[28
1[78 3[73 1[73 1[61 63[{TeXBase1Encoding ReEncodeFont}32
100.457 /Helvetica-Bold rf /Fi 134[46 2[46 51 28 37 32
51 51 46 51 74 28 2[28 51 46 32 42 51 37 51 42 1[42 7[83
1[65 55 51 60 69 2[69 1[51 2[32 1[69 1[51 69 60 55 65
1[37 4[21 42 42 42 42 42 42 42 4[21 46[{TeXBase1Encoding ReEncodeFont}
47 83.022 /Palatino-Bold rf /Fj 139[37 61 3[68 68 1[31
5[37 61 2[68 61 12[68 5[80 10[80 67[{TeXBase1Encoding ReEncodeFont}12
110.502 /Helvetica-Bold rf /Fk 134[74 2[74 82 45 74 52
82 82 82 82 1[37 2[37 1[82 45 74 1[74 1[74 13[89 1[104
4[82 10[97 6[45 58[{TeXBase1Encoding ReEncodeFont}22
133.707 /Helvetica-Bold rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin
%%PaperSize: A4

%%EndSetup
%%Page: 1 1
1 0 bop Black 0 TeXcolorgray Black Black 424 104 a Fk(trivsql:)37
b(A)g(trivial)h(SQL)f(engine)g(f)m(or)f(y)m(our)h(application)197
308 y Fj(T)-9 b(ab)o(le)30 b(of)g(Contents)p 0 TeXcolorgray
596 455 a Fi(Introduction)p Black Black 12 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
0 TeXcolorgray -1 w(3)p Black 0 TeXcolorgray 596 566
a(About)19 b(the)h(author)p Black Black 10 w(.)p Black
Black -2 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black 0 TeXcolorgray -1 w(3)p
Black 0 TeXcolorgray 596 677 a(An)g(introduction)e(to)j(tdb)p
Black Black 12 w(.)p Black Black -1 w(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black 0 TeXcolorgray
-1 w(3)p Black 0 TeXcolorgray 596 788 a(Why)f(trivsql?)p
Black Black 7 w(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black 0 TeXcolorgray -1 w(3)p
Black 0 TeXcolorgray 596 900 a(Why)g(SQL?)p Black Black
3 w(.)p Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black 0 TeXcolorgray -1 w(4)p
Black 0 TeXcolorgray 596 1011 a(The)g(current)g(state)f(of)i(play)p
Black Black 7 w(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black 0 TeXcolorgray
-1 w(4)p Black 0 TeXcolorgray 596 1122 a(Genstruct)e(as)h(an)g
(alternative)p Black Black 1 w(.)p Black Black -4 w(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black 0 TeXcolorgray
-1 w(5)p Black 0 TeXcolorgray 596 1233 a(What)f(is)h(genstruct?)p
Black Black 5 w(.)p Black Black -1 w(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black 0 TeXcolorgray -1 w(5)p Black 0
TeXcolorgray 596 1345 a(The)g(other)g(side)f(of)j(the)d(equation)p
Black Black 15 w(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black 0 TeXcolorgray -1 w(7)p Black 0 TeXcolorgray
596 1456 a(Additional)e(features)p Black Black 3 w(.)p
Black Black -2 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black 0 TeXcolorgray -1 w(8)p Black 0
TeXcolorgray 596 1567 a(Limitations)p Black Black 11
w(.)p Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black 0 TeXcolorgray
-1 w(8)p Black 0 TeXcolorgray 596 1678 a(Uses)p Black
Black 3 w(.)p Black Black -2 w(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black 0 TeXcolorgray -1 w(8)p Black 0 TeXcolorgray
596 1790 a(Genstruct)i(pros)h(and)g(cons)p Black Black
14 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black 0 TeXcolorgray -1 w(8)p
Black 0 TeXcolorgray 596 1901 a(Code)g(listings)p Black
Black 12 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black 0 TeXcolorgray -1 w(9)p Black 0 TeXcolorgray 596
2012 a(Conclusion)p Black Black 17 w(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black(.)p Black Black -1 w(.)p Black
Black(.)p Black Black(.)p Black Black(.)p Black Black
-1 w(.)p Black Black(.)p Black Black(.)p Black Black(.)p
Black Black -1 w(.)p Black Black(.)p Black Black(.)p
Black Black(.)p Black Black -1 w(.)p Black Black(.)p
Black Black(.)p Black Black(.)p Black Black -1 w(.)p
Black Black(.)p Black Black(.)p Black Black(.)p Black
Black -1 w(.)p Black Black(.)p Black Black(.)p Black
Black(.)p Black Black -1 w(.)p Black Black(.)p Black
0 TeXcolorgray(76)p Black Black Black eop
%%Page: 2 2
2 1 bop Black 0 TeXcolorgray Black Black Black Black
eop
%%Page: 3 3
3 2 bop Black 0 TeXcolorgray Black Black 197 89 a Fh(Intr)n(oduction)
596 231 y Fi(trivsql)30 b Fg(is)i(a)e(simple)i(SQL)f(engine,)h
(implemented)f(on)h(the)g Fi(tdb)e Fg(database)g(engine.)h(The)h(in-)
596 322 y(tention)e(of)f Fi(trivsql)g Fg(is)h(that)f(it)h(is)g
(embedded)e(into)i(your)g(application,)f(allowing)i(the)e(use)h(of)596
413 y(familiar)20 b(SQL)g(constr)o(ucts)i(for)e(accessing)h(data)f
(stor)o(ed)g(within)i(your)f(application.)596 546 y Fi(trivsql)d
Fg(is)j(licensed)f(under)f(the)h(terms)g(of)g(the)g(GNU)g(GPL,)g(as)g
(is)g(the)g Fi(tdb)f Fg(engine)i(upon)f(which)596 637
y(it)g(depends.)197 956 y Fh(About)29 b(the)g(author)596
1097 y Fg(Michael)h(has)h(been)f(working)i(in)g(the)f(image)f(pr)o
(ocessing)i(\002eld)e(for)h(several)f(years,)g(includ-)596
1188 y(ing)d(a)f(couple)h(of)g(years)f(managing)i(and)e(developing)h
(lar)o(ge)f(image)h(databases)e(for)i(an)f(Aus-)596 1280
y(tralian)16 b(government)h(department.)f(He)g(curr)o(ently)g(works)i
(for)e(T)o(OWER)h(Softwar)o(e,)e(who)i(man-)596 1371
y(ufactur)o(e)28 b(a)h(world)i(leading)e(EDMS)g(and)h(Recor)o(ds)g
(Management)f(package)g(named)g(TRIM.)596 1462 y(Michael)21
b(is)i(also)g(the)g(developer)f(of)g(Panda,)g(an)g(open)h(sour)o(ce)f
(PDF)h(generation)g(API,)f(as)h(well)596 1554 y(as)31
b(being)h(the)g(maintainer)f(of)h(the)f(comp.text.pdf)g(USENET)f(fr)o
(equently)h(asked)g(questions)596 1645 y(document.)596
1778 y(Michael)20 b(has)g(a)h(website)g(at)f(http://www)-8
b(.stillhq.com.)197 2096 y Fh(An)28 b(intr)n(oduction)j(to)d(tdb)596
2237 y Fi(tdb)21 b Fg(is)h(a)g(\(name,)f(value\))g(pair)h(database)e
(similar)j(to)f Fi(gdbm)p Fg(.)f(It)i(was)f(originally)h(implemented)
596 2329 y(for)g(the)i(Samba)d(pr)o(oject,)i(as)g(a)f(way)h(of)g
(avoiding)h(having)f(to)g(implement)h(a)f(lar)o(ge)f(number)h(of)596
2420 y(in)f(memory)g(linked)g(lists)h(for)e(storing)i(usage)e(and)h
(access)f(information.)h(The)g(code)f(for)h Fi(tdb)f
Fg(is)596 2511 y(available)d(fr)o(om)h(the)h(Samba)f(CVS)g(server)-6
b(.)596 2644 y(T)e(o)19 b(quote)g(fr)o(om)g(the)g(Samba)e(sour)o(ce)i
(code:)f(\223This)h(is)g(a)f(simple)i(database)d(API.)h(It)h(was)f
(inspir)o(ed)596 2736 y(by)23 b(the)h(r)o(ealisation)g(that)f(in)i
(Samba)d(we)i(have)f(several)g(ad-hoc)g(bits)h(of)g(code)g(that)f
(essentially)596 2827 y(implement)g(small)h(databases)d(for)i(sharing)g
(str)o(uctur)o(es)g(between)f(parts)h(of)g(Samba.)e(As)i(I)g(was)596
2918 y(about)33 b(to)g(add)f(another)i(I)f(r)o(ealised)e(that)j(a)e
(generic)h(database)f(module)h(was)g(called)g(for)g(to)596
3010 y(r)o(eplace)20 b(all)i(the)g(ad-hoc)f(bits.)h(I)g(based)f(the)h
(interface)f(on)i(gdbm.)f(I)g(couldn't)g(use)g(gdbm)g(as)g(we)596
3101 y(need)e(to)h(be)f(able)h(to)g(have)f(multiple)h(writers)g(to)g
(the)g(databases)e(at)i(one)g(time.\224)596 3234 y(T)-8
b(o)21 b(make)f(use)h(of)g(a)f Fi(tdb)g Fg(database)f(at)h(the)h(most)h
(trivial)e(level,)h(you)g(open)g(the)g(database)e(with)i(a)596
3325 y Fi(tdb_open)i Fg(function)j(call,)f(you)h(can)f(then)h(add)e
(pairs)h(to)h(the)f(database)f(using)i(the)g Fi(tdb_store)596
3416 y Fg(function,)39 b(and)f(r)o(etrieve)g(pairs)g(fr)o(om)g(the)h
(database)e(with)j(the)f Fi(tdb_fetch)e Fg(function.)i(The)596
3508 y(database)18 b(is)k(closed)e(when)i(you)f(ar)o(e)e(\002nished)j
(with)f(the)g(via)g(the)g Fi(tdb_close)d Fg(function.)3436
3474 y Ff(1)197 3826 y Fh(Wh)n(y)28 b(trivsql?)596 3967
y Fg(The)g(functionality)i(of)o(fer)o(ed)d(by)i Fi(tdb)f
Fg(is)h(satisfactory)f(for)h(simple)g(databases)e(wher)o(e)i(all)f(you)
596 4059 y(want)22 b(to)h(stor)o(e)f(is)g(small)h(nuggets)g(of)f(data.)
f(For)i(instance,)f(when)h(you)g(want)f(to)h(stor)o(e)f(that)g(the)596
4150 y(user)e(Daniel)h(is)g(logged)g(on,)g(then)h(a)e(piece)g(of)h
(code)f(such)h(as:)685 4315 y Fe(TDB_CONTEXT)43 b(db;)685
4397 y(TDB_DATA)h(dbkey,)f(dbdata;)685 4562 y(//)i(Open)f(the)g
(database)685 4644 y(document->db)f(=)i(tdb_open)e(\("foo.tdb",)g(0,)
1806 4726 y(TDB_CLEAR_IF_FIRST,)f(O_RDWR)h(|)i(O_CREAT)f(|)g(O_TRUNC,)
1806 4808 y(0600\);)685 4973 y(//)h(Store)f(the)g(value)685
5055 y(dbkey.dptr)f(=)i("Daniel";)685 5137 y(dbkey.dsize)e(=)i(strlen)f
(\(key\))g(+)g(1;)685 5219 y(dbdata.dptr)f(=)i("LoggedOn";)685
5301 y(dbdata.dsize)e(=)i(strlen)e(\(value\))h(+)h(1;)685
5466 y(if)g(\(tdb_store)e(\(db,)h(dbkey,)g(dbdata,)f(TDB_REPLACE\))g
(!=)i(0\))p Black 3642 5585 a Fd(3)p Black eop
%%Page: 4 4
4 3 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 775 89 a Fe({)865 171 y(fprintf\(stderr,)42 b("Could)i(not)g
(store)g(value"\);)775 253 y(})596 428 y Fg(And)20 b(to)h(r)o(etrieve)e
(the)i(value:)685 593 y Fe(TDB_CONTEXT)43 b(db;)685 675
y(TDB_DATA)h(dbkey,)f(dbdata;)685 840 y(//)i(Open)f(the)g(database)685
922 y(document->db)f(=)i(tdb_open)e(\("foo.tdb",)g(0,)1806
1004 y(TDB_CLEAR_IF_FIRST,)f(O_RDWR)h(|)i(O_CREAT)f(|)g(O_TRUNC,)1806
1086 y(0600\);)685 1251 y(//)h(Fetch)f(the)g(value)685
1333 y(dbkey.dptr)f(=)i("Daniel";)685 1415 y(dbkey.dsize)e(=)i(strlen)f
(\(key\))g(+)g(1;)685 1579 y(dbdata)g(=)h(tdb_fetch)e(\(document->db,)f
(dbkey\);)596 1754 y Fg(This)31 b(doesn't)g(work)h(so)f(well)g(when)h
(the)f(data)e(you)j(want)e(to)i(stor)o(e)e(is)h(mor)o(e)g(complex.)g
(For)596 1845 y(example,)21 b(let's)i(imagine)f(that)h(we)f(want)h(to)f
(stor)o(e)g(some)h(mor)o(e)f(information)i(about)e(Daniel)h(--)596
1936 y(for)e(instance)g(how)i(many)e(bytes)h(he)f(has)h(transfer)o(ed)d
(this)k(session)f(and)f(a)g(list)h(of)g(his)g(favourite)596
2028 y(users.)d(I)h(can)f(think)i(of)f(thr)o(ee)f(ways)h(that)g(we)g
(can)f(stor)o(e)h(this)g(information)h(in)f(a)f Fi(tdb)g
Fg(database:)p Black 712 2368 a(1.)p Black 20 w(W)-8
b(e)38 b(can)g(de\002ne)h(a)f(str)o(uctur)o(e)f(that)i(contains)g
(these)f(elements,)h(and)f(then)h(stor)o(e)f(the)795
2459 y(pointer)c(to)g(this)g(str)o(uctur)o(e)f(in)i(the)e
Fi(tdb)p Fg(.)g(The)h(pr)o(oblem)f(with)h(this)h(is)f(that)g(it)f
(doesn't)795 2551 y(persist)f(acr)o(oss)h(r)o(estarts)e(of)i(the)f(pr)o
(ogram,)g(because)g(the)h(pointer)f(will)i(no)f(longer)g(be)795
2642 y(valid.)p Black 712 2775 a(2.)p Black 20 w(W)-8
b(e)26 b(can)f(use)h(a)g(series)g(of)g(inter)o(estingly)g(named)g
(keys,)g(each)f(storing)i(a)e(piece)h(of)g(infor)o(-)795
2866 y(mation.)21 b(For)g(example:)p Black 911 2999 a(a.)p
Black 20 w(daniel-bytestransfer)o(ed)p Black 907 3132
a(b.)p Black 20 w(daniel-friends)p Black 916 3265 a(c.)p
Black 20 w(et)g(cetera)795 3398 y(The)30 b(pr)o(oblem)f(with)i(this)g
(is)f(that)g(it)h(pr)o(oduces)e(horribly)i(verbose)e(code,)h(because)f
(the)795 3489 y(code)20 b(to)h(r)o(ead)e(a)i(single)g(key)g(is)g(r)o
(epeated)e(all)h(over)h(the)g(place.)p Black 712 3622
a(3.)p Black 20 w(W)-8 b(e)23 b(can)f(push)i(all)f(the)g(information)h
(into)f(one)h(string,)f(and)g(then)g(stor)o(e)g(that)g(in)g(the)g
Fi(tdb)p Fg(,)795 3713 y(but)d(this)g(means)g(that)g(we)g(have)f(to)i
(handle)e(parsing)h(the)g(information)h(again)f(when)g(you)795
3804 y(need)26 b(it)g(back.)g(Since)g(writing)h Fi(trivsql)e
Fg(the)i(Samba)e(team)h(has)g(dealt)f(with)j(exactly)d(this)795
3896 y(pr)o(oblem)h(in)i(this)f(manner)-6 b(.)27 b(T)-8
b(o)27 b(ease)f(the)h(implementation,)h(Dr)f(Andr)o(ew)f(T)-7
b(ridgell)26 b(has)795 3987 y(written)h Fi(genstruct)p
Fg(,)e(which)j(takes)e(c)h(str)o(uctur)o(es)g(\(including)g(pointers\))
g(and)g(serializes)795 4078 y(them)21 b(into)h(strings.)f
Fi(genstruct)e Fg(is)i(available)f(fr)o(om)g(http://www)-8
b(.samba.or)o(g.)p Black 712 4211 a(4.)p Black 20 w(Y)g(ou)25
b(can)e(use)h Fi(trivsql)p Fg(,)f(which)i(looks)g(after)e(all)g(the)i
(ugliness)f(for)g(you,)g(and)g(allows)g(you)795 4302
y(to)d(perform)g(select)g(and)g(insert)g(statements)g(in)h(a)f(manner)g
(familiar)f(to)i(many)f(pr)o(ogram-)795 4394 y(mers.)f(It)h(also)g
(makes)g(you)g(mor)o(e)g(attractive)e(to)i(the)g(opposite)g(sex.)197
4845 y Fh(Wh)n(y)28 b(SQL?)596 4986 y Fg(SQL)e(was)h(selected)f(as)h(a)
f(logical)h(layer)g(over)f Fi(tdb)g Fg(because)g(ther)o(e)h(ar)o(e)e
(many)i(developers)f(in)596 5078 y(the)c(world)i(which)f(ar)o(e)f(alr)o
(eady)f(familiar)h(with)h(it.)g(It)g(is)g(also)g(r)o(elatively)f
(simple)h(to)g(parse)f(and)596 5169 y(pr)o(ocess)e(the)h(commands.)596
5302 y(Later)c(in)j(this)f(article)g(I)f(will)i(discuss)f(some)h(of)f
(the)g(techniques)h(I)f(have)f(used)h(to)g(parse)f(the)h(SQL)596
5393 y(commands)i(pr)o(esented)e(to)j Fi(trivsql)p Fg(.)p
Black 197 5585 a Fd(4)p Black eop
%%Page: 5 5
5 4 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 197 89 a Fh(The)29 b(current)g(state)f(of)h(pla)n(y)596
231 y Fg(The)d(intention)i(is)f(not)h(to)f(implement)g(the)g(full)f
(SQL)h(speci\002cation)g(at)f(this)h(time.)g(Curr)o(ently)-9
b(,)596 322 y Fi(trivsql)19 b Fg(supports)j(the)f(CREA)-6
b(TE)20 b(T)-6 b(ABLE)20 b(command;)h(the)g(SELECT)e(command;)j(and)e
(the)h(IN-)596 413 y(SER)m(T)28 b(command.)g(By)h(the)f(time)h(this)g
(paper)f(is)h(pr)o(esented)e(at)h(AUUG,)g(the)g(UPDA)-6
b(TE)28 b(com-)596 505 y(mand)20 b(will)i(also)f(be)f(implemented.)596
757 y Fc(Examples)k(of)i(use)596 894 y Fg(The)20 b(\002nal)h(paper)f
(will)h(discuss)g(how)h(to)f(use)g Fi(trivsql)p Fg(,)f(and)g(will)h
(include)g(examples...)197 1295 y Fh(Genstruct)29 b(as)f(an)g
(alternative)596 1436 y Fg(Given)e(that)h(the)f(Samba)g(team)g(chose)h
(to)g(use)f Fi(genstruct)f Fg(to)i(solve)g(this)g(same)f(pr)o(oblem,)g
(it)h(is)596 1528 y(worthwhile)22 b(to)f(brie\003y)g(discuss)g(their)g
(solution.)197 1846 y Fh(What)28 b(is)g(g)q(enstruct?)596
1987 y Fg(As)37 b(pr)o(eviously)h(mentioned,)g Fi(genstruct)e
Fg(is)i(very)f(similar)h(in)g(some)h(r)o(espects)d(to)i(the)g(perl)596
2078 y Fi(Data::Dumper)p Fg(.)52 b(It)k(is)f(ther)o(efor)o(e)f(useful)h
(to)h(pr)o(ovide)f(a)f(brief)h(intr)o(oduction)h(to)g(that)596
2170 y(functionality)21 b(befor)o(e)f(moving)h(onto)h
Fi(genstruct)p Fg(.)596 2422 y Fc(P)m(erl')-5 b(s)24
b(Data::Dumper)i(in)f(a)g(n)o(utshell)596 2559 y Fg(Perl's)20
b Fi(Data::Dumper)f Fg(is)i(quite)g(simple)g(to)h(use:)596
2692 y(Which)f(pr)o(oduces...)596 3124 y Fc(Genstruct)596
3261 y Fi(genstruct)g Fg(is)i(a)f(perl)g(pr)o(ogram)g(which)i(is)f(r)o
(un)g(at)f(compile)h(time.)g(It)g(parses)f(the)h(c)f(header)g(\002les)
596 3352 y(for)29 b(the)i(pr)o(ogram)e(you)i(want)f(to)h(use)f
Fi(genstruct)f Fg(with,)i(using)g(tags)f(that)g(you)h(have)f(to)g(em-)
596 3444 y(bed)24 b(into)j(the)e(header)g(\002le.)g(For)h(example,)e
(the)i(sample)f(which)h(comes)g(with)h Fi(genstruct)c
Fg(is)j(as)596 3535 y(follows:)596 3700 y Fe(GENSTRUCT)43
b(enum)h(fruit)g({APPLE,)g(ORANGE=2,)f(PEAR,)954 3782
y(RASBERRY,)g(PEACH};)596 3947 y(GENSTRUCT)596 4029 y(struct)g(test2)
596 4111 y({)640 4193 y(int)i(x1;)640 4276 y(char)g(*foo;)640
4358 y(char)g(fstring[20];)d(_NULLTERM)640 4440 y(int)j(dlen;)640
4522 y(char)g(*dfoo;)e(_LEN\(dlen\))640 4604 y(enum)i(fruit)e(fvalue;)
640 4687 y(struct)h(test2)g(*next;)596 4769 y(};)596
4933 y(GENSTRUCT)f(struct)h(test1)g({)640 5015 y(char)h(foo[100];)640
5098 y(char)g(*foo2[20];)640 5180 y(int)g(xlen;)640 5262
y(int)g(*iarray;)e(_LEN\(xlen\);)640 5344 y(unsigned)h(slen;)640
5426 y(char)h(**strings;)e(_LEN\(slen\);)p Black 3642
5585 a Fd(5)p Black eop
%%Page: 6 6
6 5 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(char)45 b(*s2[5];)640 171 y(double)f(d1,)g(d2,)h(d3;)
640 253 y(struct)f(test2)g(*test2;)640 336 y(int)h(alen;)640
418 y(struct)f(test2)g(*test2_array;)f(_LEN\(alen\);)640
500 y(struct)h(test2)g(*test2_fixed[2];)640 582 y(int)h(plen;)640
664 y(struct)f(test2)g(**test2_parray;)e(_LEN\(plen\))596
747 y(};)596 921 y Fd(Code:)20 b(../short-genstruct/article.sgml)596
1054 y Fg(In)31 b(this)h(example)f(you)h(can)f(see)g(that)g(str)o
(uctur)o(es)h(which)g(should)g(have)f Fi(genstruct)f
Fg(enabled)596 1145 y(have)k(the)i Fi(GENSTRUCT)f Fg(attribute)f
(associated)h(with)h(them,)f(you)h(ar)o(e)e(ther)o(efor)o(e)f(not)j(r)o
(e-)596 1236 y(quir)o(ed)27 b(to)i(have)f(all)h(of)f(the)h(data)e(str)o
(uctur)o(es)h(in)h(your)g(code)f(exportable.)f Fi(GENSTRUCT)i
Fg(is)596 1328 y(mer)o(ely)20 b(an)g(empty)h(#de\002ne,)f(which)i(the)f
Fi(genstruct)e Fg(header)g(\002le)i(parser)f(can)h(sear)o(ch)e(for)-6
b(.)596 1461 y(T)e(o)21 b(cr)o(eate)e(a)h(string)i(r)o(epr)o
(esentation)d(of)i(a)f(data)g(str)o(uctur)o(e,)g(simply:)596
1626 y Fe(char)44 b(*s;)596 1708 y(struct)f(test1)h(t;)596
1872 y(//)g(...)g(we)h(need)f(to)g(populate)g(t)h(with)f(data)g(here)g
(...)596 2037 y(s)g(=)h(gen_dump\(pinfo_test1,)c(\(char)j(*\))h(&t,)f
(0\);)596 2211 y Fg(In)19 b(this)i(code,)e(we)g(de\002ne)h(a)f(str)o
(uctur)o(e,)g(\002ll)h(it)g(with)g(data,)e(and)h(then)i(use)e(the)h
Fi(gen_dump)d Fg(func-)596 2302 y(tion)25 b(to)g(cr)o(eate)d(a)i
(string)i(r)o(epr)o(esentation)d(of)h(that)h(str)o(uctur)o(e.)f(The)g
(ar)o(guments)g(to)h Fi(gen_dump)596 2394 y Fg(ar)o(e:)596
2559 y Fe(char)44 b(*gen_dump\(const)e(struct)i(parse_struct)f(*pinfo,)
1268 2641 y(const)h(char)g(*data,)1268 2723 y(unsigned)f(indent\);)p
Black 596 3064 a Fb(\225)p Black 43 w Fd(const)30 b(struct)h
(parse_struct)g(*pinfo)p Fg(:)g(is)h(generated)e(at)g(compile)i(time)f
(by)h Fi(genstruct)p Fg(,)d(and)i(is)679 3155 y(located)20
b(in)h(the)g(output)g(to)g(that)g(command.)p Black 596
3288 a Fb(\225)p Black 43 w Fd(const)i(char)g(*data)p
Fg(:)g(is)h(the)f(data)g(to)h(dump)g(to)g(the)f(string)i(r)o(epr)o
(esentation)d(\(simply)i(cast)g(your)679 3379 y(str)o(uctur)o(e)c(to)h
(a)f(char)g(*)i(befor)o(e)d(passing)i(it.)p Black 596
3512 a Fb(\225)p Black 43 w Fd(unsigned)f(indent)p Fg(:)h(is)g(the)g
(starting)g(indent)g(for)g(ease)f(of)g(r)o(ecursive)g(calling.)h(Set)f
(it)h(to)g(zer)o(o.)p Black 596 3645 a Fb(\225)p Black
43 w Fi(Returns)p Fg(:)e(a)h(string)h(r)o(epr)o(esentation)f(of)h(the)g
(str)o(uctur)o(e.)596 3911 y(The)26 b(most)i(inter)o(esting)f(thing)g
(her)o(e)f(is)h(the)g Fd(pinfo)f Fg(str)o(uctur)o(e)g(which)i(is)f(the)
g(\002rst)f(ar)o(gument)h(to)596 4002 y(this)21 b Fi(gen_dump)e
Fg(function.)i(The)g Fd(pinfo_test1)e Fg(in)i(this)h(example)e(looks)i
(like:)596 4167 y Fe(static)43 b(const)h(struct)g(parse_struct)f
(pinfo_test1[])g(=)h({)596 4249 y({"foo",)f(0,)i(sizeof\(char\),)d
(offsetof\(struct)h(test1,)g(foo\),)h(100,)h(NULL,)685
4332 y(0,)g(gen_dump_char,)d(gen_parse_char},)596 4414
y({"foo2",)h(1,)h(sizeof\(char\),)f(offsetof\(struct)f(test1,)i
(foo2\),)g(20,)g(NULL,)685 4496 y(0,)h(gen_dump_char,)d
(gen_parse_char},)596 4578 y({"xlen",)h(0,)h(sizeof\(int\),)f
(offsetof\(struct)g(test1,)g(xlen\),)h(0,)h(NULL,)685
4660 y(0,)g(gen_dump_int,)d(gen_parse_int},)596 4742
y({"iarray",)h(1,)h(sizeof\(int\),)f(offsetof\(struct)f(test1,)i
(iarray\),)g(0,)685 4825 y("xlen",)g(0,)g(gen_dump_int,)f
(gen_parse_int},)596 4907 y(//)h(...)g(and)h(so)f(on)h(...)596
4989 y({NULL,)e(0,)i(0,)f(0,)h(0,)f(NULL,)g(0,)h(NULL,)f(NULL}};)596
5163 y Fg(This)34 b(table)f(might)h(seem)g(a)f(bit)h(daunting)f(at)h
(\002rst,)f(but)h(r)o(eaders)d(need)j(to)f(r)o(emember)g(that)596
5255 y(they'r)o(e)27 b(not)i(expected)e(to)i(be)e(able)h(to)h(r)o(ead,)
d(generate,)h(or)h(use)g(these)h(tables.)e(They)i(ar)o(e)d(cr)o(e-)596
5346 y(ated)19 b(solely)j(for)e(the)h(use)g(of)g Fi(genstruct)p
Fg(.)596 5479 y(The)f(output)h(of)g(the)g Fi(gen_dump)e
Fg(function)i(call)g(will)g(be)g(something)h(like:)p
Black 197 5585 a Fd(6)p Black eop
%%Page: 7 7
7 6 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(foo)44 b(=)h({hello)e(foo})596 171
y(foo2)h(=)g(1:{foo2)g(\\7d)g(you},)g(2:{foo2)g(you)g(2})596
253 y(xlen)g(=)g(6)596 336 y(iarray)f(=)i(0:9,)f(1:4,)g(2:3,)g(3:9,)h
(4:7)596 418 y(slen)f(=)g(3)596 500 y(strings)f(=)i(0:{test)e(string)h
(48},)g(1:{test)g(string)g(69},)g(2:{test)g(string)g(36})596
582 y(s2)g(=)h(2:{t2)f(string)f(0},)i(3:{t2)f(string)g(74})596
664 y(d1)g(=)h(3.5)596 747 y(d3)f(=)h(-7)596 829 y(test2)f(=)g({)954
911 y(x1)h(=)f(4)954 993 y(foo)g(=)h({hello)f(\\7b)g(there})954
1075 y(fstring)g(=)g({blah)g(1})954 1158 y(dlen)g(=)h(12)954
1240 y(dfoo)f(=)h({q\\a9\\08z\\faO\\ca\\e3\\1d\\b2M\\88})954
1322 y(fvalue)f(=)h(APPLE)954 1404 y(next)f(=)h({)1313
1486 y(x1)f(=)h(5)1313 1569 y(foo)f(=)h({hello)f(\\7b)g(there})1313
1651 y(fstring)f(=)i({blah)f(1})1313 1733 y(dlen)g(=)h(28)1313
1815 y(dfoo)f(=)h({\\e8\\8f\\dc\\1c\\0e\\c7\)'\\ea\\da\\07e\\ca\\04)o
(2\\ce\\0)o(78?\\b0)o(@\\ba\\a)o(b\\90\\8)o(4\\8e\\a)o(d6})1313
1897 y(fvalue)f(=)g(APPLE)1313 1979 y(next)g(=)h({)1671
2062 y(x1)g(=)g(6)1671 2144 y(foo)g(=)f({hello)g(\\7b)h(there})1671
2226 y(fstring)f(=)h({blah)f(1})1671 2308 y(dlen)h(=)f(27)1671
2390 y(dfoo)h(=)f({5r\\c3\\c4O\\e0\\d2\\16)266 b
(\\f9\\01\\e3\\01f\\ad\\05\\98\\7b^L\\d0\\bb\\bd\\11u)o(h\\a1\\f)o(9})
1671 2473 y(fvalue)44 b(=)h(APPLE)1671 2555 y(next)g(=)f({)2030
2637 y(x1)h(=)f(7)2030 2719 y(foo)g(=)h({hello)f(\\7b)g(there})2030
2801 y(fstring)g(=)g({blah)g(1})2030 2884 y(dlen)g(=)h(14)2030
2966 y(dfoo)f(=)h({N/\\d1\\83\\a2\\94G\\f1t\\1a\\07\\7d\\13\\08})2030
3048 y(fvalue)f(=)h(APPLE)1671 3130 y(})1313 3212 y(})954
3295 y(})596 3377 y(})596 3551 y Fg(This)21 b(string)g(r)o(epr)o
(esentation)f(can)g(then)h(be)g(stor)o(ed)f(for)h(later)f(use.)197
3952 y Fh(The)29 b(other)g(side)f(of)g(the)h(equation)596
4094 y Fg(The)24 b(only)h(r)o(eason)f(you)g(would)h(use)f(a)g(package)f
(such)i(as)f Fi(Data::Dumper)e Fg(or)i Fi(genstruct)f
Fg(is)h(so)596 4185 y(that)19 b(you)h(can)g(r)o(ead)e(the)h
(information)i(back)e(in)h(later)-6 b(.)19 b(This)h(is)g(done)f(with)i
(the)f Fi(eval)e Fg(function)i(in)596 4276 y(perl.)e
Fi(genstruct)p Fg('s)f(equivalent)i(is)g Fi(gen_parse)p
Fg(,)d(which)k(takes)e(your)h(string)h(r)o(epr)o(esentation)d(and)596
4368 y(r)o(ecr)o(eates)h(the)j(data)e(str)o(uctur)o(es)i(as)f(stor)o
(ed.)g(The)h(ar)o(guments)f(to)h Fi(gen_parse)e Fg(ar)o(e:)596
4533 y Fe(int)44 b(gen_parse\(const)e(struct)i(parse_struct)f(*pinfo,)
1223 4615 y(char)h(*data,)1223 4697 y(const)g(char)g(*str0\);)p
Black 596 5038 a Fb(\225)p Black 43 w Fd(const)33 b(struct)h
(parse_struct)g(*pinfo)p Fg(:)g(is)g(the)g(same)g(parse)f(str)o(uctur)o
(e)h(that)g(was)g(used)f(in)i(the)679 5129 y Fi(gen_dump)18
b Fg(call.)p Black 596 5262 a Fb(\225)p Black 43 w Fd(char)24
b(*data)p Fg(:)g(is)h(a)f(pointer)i(to)f(the)g(location)h(that)e(the)i
(str)o(uctur)o(e)e(should)i(be)e(cr)o(eated)f(at.)h(This)679
5353 y(memory)d(should)h(alr)o(eady)c(have)j(been)f(allocated)g(\(for)g
(the)h(main)g(str)o(uctur)o(e\).)p Black 3642 5585 a
Fd(7)p Black eop
%%Page: 8 8
8 7 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black Black 596 89 a Fb(\225)p Black 43 w Fd(const)g(char)g(*str0)p
Fg(:)h(the)g(string)g(r)o(epr)o(esentation)f(to)h(use.)p
Black 596 222 a Fb(\225)p Black 43 w Fi(Returns)p Fg(:)e(non)i(zer)o(o)
f(if)h(ther)o(e)f(was)g(an)h(err)o(or)-6 b(.)596 355
y(A)20 b(sample)g(usage)h(is:)596 520 y Fe(char)44 b(*s;)596
602 y(struct)f(test1)h(t1,)h(t2;)596 767 y(//)f(...)g(we)h(need)f(to)g
(populate)g(t1)g(with)h(data)f(here)g(...)596 931 y(s)g(=)h
(gen_dump\(pinfo_test1,)c(\(char)j(*\))h(&t1,)f(0\);)596
1013 y(memset\(&t2,)e(0,)j(sizeof\(t2\)\);)596 1178 y
(if\(gen_parse\(pinfo_test1,)40 b(\(char)k(*\))h(&t2,)f(s\))g(!=)h
(0\){)685 1260 y(printf\("Parse)e(failed!\\n"\);)685
1342 y(exit\(1\);)685 1424 y(})197 1784 y Fh(Ad)o(ditional)29
b(f)o(eatures)596 1925 y Fi(genstruct)19 b Fg(also)i(has)f(the)h
(following)i(additional)d(featur)o(es:)p Black 596 2167
a Fb(\225)p Black 43 w Fg(It)27 b(is)g(smart)g(enough)h(to)g(neatly)f
(handle)g(the)g(addition)g(and)g(r)o(emoval)f(of)h(members)h(of)f(the)
679 2259 y(str)o(uctur)o(e.)p Black 596 2391 a Fb(\225)p
Black 43 w Fg(The)e(output)g(is)h(pr)o(esented)d(in)j(a)f(human)g(r)o
(eadable)e(form,)i(which)h(might)g(make)f(editing)g(of)679
2483 y(the)20 b(contents)i(of)f(a)f(str)o(uctur)o(e)g(easier)-6
b(.)197 2934 y Fh(Limitations)596 3075 y Fi(genstruct)29
b Fg(doesn't)j(curr)o(ently)f(handle)h(str)o(uctur)o(es)f(which)h
(contain)g(\002le)g(handles)f(pr)o(operly)-9 b(.)596
3166 y(The)24 b(\002le)h(handle)g(itself)f(\(which)i(is)f(just)g(an)g
(int\))g(will)g(be)g(r)o(ecover)o(ed,)d(but)j(the)g(state)f(of)h(the)g
(\002le)596 3258 y(handle)20 b(will)i(not)f(be)f(r)o(estor)o(ed.)197
3576 y Fh(Uses)596 3717 y Fg(Ther)o(e)25 b(ar)o(e)h(several)f(r)o
(easons)i(that)f(developers)g(will)i(be)e(inter)o(ested)g(in)h
Fi(genstruct)p Fg(.)e(The)i(main)596 3809 y(one)c(is)g(that)g(it)g(is)g
(a)f(very)g(convenient)i(way)f(of)f(storing)i(information)g(between)f
(instances)g(of)f(a)596 3900 y(pr)o(ogram)j(--)h(for)f(example)h(you)h
(could)f(save)g(information)h(about)f(the)g(session)i(that)e(the)g
(user)596 3991 y(had)f(just)i(completed)g(on)g(pr)o(ogram)e(exit)h
(\(for)g(instance)g(the)h(size)f(of)g(the)g(main)h(window)g(and)596
4083 y(the)h(last)g(\002ve)h(documents)g(opened\))f(into)h(a)f(str)o
(uctur)o(e,)g(and)g(then)h(generate)e(a)h(string)h(r)o(epr)o(e-)596
4174 y(sentation)24 b(of)f(this)i(str)o(uctur)o(e)e(to)h(save)f(to)h(a)
f(\002le.)g(On)i(start)e(up,)g(you)h(can)g(r)o(ead)d(the)j(string)g
(back)596 4265 y(into)f(the)f(str)o(uctur)o(e,)g(and)g(go)h(fr)o(om)f
(ther)o(e.)f(This)i(was)g(the)f(original)h(r)o(eason)f(that)g(the)h
(code)f(was)596 4357 y(developed)d(for)i(the)g(Samba)e(pr)o(oject)1803
4323 y Ff(2)596 4489 y Fg(Inter)o(estingly)-9 b(,)29
b Fi(genstruct)f Fg(has)h(other)h(uses.)f(For)h(instance,)f(if)h(you)g
(have)e(a)h(long)i(r)o(un)f(server)596 4581 y(pr)o(ocess)e(such)i(as)f
(Samba,)e(then)j(it)f(is)h(possible)f(that)h(you)f(might)h(want)g(to)f
(change)g(some)h(of)596 4672 y(the)c(internal)h(data)e(str)o(uctur)o
(es)h(whilst)i(the)f(pr)o(ogram)f(is)g(r)o(unning.)i(An)f(example)e(is)
i(when)h(its)596 4763 y(the)h(middle)g(of)g(the)g(night)h(and)f(you)h
(only)g(want)f(to)h(be)f(backing)g(up)g(\002les,)g(then)h(you)g(could)
596 4855 y(save)e(the)g(normal)h(str)o(uctur)o(es)g(to)g(a)f(string,)h
(and)f(then)h(r)o(eload)f(them)h(into)h(a)e(dif)o(fer)o(ent)e(set)j(of)
596 4946 y(str)o(uctur)o(es)j(which)i(is)g(optimized)f(for)g(lar)o(ge)f
(\002le)h(r)o(eads.)f(This)h(would)h(r)o(ely)e(on)i Fi(genstruct)p
Fg('s)596 5037 y(ability)e(to)h(pr)o(ovide)f(default)f(values)h(for)h
(keys)f(which)i(didn't)e(exist)h(when)g(the)g(string)g(was)596
5129 y(cr)o(eated.)21 b(Dr)k(T)-7 b(ridgell)23 b(expr)o(essed)g(this)i
(as)f(a)g(major)g(advantage)f(of)h Fi(genstruct)f Fg(for)h(the)g(Samba)
596 5220 y(team.)p Black 197 5585 a Fd(8)p Black eop
%%Page: 9 9
9 8 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 197 89 a Fh(Genstruct)29 b(pr)n(os)g(and)g(cons)596
231 y Fg(Advantages)19 b(of)i(the)g(Samba)e(solution)k(to)e(this)g(pr)o
(oblem)g(ar)o(e:)p Black 712 446 a(1.)p Black 20 w(Fewer)f(database)f
(accesses)p Black 712 579 a(2.)p Black 20 w(MORE?)596
712 y(However)-6 b(,)20 b(the)h(disadvantages)e(of)i(this)g(solution)i
(ar)o(e:)p Black 712 928 a(1.)p Black 20 w(Requiring)f(pr)o(e)e(pr)o
(ocessing)h(of)f(sour)o(ce)h(code)f(with)i(a)e(perl)g(script)p
Black 712 1061 a(2.)p Black 20 w(The)h(computational)g(ef)o(fort)e
(expended)h(in)h(data)f(serialization)p Black 712 1194
a(3.)p Black 20 w(MORE?)197 1512 y Fh(Code)28 b(listings)596
1764 y Fc(SQL)d(le)o(x)o(er)596 1901 y Fg(The)20 b(lexer)g(for)h(my)g
(SQL)f(implementation)i(is:)596 2066 y Fe(\045{)596 2230
y(#include)43 b("parser.h")596 2395 y(#undef)g(YY_INPUT)596
2477 y(#define)g(YY_INPUT\(b,)g(r,)i(ms\))f(\(r)g(=)h
(trivsql_gettext\(b,)d(ms\)\))596 2559 y(\045})596 2723
y(\045\045)596 2888 y([Ss][Ee][Ll][Ee][Cc][Tt])847 b({)45
b(return)f(SELECT;)f(})596 2970 y([Cc][Rr][Ee][Aa][Tt][Ee])847
b({)45 b(return)f(CREATE;)f(})596 3052 y([Ii][Nn][Ss][Ee][Rr][Tt])847
b({)45 b(return)f(INSERT;)f(})596 3134 y([Vv][Aa][Ll][Uu][Ee][Ss])847
b({)45 b(return)f(VALUES;)f(})596 3217 y([Ii][Nn][Tt][Oo])1207
b({)45 b(return)f(INTO;)g(})596 3299 y([Tt][Aa][Bb][Ll][Ee])1027
b({)45 b(return)f(TABLE;)g(})596 3381 y([Ff][Rr][Oo][Mm])1207
b({)45 b(return)f(FROM;)g(})596 3463 y([Ww][Hh][Ee][Rr][Ee])1027
b({)45 b(return)f(WHERE;)g(})596 3545 y([Ll][Ii][Kk][Ee])1207
b({)45 b(return)f(LIKE;)g(})596 3628 y([Aa][Ll][Tt][Ee][Rr])1027
b({)45 b(return)f(ALTER;)g(})596 3710 y([Aa][Dd][Dd])1387
b({)45 b(return)f(ADD;)g(})596 3792 y([Cc][Oo][Ll][Uu][Mm][Nn])847
b({)45 b(return)f(COLUMN;)f(})596 3874 y([Uu][Pp][Dd][Aa][Tt][Ee])847
b({)45 b(return)f(UPDATE;)f(})596 3956 y([Ss][Ee][Tt])1387
b({)45 b(return)f(SET;)g(})596 4039 y([Aa][Nn][Dd])1387
b({)45 b(return)f(AND;)g(})596 4121 y([Oo][Rr])1567 b({)45
b(return)f(OR;)g(})596 4285 y([a-zA-Z0-9\045\\-]+)1252
b({)45 b(yylval)f(=)g(trivsql_xsnprintf\("\045s",)d(yy-)596
4367 y(text\);)i(return)h(STRING;)g(})596 4449 y([)g(\\t\\r\\n])1523
b({)45 b(})596 4532 y(.)1882 b({)45 b(return)f(yytext[0];)f(})596
4696 y(\045\045)596 4870 y Fd(Code:)20 b(/home/mikal/opensour)o
(ce/trivsql/lexer)-6 b(.l)596 5003 y Fg(I)22 b(am)h(not)g(completely)h
(happy)e(with)i(this)g(implementation.)f(My)g(main)g(objection)h(is)f
(the)g(way)596 5095 y(I)d(have)h(implemented)g(case)f(insensitivity)-9
b(,)22 b(although)f(I)g(am)g(not)g(awar)o(e)e(of)i(a)f(better)g
(method.)p Black 3642 5585 a Fd(9)p Black eop
%%Page: 10 10
10 9 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fc(SQL)25 b(grammar)596 226 y Fg(The)20
b(grammar)g(for)h(my)g(SQL)f(implementation)i(is:)596
391 y Fe(\045{)685 556 y(#include)44 b Fa(<)p Fe(stdio.h)p
Fa(>)685 638 y Fe(#include)g("trivsql.h")685 802 y(#define)g
(YYERROR_VERBOSE)e(1)685 967 y(trivsql_state)h(*gState;)596
1049 y(\045})596 1213 y(\045token)g(CREATE)h(TABLE)596
1295 y(\045token)f(INSERT)h(VALUES)g(INTO)596 1378 y(\045token)f
(SELECT)h(FROM)g(STRING)g(WHERE)g(LIKE)596 1460 y(\045token)f(ALTER)h
(ADD)h(COLUMN)596 1542 y(\045token)e(UPDATE)h(SET)596
1624 y(\045token)f(AND)i(OR)596 1789 y(\045\045)596 1953
y(sql)268 b(:)45 b(create)e(sql)i(|)f(insert)g(sql)h(|)f(sel)h(sql)f(|)
h(alt)f(sql)g(|)h(upd)f(sql)999 2035 y(|)999 2117 y(;)596
2446 y(create)133 b(:)45 b(CREATE)e(TABLE)h(STRING)g('\(')h(colvalspec)
e('\)')h(';')596 2528 y({)g(gState-)p Fa(>)p Fe(rs)f(=)i
(trivsql_makers\(\(char)c(*\))k($3\);)f(trivsql_docreate\(\(char)d(*\))
k($3,)f(\(char)g(*\))g($5\);)h(})999 2610 y(;)596 2775
y(insert)133 b(:)45 b(INSERT)e(INTO)i(STRING)e('\(')i(colvalspec)e
('\)')h(VALUES)g('\(')g(colvalspec)g('\)')g(';')596 2857
y({)g(gState-)p Fa(>)p Fe(rs)f(=)i(trivsql_makers\(\(char)c(*\))k
($3\);)f(trivsql_checktable\(\(char)d(*\))j($3,)h(&gState-)596
2939 y Fa(>)p Fe(rs\);)e(if\(gState-)p Fa(>)p Fe(rs-)p
Fa(>)p Fe(errno)f(==)i(TRIVSQL_FALSE\){trivsql_doinsert\(\(char)39
b(*\))44 b($3,)h(\(char)f(*\))g($5,)g(\(char)g(*\))h($9\);}})999
3021 y(;)596 3186 y(sel)268 b(:)45 b(SELECT)e(cvsaster)h(FROM)g(STRING)
g({)h(gState-)p Fa(>)p Fe(rs)e(=)h(trivsql_makers\(\(char)e(*\))i
($4\);)g(trivsql_xfree\(gState-)596 3268 y Fa(>)p Fe(table\);)f
(gState-)p Fa(>)p Fe(table)f(=)j(trivsql_xsnprintf\("\045s",)c($4\);)j
(})h(wsel)f(';')596 3350 y({)g(trivsql_checktable\(\(char)d(*\))j($4,)h
(&gState-)p Fa(>)p Fe(rs\);)d(if\(gState-)p Fa(>)p Fe(rs-)p
Fa(>)p Fe(errno)g(==)i(TRIVSQL_FALSE\){trivsql_doselect\(\(char)39
b(*\))44 b($4,)h(\(char)f(*\))g($2\);}})999 3432 y(;)596
3597 y(alt)268 b(:)45 b(ALTER)f(STRING)f(ADD)i(COLUMN)f(STRING)f(';')
596 3679 y({)h(gState-)p Fa(>)p Fe(rs)f(=)i(trivsql_makers\(\(char)c
(*\))k($2\);)f(trivsql_checktable\(\(char)d(*\))j($2,)h(&gState-)596
3761 y Fa(>)p Fe(rs\);)e(if\(gState-)p Fa(>)p Fe(rs-)p
Fa(>)p Fe(errno)f(==)i(TRIVSQL_FALSE\){trivsql_doalter\(\(char)39
b(*\))44 b($2,)h(\(char)f(*\))g($5\);}})999 3843 y(;)596
4008 y(upd)268 b(:)45 b(UPDATE)e(STRING)h(SET)h(STRING)e('=')i(str)f({)
h(gState-)p Fa(>)p Fe(rs)e(=)h(trivsql_makers\(\(char)e(*\))i($2\);)h
(trivsql_xfree\(gState-)596 4090 y Fa(>)p Fe(table\);)e(gState-)p
Fa(>)p Fe(table)f(=)j(trivsql_xsnprintf\("\045s",)c($2\);)j(})h(wsel)f
(';')596 4172 y({trivsql_checktable\(\(char)c(*\))45
b($2,)f(&gState-)p Fa(>)p Fe(rs\);)f(if\(gState-)p Fa(>)p
Fe(rs-)p Fa(>)p Fe(errno)e(==)j
(TRIVSQL_FALSE\){trivsql_doselect\(\(char)39 b(*\))44
b($2,)h(\(char)f(*\))g($4\);)g(trivsql_updaters\(gState,)d(gState-)596
4254 y Fa(>)p Fe(rs,)j(\(char)g(*\))g($4,)g(\(char)g(*\))h($6\);}})999
4336 y(;)596 4665 y(cvsaster)e(:)i(colvalspec)e({)h($$)h(=)g
(trivsql_xsnprintf\("\045s",)c(\(char)j(*\))g($1\);)g(})999
4747 y(|)h('*')f({)h($$)f(=)h(trivsql_xsnprintf\("*"\);)c(})999
4830 y(;)596 4994 y(colvalspec)i(:)h(str)h(',')f(colvalspec)f({)i($$)f
(=)h(trivsql_xsnprintf\("\045s;\045s",)40 b(\(char)k(*\))h($1,)f
(\(char)g(*\))h($3\);)f(})999 5076 y(|)h(str)f({)h($$)f(=)h
(trivsql_xsnprintf\("\045s",)c(\(char)j(*\))g($1\);)g(})999
5158 y(;)596 5323 y(wsel)223 b(:)45 b(WHERE)f(selector)f({)i(gState-)p
Fa(>)p Fe(seltree)d(=)j($2;)f(})999 5405 y(|)p Black
197 5585 a Fd(10)p Black eop
%%Page: 11 11
11 10 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 999 89 a Fe(;)596 253 y(selector)43 b(:)i(str)f('=')g(str)h({)f
($$)h(=)f(trivsql_makesel\(trivsql_selequal,)c($1,)k($3\);)g(})999
336 y(|)h(str)f(LIKE)g(str)g({)h($$)g(=)f
(trivsql_makesel\(trivsql_sellike,)c($1,)k($3\);)g(})999
418 y(|)h(selector)e(AND)h(selector)g({)h($$)f(=)h
(trivsql_makeslr\(trivsql_seland,)39 b($1,)45 b($3\);)f(})999
500 y(|)h(selector)e(OR)i(selector)e({)i($$)f(=)h
(trivsql_makeslr\(trivsql_seland,)40 b($1,)k($3\);)g(})999
582 y(|)h('\(')f(selector)f('\)')i({)f($$)h(=)g($2;)f(})685
664 y(|)h({)g($$)f(=)h(NULL)f(})999 747 y(;)596 911 y(str)268
b(:)45 b(STRING)e({)i($$)g(=)f($1)h(})999 993 y(|)g('\\\224)f(STRING)g
('\\\224)g({)h($$)f(=)h($2)f(})999 1075 y(;)596 1240
y(\045\045)596 1404 y(int)g(yyerror\(char)f(*s\){)685
1486 y(printf\("\\nsql)g(parsing)g(error:)h(\045s\\n",)g(s\);)685
1569 y(exit\(42\);)596 1651 y(})596 1825 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/parser)-6 b(.y)596
2133 y Fc(C)25 b(sour)n(ce)f(code)596 2270 y Fg(The)c(following)j
(\002les)e(implement)g Fi(trivsql)f Fg(and)g Fi(tdb)p
Fg(...)596 2435 y Fe(dnl)44 b(aclocal.m4)f(generated)g(automatically)g
(by)h(aclocal)g(1.4)596 2600 y(dnl)g(Copyright)f(\(C\))h(1994,)g
(1995-8,)g(1999)g(Free)g(Software)g(Foundation,)f(Inc.)596
2682 y(dnl)h(This)g(file)g(is)h(free)f(software;)f(the)h(Free)h
(Software)e(Foundation)596 2764 y(dnl)h(gives)g(unlimited)f(permission)
g(to)i(copy)f(and/or)g(distribute)f(it,)596 2846 y(dnl)h(with)g(or)g
(without)g(modifications,)f(as)h(long)g(as)h(this)f(notice)g(is)g
(preserved.)596 3011 y(dnl)g(This)g(program)g(is)g(distributed)f(in)i
(the)f(hope)g(that)g(it)h(will)f(be)g(useful,)596 3093
y(dnl)g(but)g(WITHOUT)g(ANY)g(WARRANTY,)f(to)i(the)f(extent)g
(permitted)f(by)i(law;)f(without)596 3175 y(dnl)g(even)g(the)g(implied)
g(warranty)f(of)i(MERCHANTABILITY)d(or)j(FITNESS)e(FOR)i(A)596
3257 y(dnl)f(PARTICULAR)f(PURPOSE.)596 3422 y(#)h(Do)h(all)f(the)g
(work)g(for)h(Automake.)88 b(This)44 b(macro)g(actually)g(does)g(too)g
(much)g(--)596 3586 y(#)g(some)g(checks)g(are)g(only)h(needed)e(if)i
(your)f(package)g(does)g(certain)g(things.)596 3668 y(#)g(But)h(this)f
(isn't)g(really)f(a)i(big)f(deal.)596 3833 y(#)g(serial)g(1)596
3997 y(dnl)g(Usage:)596 4079 y(dnl)g
(AM_INIT_AUTOMAKE\(package,version,)39 b([no-define]\))596
4244 y(AC_DEFUN\(AM_INIT_AUTOMAKE,)596 4326 y
([AC_REQUIRE\([AC_PROG_INSTALL]\))596 4408 y(PACKAGE=[$1])596
4490 y(AC_SUBST\(PACKAGE\))596 4572 y(VERSION=[$2])596
4654 y(AC_SUBST\(VERSION\))596 4737 y(dnl)44 b(test)g(to)g(see)h(if)f
(srcdir)g(already)g(configured)596 4819 y(if)g(test)g("`cd)g($srcdir)g
(&&)g(pwd`")g(!=)h("`pwd`")f(&&)g(test)g(-f)h($srcdir/config.status;)c
(then)685 4901 y(AC_MSG_ERROR\([source)h(directory)h(already)h
(configured;)f(run)h("make)g(distclean")f(there)h(first]\))596
4983 y(fi)596 5065 y(ifelse\([$3]\204)596 5148 y
(AC_DEFINE_UNQUOTED\(PACKAGE,)c("$PACKAGE",)j([Name)h(of)g(package]\))
596 5230 y(AC_DEFINE_UNQUOTED\(VERSION,)c("$VERSION",)j([Version)g
(number)h(of)h(package]\)\))596 5312 y(AC_REQUIRE\([AM_SANITY_CHECK]\))
596 5394 y(AC_REQUIRE\([AC_ARG_PROGRAM]\))596 5476 y(dnl)f(FIXME)g
(This)g(is)g(truly)g(gross.)p Black 3601 5585 a Fd(11)p
Black eop
%%Page: 12 12
12 11 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(missing_dir=`cd)42 b($ac_aux_dir)h(&&)h(pwd`)596
171 y(AM_MISSING_PROG\(ACLOCAL,)c(aclocal,)k($missing_dir\))596
253 y(AM_MISSING_PROG\(AUTOCONF,)c(autoconf,)j($missing_dir\))596
336 y(AM_MISSING_PROG\(AUTOMAKE,)d(automake,)j($missing_dir\))596
418 y(AM_MISSING_PROG\(AUTOHEADER,)d(autoheader,)j($missing_dir\))596
500 y(AM_MISSING_PROG\(MAKEINFO,)d(makeinfo,)j($missing_dir\))596
582 y(AC_REQUIRE\([AC_PROG_MAKE_SET]\)]\))596 747 y(#)596
829 y(#)h(Check)g(to)h(make)f(sure)g(that)g(the)g(build)g(environment)f
(is)i(sane.)596 911 y(#)596 1075 y(AC_DEFUN\(AM_SANITY_CHECK,)596
1158 y([AC_MSG_CHECKING\([whether)40 b(build)k(environment)f(is)i
(sane]\))596 1240 y(#)f(Just)g(in)h(case)596 1322 y(sleep)f(1)596
1404 y(echo)g(timestamp)f Fa(>)i Fe(conftestfile)596
1486 y(#)f(Do)h(`set')f(in)g(a)h(subshell)e(so)i(we)f(don't)g(clobber)g
(the)g(current)g(shell's)596 1569 y(#)g(arguments.)88
b(Must)44 b(try)h(-L)f(first)g(in)h(case)f(configure)f(is)i(actually)e
(a)596 1651 y(#)h(symlink;)g(some)g(systems)f(play)i(weird)f(games)g
(with)g(the)g(mod)g(time)h(of)f(symlinks)596 1733 y(#)g(\(eg)h(FreeBSD)
e(returns)h(the)g(mod)g(time)h(of)f(the)g(symlink's)g(containing)596
1815 y(#)g(directory\).)596 1897 y(if)g(\()730 1979 y(set)g(X)h(`ls)f
(-Lt)h($srcdir/configure)d(conftestfile)g(2)p Fa(>)j
Fe(/dev/null`)730 2062 y(if)g(test)f("[$]*")f(=)i("X";)f(then)865
2144 y(#)g(-L)h(didn't)e(work.)865 2226 y(set)h(X)g(`ls)h(-t)f
($srcdir/configure)e(conftestfile`)730 2308 y(fi)730
2390 y(if)j(test)f("[$]*")f(!=)i("X)f($srcdir/configure)e
(conftestfile")h(\\)865 2473 y(&&)h(test)g("[$]*")g(!=)g("X)h
(conftestfile)e($srcdir/configure";)e(then)865 2637 y(#)j(If)h(neither)
e(matched,)h(then)g(we)g(have)h(a)f(broken)g(ls.)89 b(This)44
b(can)h(happen)865 2719 y(#)f(if,)g(for)h(instance,)e(CONFIG_SHELL)g
(is)h(bash)h(and)f(it)g(inherits)g(a)865 2801 y(#)g(broken)g(ls)g
(alias)g(from)h(the)f(environment.)88 b(This)44 b(has)g(actually)865
2884 y(#)g(happened.)88 b(Such)44 b(a)h(system)f(could)g(not)g(be)h
(considered)e("sane".)865 2966 y(AC_MSG_ERROR\([ls)f(-t)i(appears)g(to)
g(fail.)89 b(Make)44 b(sure)g(there)g(is)h(not)f(a)h(broken)596
3048 y(alias)f(in)g(your)g(environment]\))730 3130 y(fi)730
3295 y(test)g("[$]2")g(=)h(conftestfile)730 3377 y(\))596
3459 y(then)730 3541 y(#)g(Ok.)730 3623 y(:)596 3706
y(else)730 3788 y(AC_MSG_ERROR\([newly)d(created)h(file)h(is)h(older)f
(than)g(distributed)f(files!)596 3870 y(Check)h(your)g(system)f
(clock]\))596 3952 y(fi)596 4034 y(rm)h(-f)h(conftest*)596
4116 y(AC_MSG_RESULT\(yes\)]\))596 4281 y(dnl)f(AM_MISSING_PROG\(NAME,)
d(PROGRAM,)j(DIRECTORY\))596 4363 y(dnl)g(The)g(program)g(must)g
(properly)f(implement)h(--version.)596 4445 y
(AC_DEFUN\(AM_MISSING_PROG,)596 4527 y([AC_MSG_CHECKING\(for)d(working)
j($2\))596 4610 y(#)g(Run)h(test)f(in)g(a)h(subshell;)e(some)h
(versions)g(of)g(sh)h(will)f(print)g(an)g(error)g(if)596
4692 y(#)g(an)h(executable)e(is)h(not)h(found,)e(even)i(if)f(stderr)g
(is)g(redirected.)596 4774 y(#)g(Redirect)g(stdin)g(to)g(placate)g
(older)g(versions)f(of)i(autoconf.)88 b(Sigh.)596 4856
y(if)44 b(\($2)g(--version\))f Fa(<)i Fe(/dev/null)e
Fa(>)i Fe(/dev/null)e(2)p Fa(>)p Fe(&1;)h(then)730 4938
y($1=$2)730 5021 y(AC_MSG_RESULT\(found\))596 5103 y(else)730
5185 y($1="$3/missing)e($2")730 5267 y(AC_MSG_RESULT\(missing\))596
5349 y(fi)596 5432 y(AC_SUBST\($1\)]\))p Black 197 5585
a Fd(12)p Black eop
%%Page: 13 13
13 12 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(#)44 b(Add)h(--enable-maintainer-mode)40
b(option)k(to)h(configure.)596 253 y(#)f(From)g(Jim)h(Meyering)596
418 y(#)f(serial)g(1)596 582 y(AC_DEFUN\(AM_MAINTAINER_MODE,)596
664 y([AC_MSG_CHECKING\([whether)c(to)45 b(enable)e
(maintainer-specific)f(portions)i(of)g(Makefiles]\))685
747 y(dnl)h(maintainer-mode)d(is)i(disabled)g(by)g(default)685
829 y(AC_ARG_ENABLE\(maintainer-mode,)596 911 y([)89
b(--enable-maintainer-mode)41 b(enable)j(make)g(rules)g(and)g
(dependencies)f(not)h(useful)1761 993 y(\(and)g(sometimes)g
(confusing\))f(to)h(the)h(casual)e(installer],)865 1075
y(USE_MAINTAINER_MODE=$enableval,)865 1158 y(USE_MAINTAINER_MODE=no\))
685 1240 y(AC_MSG_RESULT\($USE_MAINTAINER_MODE\))685
1322 y(AM_CONDITIONAL\(MAINTAINER_MODE,)d(test)k($USE_MAINTAINER_MODE)d
(=)k(yes\))685 1404 y(MAINT=$MAINTAINER_MODE_TRUE)685
1486 y(AC_SUBST\(MAINT\)dnl)596 1569 y(])596 1651 y(\))596
1815 y(#)f(Define)g(a)h(conditional.)596 1979 y
(AC_DEFUN\(AM_CONDITIONAL,)596 2062 y([AC_SUBST\($1_TRUE\))596
2144 y(AC_SUBST\($1_FALSE\))596 2226 y(if)f($2;)g(then)685
2308 y($1_TRUE=)685 2390 y($1_FALSE='#')596 2473 y(else)685
2555 y($1_TRUE='#')685 2637 y($1_FALSE=)596 2719 y(fi]\))596
2966 y(#)g(serial)g(40)g(AC_PROG_LIBTOOL)596 3048 y
(AC_DEFUN\(AC_PROG_LIBTOOL,)596 3130 y
([AC_REQUIRE\([AC_LIBTOOL_SETUP]\)dnl)596 3295 y(#)g(Save)g(cache,)g
(so)h(that)f(ltconfig)f(can)i(load)f(it)596 3377 y(AC_CACHE_SAVE)596
3541 y(#)g(Actually)g(configure)f(libtool.)88 b(ac_aux_dir)43
b(is)i(where)f(install-sh)f(is)i(found.)596 3623 y(CC="$CC")e
(CFLAGS="$CFLAGS")f(CPPFLAGS="$CPPFLAGS")g(\\)596 3706
y(LD="$LD")h(LDFLAGS="$LDFLAGS")f(LIBS="$LIBS")h(\\)596
3788 y(LN_S="$LN_S")f(NM="$NM")i(RANLIB="$RANLIB")e(\\)596
3870 y(DLLTOOL="$DLLTOOL")f(AS="$AS")j(OBJDUMP="$OBJDUMP")e(\\)596
3952 y(${CONFIG_SHELL-/bin/sh})e($ac_aux_dir/ltconfig)i(--no-reexec)h
(\\)596 4034 y($libtool_flags)f(--no-verify)h($ac_aux_dir/ltmain.sh)e
($host)j(\\)596 4116 y(||)g(AC_MSG_ERROR\([libtool)d(configure)j
(failed]\))596 4281 y(#)g(Reload)g(cache,)g(that)g(may)g(have)g(been)h
(modified)e(by)i(ltconfig)596 4363 y(AC_CACHE_LOAD)596
4527 y(#)f(This)g(can)h(be)f(used)g(to)h(rebuild)e(libtool)h(when)g
(needed)596 4610 y(LIBTOOL_DEPS="$ac_aux_dir/ltconfig)39
b($ac_aux_dir/ltmain.sh")596 4774 y(#)44 b(Always)g(use)g(our)h(own)f
(libtool.)596 4856 y(LIBTOOL='$\(SHELL\))d($\(top_builddir\)/libtool')
596 4938 y(AC_SUBST\(LIBTOOL\)dnl)596 5103 y(#)j(Redirect)g(the)g
(config.log)f(output)h(again,)g(so)g(that)g(the)h(ltconfig)e(log)i(is)f
(not)596 5185 y(#)g(clobbered)f(by)i(the)f(next)g(message.)596
5267 y(exec)g(5)p Fa(>>)p Fe(./config.log)596 5349 y(]\))p
Black 3601 5585 a Fd(13)p Black eop
%%Page: 14 14
14 13 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(AC_DEFUN\(AC_LIBTOOL_SETUP,)596 171
y([AC_PREREQ\(2.13\)dnl)596 253 y(AC_REQUIRE\([AC_ENABLE_SHARED]\)dnl)
596 336 y(AC_REQUIRE\([AC_ENABLE_STATIC]\)dnl)596 418
y(AC_REQUIRE\([AC_ENABLE_FAST_INSTALL]\))o(dnl)596 500
y(AC_REQUIRE\([AC_CANONICAL_HOST]\)dnl)596 582 y
(AC_REQUIRE\([AC_CANONICAL_BUILD]\)dnl)596 664 y
(AC_REQUIRE\([AC_PROG_RANLIB]\)dnl)596 747 y
(AC_REQUIRE\([AC_PROG_CC]\)dnl)596 829 y(AC_REQUIRE\([AC_PROG_LD]\)dnl)
596 911 y(AC_REQUIRE\([AC_PROG_NM]\)dnl)596 993 y
(AC_REQUIRE\([AC_PROG_LN_S]\)dnl)596 1075 y(dnl)596 1240
y(#)44 b(Check)g(for)g(any)h(special)e(flags)h(to)h(pass)f(to)h
(ltconfig.)596 1322 y(libtool_flags="--cache-file=$cache_f)o(ile")596
1404 y(test)f("$enable_shared")e(=)i(no)h(&&)f
(libtool_flags="$libtool_flags)c(--disable-)596 1486
y(shared")596 1569 y(test)k("$enable_static")e(=)i(no)h(&&)f
(libtool_flags="$libtool_flags)c(--disable-)596 1651
y(static")596 1733 y(test)k("$enable_fast_install")d(=)j(no)h(&&)f
(libtool_flags="$libtool_flags)c(--disable-)596 1815
y(fast-install")596 1897 y(test)k("$ac_cv_prog_gcc")e(=)i(yes)h(&&)f
(libtool_flags="$libtool_flags)c(--with-)596 1979 y(gcc")596
2062 y(test)k("$ac_cv_prog_gnu_ld")d(=)k(yes)f(&&)h
(libtool_flags="$libtool_flags)40 b(--with-)596 2144
y(gnu-ld")596 2226 y(ifdef\([AC_PROVIDE_AC_LIBTOOL_DLOPEN])o(,)596
2308 y([libtool_flags="$libtool_flags)f(--enable-dlopen"]\))596
2390 y(ifdef\([AC_PROVIDE_AC_LIBTOOL_WIN32_D)o(LL],)596
2473 y([libtool_flags="$libtool_flags)g(--enable-win32-dll"]\))596
2555 y(AC_ARG_ENABLE\(libtool-lock,)685 2637 y([)90 b
(--disable-libtool-lock)c(avoid)44 b(locking)f(\(might)h(break)g
(parallel)g(builds\)]\))596 2719 y(test)g("x$enable_libtool_lock")d(=)j
(xno)h(&&)f(libtool_flags="$libtool_flags)c(-)596 2801
y(-disable-lock")596 2884 y(test)k(x"$silent")f(=)h(xyes)h(&&)f
(libtool_flags="$libtool_flags)c(--silent")596 3048 y(#)k(Some)g(flags)
g(need)g(to)h(be)f(propagated)g(to)g(the)g(compiler)g(or)g(linker)g
(for)h(good)596 3130 y(#)f(libtool)g(support.)596 3212
y(case)g("$host")f(in)596 3295 y(*-*-irix6*\))685 3377
y(#)i(Find)f(out)g(which)g(ABI)h(we)f(are)g(using.)685
3459 y(echo)g('[#]line)g(__oline__)f("configure"')g Fa(>)i
Fe(conftest.$ac_ext)685 3541 y(if)g(AC_TRY_EVAL\(ac_compile\);)40
b(then)775 3623 y(case)k("`/usr/bin/file)e(conftest.o`")h(in)775
3706 y(*32-bit*\))865 3788 y(LD="${LD-ld})f(-32")865
3870 y(;;)775 3952 y(*N32*\))865 4034 y(LD="${LD-ld})g(-n32")865
4116 y(;;)775 4199 y(*64-bit*\))865 4281 y(LD="${LD-ld})g(-64")865
4363 y(;;)775 4445 y(esac)685 4527 y(fi)685 4610 y(rm)j(-rf)f
(conftest*)685 4692 y(;;)596 4856 y(*-*-sco3.2v5*\))685
4938 y(#)h(On)f(SCO)h(OpenServer)e(5,)h(we)h(need)f(-belf)g(to)g(get)h
(full-featured)d(binaries.)685 5021 y(SAVE_CFLAGS="$CFLAGS")685
5103 y(CFLAGS="$CFLAGS)g(-belf")685 5185 y(AC_CACHE_CHECK\([whether)f
(the)j(C)h(compiler)f(needs)g(-belf],)f(lt_cv_cc_needs_belf,)775
5267 y([AC_LANG_SAVE)820 5349 y(AC_LANG_C)820 5432 y
(AC_TRY_LINK\([],[],[lt_cv_cc_needs_bel)o(f=yes])o(,[lt_c)o(v_cc_n)o
(eeds_b)o(elf=no)o(]\))p Black 197 5585 a Fd(14)p Black
eop
%%Page: 15 15
15 14 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 820 89 a Fe(AC_LANG_RESTORE]\))685 171 y(if)45
b(test)f(x"$lt_cv_cc_needs_belf")d(!=)j(x"yes";)g(then)775
253 y(#)h(this)f(is)g(probably)g(gcc)g(2.8.0,)g(egcs)g(1.0)g(or)h
(newer;)f(no)g(need)g(for)h(-belf)775 336 y(CFLAGS="$SAVE_CFLAGS")685
418 y(fi)685 500 y(;;)596 664 y(ifdef\([AC_PROVIDE_AC_LIBTOOL_WIN32_D)o
(LL],)596 747 y([*-*-cygwin*)d(|)j(*-*-mingw*\))685 829
y(AC_CHECK_TOOL\(DLLTOOL,)c(dlltool,)j(false\))685 911
y(AC_CHECK_TOOL\(AS,)e(as,)i(false\))685 993 y(AC_CHECK_TOOL\(OBJDUMP,)
d(objdump,)j(false\))685 1075 y(;;)596 1158 y(]\))596
1240 y(esac)596 1322 y(]\))596 1486 y(#)g(AC_LIBTOOL_DLOPEN)e(-)j
(enable)f(checks)f(for)i(dlopen)f(support)596 1569 y
(AC_DEFUN\(AC_LIBTOOL_DLOPEN,)c
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)]\))596 1733 y(#)k
(AC_LIBTOOL_WIN32_DLL)e(-)i(declare)g(package)g(support)f(for)i
(building)e(win32)h(dll's)596 1815 y(AC_DEFUN\(AC_LIBTOOL_WIN32_DLL,)39
b([AC_BEFORE\([$0],)j([AC_LIBTOOL_SETUP]\)]\))596 1979
y(#)i(AC_ENABLE_SHARED)e(-)j(implement)e(the)i(--enable-shared)d(flag)
596 2062 y(#)i(Usage:)g(AC_ENABLE_SHARED[\(DEFAULT\)])596
2144 y(#)134 b(Where)44 b(DEFAULT)f(is)i(either)f(`yes')g(or)g(`no'.)89
b(If)45 b(omitted,)e(it)i(defaults)e(to)596 2226 y(#)134
b(`yes'.)596 2308 y(AC_DEFUN\(AC_ENABLE_SHARED,)40 b([dnl)596
2390 y(define\([AC_ENABLE_SHARED_DEFAULT],)f(ifelse\($1,)k(no,)h(no,)g
(yes\)\)dnl)596 2473 y(AC_ARG_ENABLE\(shared,)596 2555
y(changequote\()p Fa(<<)p Fe(,)e Fa(>>)p Fe(\)dnl)596
2637 y Fa(<<)89 b Fe(--enable-shared[=PKGS])d(build)44
b(shared)f(libraries)h([default=)p Fa(>>)p Fe
(AC_ENABLE_SHARED_DEFAULT])o(,)596 2719 y(changequote\([,)e(]\)dnl)596
2801 y([p=${PACKAGE-default})596 2884 y(case)i("$enableval")e(in)596
2966 y(yes\))i(enable_shared=yes)e(;;)596 3048 y(no\))i
(enable_shared=no)e(;;)596 3130 y(*\))685 3212 y(enable_shared=no)685
3295 y(#)j(Look)f(at)g(the)h(argument)e(we)i(got.)89
b(We)44 b(use)h(all)f(the)g(common)g(list)g(separators.)685
3377 y(IFS="${IFS=)88 b(}";)44 b(ac_save_ifs="$IFS";)e(IFS="${IFS}:,")
685 3459 y(for)j(pkg)f(in)g($enableval;)f(do)775 3541
y(if)h(test)g("X$pkg")g(=)h("X$p";)f(then)865 3623 y(enable_shared=yes)
775 3706 y(fi)685 3788 y(done)685 3870 y(IFS="$ac_save_ifs")685
3952 y(;;)596 4034 y(esac],)596 4116 y
(enable_shared=AC_ENABLE_SHARED_DEFAU)o(LT\)dnl)596 4199
y(]\))596 4363 y(#)g(AC_DISABLE_SHARED)e(-)j(set)f(the)g(default)g
(shared)g(flag)g(to)h(--disable-shared)596 4445 y
(AC_DEFUN\(AC_DISABLE_SHARED,)40 b
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)dnl)596 4527 y
(AC_ENABLE_SHARED\(no\)]\))596 4692 y(#)k(AC_ENABLE_STATIC)e(-)j
(implement)e(the)i(--enable-static)d(flag)596 4774 y(#)i(Usage:)g
(AC_ENABLE_STATIC[\(DEFAULT\)])596 4856 y(#)134 b(Where)44
b(DEFAULT)f(is)i(either)f(`yes')g(or)g(`no'.)89 b(If)45
b(omitted,)e(it)i(defaults)e(to)596 4938 y(#)134 b(`yes'.)596
5021 y(AC_DEFUN\(AC_ENABLE_STATIC,)40 b([dnl)596 5103
y(define\([AC_ENABLE_STATIC_DEFAULT],)f(ifelse\($1,)k(no,)h(no,)g
(yes\)\)dnl)596 5185 y(AC_ARG_ENABLE\(static,)596 5267
y(changequote\()p Fa(<<)p Fe(,)e Fa(>>)p Fe(\)dnl)596
5349 y Fa(<<)89 b Fe(--enable-static[=PKGS])d(build)44
b(static)f(libraries)h([default=)p Fa(>>)p Fe
(AC_ENABLE_STATIC_DEFAULT])o(,)596 5432 y(changequote\([,)e(]\)dnl)p
Black 3601 5585 a Fd(15)p Black eop
%%Page: 16 16
16 15 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe([p=${PACKAGE-default})596 171 y(case)44
b("$enableval")e(in)596 253 y(yes\))i(enable_static=yes)e(;;)596
336 y(no\))i(enable_static=no)e(;;)596 418 y(*\))685
500 y(enable_static=no)685 582 y(#)j(Look)f(at)g(the)h(argument)e(we)i
(got.)89 b(We)44 b(use)h(all)f(the)g(common)g(list)g(separators.)685
664 y(IFS="${IFS=)88 b(}";)44 b(ac_save_ifs="$IFS";)e(IFS="${IFS}:,")
685 747 y(for)j(pkg)f(in)g($enableval;)f(do)775 829 y(if)h(test)g
("X$pkg")g(=)h("X$p";)f(then)865 911 y(enable_static=yes)775
993 y(fi)685 1075 y(done)685 1158 y(IFS="$ac_save_ifs")685
1240 y(;;)596 1322 y(esac],)596 1404 y
(enable_static=AC_ENABLE_STATIC_DEFAU)o(LT\)dnl)596 1486
y(]\))596 1651 y(#)g(AC_DISABLE_STATIC)e(-)j(set)f(the)g(default)g
(static)g(flag)g(to)h(--disable-static)596 1733 y
(AC_DEFUN\(AC_DISABLE_STATIC,)40 b
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)dnl)596 1815 y
(AC_ENABLE_STATIC\(no\)]\))596 2062 y(#)k(AC_ENABLE_FAST_INSTALL)d(-)k
(implement)e(the)i(--enable-fast-install)c(flag)596 2144
y(#)j(Usage:)g(AC_ENABLE_FAST_INSTALL[\(DEFAULT\)])596
2226 y(#)134 b(Where)44 b(DEFAULT)f(is)i(either)f(`yes')g(or)g(`no'.)89
b(If)45 b(omitted,)e(it)i(defaults)e(to)596 2308 y(#)134
b(`yes'.)596 2390 y(AC_DEFUN\(AC_ENABLE_FAST_INSTALL,)39
b([dnl)596 2473 y(define\([AC_ENABLE_FAST_INSTALL_DEFAU)o(LT],)g
(ifelse\($1,)k(no,)h(no,)g(yes\)\)dnl)596 2555 y
(AC_ARG_ENABLE\(fast-install,)596 2637 y(changequote\()p
Fa(<<)p Fe(,)e Fa(>>)p Fe(\)dnl)596 2719 y Fa(<<)89 b
Fe(--enable-fast-install[=PKGS])c(optimize)43 b(for)h(fast)h
(installation)d([default=)p Fa(>>)p Fe(AC_ENABLE_FAST_INSTALL_DEFAUL)o
(T],)596 2801 y(changequote\([,)g(]\)dnl)596 2884 y
([p=${PACKAGE-default})596 2966 y(case)i("$enableval")e(in)596
3048 y(yes\))i(enable_fast_install=yes)d(;;)596 3130
y(no\))j(enable_fast_install=no)d(;;)596 3212 y(*\))685
3295 y(enable_fast_install=no)685 3377 y(#)k(Look)f(at)g(the)h
(argument)e(we)i(got.)89 b(We)44 b(use)h(all)f(the)g(common)g(list)g
(separators.)685 3459 y(IFS="${IFS=)88 b(}";)44 b(ac_save_ifs="$IFS";)e
(IFS="${IFS}:,")685 3541 y(for)j(pkg)f(in)g($enableval;)f(do)775
3623 y(if)h(test)g("X$pkg")g(=)h("X$p";)f(then)865 3706
y(enable_fast_install=yes)775 3788 y(fi)685 3870 y(done)685
3952 y(IFS="$ac_save_ifs")685 4034 y(;;)596 4116 y(esac],)596
4199 y(enable_fast_install=AC_ENABLE_FAST_I)o(NSTALL)o(_DEFAU)o
(LT\)dnl)596 4281 y(]\))596 4445 y(#)g(AC_ENABLE_FAST_INSTALL)d(-)k
(set)f(the)h(default)e(to)i(--disable-fast-install)596
4527 y(AC_DEFUN\(AC_DISABLE_FAST_INSTALL,)39 b
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)dnl)596 4610 y
(AC_ENABLE_FAST_INSTALL\(no\)]\))596 4774 y(#)44 b(AC_PROG_LD)f(-)i
(find)f(the)g(path)h(to)f(the)g(GNU)h(or)f(non-GNU)g(linker)596
4856 y(AC_DEFUN\(AC_PROG_LD,)596 4938 y([AC_ARG_WITH\(gnu-ld,)596
5021 y([)89 b(--with-gnu-ld)491 b(assume)44 b(the)g(C)h(compiler)e
(uses)h(GNU)h(ld)f([default=no]],)596 5103 y(test)g("$withval")f(=)h
(no)h(||)f(with_gnu_ld=yes,)f(with_gnu_ld=no\))596 5185
y(AC_REQUIRE\([AC_PROG_CC]\)dnl)596 5267 y
(AC_REQUIRE\([AC_CANONICAL_HOST]\)dnl)596 5349 y
(AC_REQUIRE\([AC_CANONICAL_BUILD]\)dnl)596 5432 y(ac_prog=ld)p
Black 197 5585 a Fd(16)p Black eop
%%Page: 17 17
17 16 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(if)44 b(test)g("$ac_cv_prog_gcc")e(=)j(yes;)f(then)
685 171 y(#)h(Check)f(if)g(gcc)h(-print-prog-name=ld)c(gives)j(a)h
(path.)685 253 y(AC_MSG_CHECKING\([for)d(ld)i(used)g(by)h(GCC]\))685
336 y(ac_prog=`\($CC)e(-print-prog-name=ld\))e(2)p Fa(>)p
Fe(&5`)685 418 y(case)j("$ac_prog")f(in)775 500 y(#)i(Accept)e
(absolute)h(paths.)596 582 y(changequote\(,\)dnl)775
664 y([\\\\/]*)g(|)g([A-Za-z]:[\\\\/]*\))865 747 y
(re_direlt='/[^/][^/]*/\\.\\./')596 829 y(changequote\([,]\)dnl)865
911 y(#)g(Canonicalize)f(the)h(path)g(of)h(ld)865 993
y(ac_prog=`echo)d($ac_prog|)h(sed)i('s\045\\\\\\\\\045/\045g'`)865
1075 y(while)e(echo)i($ac_prog)e(|)i(grep)f("$re_direlt")f
Fa(>)h Fe(/dev/null)g(2)p Fa(>)p Fe(&1;)g(do)640 1158
y(ac_prog=`echo)f($ac_prog|)g(sed)i("s\045$re_direlt\045/\045"`)865
1240 y(done)865 1322 y(test)f(-z)g("$LD")g(&&)h(LD="$ac_prog")865
1404 y(;;)685 1486 y(""\))775 1569 y(#)g(If)f(it)g(fails,)g(then)g
(pretend)g(we)h(aren't)e(using)h(GCC.)775 1651 y(ac_prog=ld)775
1733 y(;;)685 1815 y(*\))775 1897 y(#)h(If)f(it)g(is)h(relative,)e
(then)h(search)g(for)h(the)f(first)g(ld)g(in)h(PATH.)775
1979 y(with_gnu_ld=unknown)775 2062 y(;;)685 2144 y(esac)596
2226 y(elif)f(test)g("$with_gnu_ld")e(=)j(yes;)f(then)685
2308 y(AC_MSG_CHECKING\([for)e(GNU)i(ld]\))596 2390 y(else)685
2473 y(AC_MSG_CHECKING\([for)e(non-GNU)h(ld]\))596 2555
y(fi)596 2637 y(AC_CACHE_VAL\(ac_cv_path_LD,)596 2719
y([if)h(test)g(-z)g("$LD";)g(then)685 2801 y(IFS="${IFS=)88
b(}";)44 b(ac_save_ifs="$IFS";)e(IFS="${IFS}${PATH_SEPARATOR-:}")685
2884 y(for)j(ac_dir)e(in)i($PATH;)f(do)775 2966 y(test)g(-z)g
("$ac_dir")g(&&)g(ac_dir=.)775 3048 y(if)g(test)g(-f)h
("$ac_dir/$ac_prog")d(||)i(test)g(-f)h("$ac_dir/$ac_prog$ac_exeext";)40
b(then)865 3130 y(ac_cv_path_LD="$ac_dir/$ac_prog")865
3212 y(#)k(Check)g(to)h(see)f(if)g(the)h(program)e(is)i(GNU)f(ld.)89
b(I'd)45 b(rather)f(use)g(--version,)865 3295 y(#)g(but)g(apparently)g
(some)g(GNU)g(ld's)g(only)g(accept)g(-v.)865 3377 y(#)g(Break)g(only)g
(if)h(it)f(was)h(the)f(GNU/non-GNU)f(ld)h(that)h(we)f(prefer.)865
3459 y(if)g("$ac_cv_path_LD")e(-v)j(2)p Fa(>)p Fe(&1)f
Fa(<)g Fe(/dev/null)g(|)g(egrep)g('\(GNU|with)f(BFD\)')h
Fa(>)h Fe(/dev/null;)e(then)640 3541 y(test)i("$with_gnu_ld")d(!=)i(no)
h(&&)f(break)865 3623 y(else)640 3706 y(test)h("$with_gnu_ld")d(!=)i
(yes)h(&&)f(break)865 3788 y(fi)775 3870 y(fi)685 3952
y(done)685 4034 y(IFS="$ac_save_ifs")596 4116 y(else)685
4199 y(ac_cv_path_LD="$LD")e(#)i(Let)h(the)f(user)g(override)g(the)g
(test)g(with)g(a)h(path.)596 4281 y(fi]\))596 4363 y
(LD="$ac_cv_path_LD")596 4445 y(if)f(test)g(-n)h("$LD";)e(then)685
4527 y(AC_MSG_RESULT\($LD\))596 4610 y(else)685 4692
y(AC_MSG_RESULT\(no\))596 4774 y(fi)596 4856 y(test)h(-z)g("$LD")g(&&)h
(AC_MSG_ERROR\([no)d(acceptable)h(ld)h(found)g(in)h(\\$PATH]\))596
4938 y(AC_SUBST\(LD\))596 5021 y(AC_PROG_LD_GNU)596 5103
y(]\))596 5267 y(AC_DEFUN\(AC_PROG_LD_GNU,)596 5349 y
([AC_CACHE_CHECK\([if)c(the)j(linker)g(\($LD\))g(is)h(GNU)f(ld],)g
(ac_cv_prog_gnu_ld,)p Black 3601 5585 a Fd(17)p Black
eop
%%Page: 18 18
18 17 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe([#)44 b(I'd)g(rather)g(use)g(--version)g(here,)g(but)
g(apparently)f(some)h(GNU)h(ld's)f(only)g(ac-)596 171
y(cept)g(-v.)596 253 y(if)g($LD)g(-v)h(2)p Fa(>)p Fe(&1)f
Fa(<)p Fe(/dev/null)f(|)i(egrep)f('\(GNU|with)f(BFD\)')h(1)p
Fa(>)p Fe(&5;)g(then)685 336 y(ac_cv_prog_gnu_ld=yes)596
418 y(else)685 500 y(ac_cv_prog_gnu_ld=no)596 582 y(fi]\))596
664 y(]\))596 829 y(#)g(AC_PROG_NM)f(-)i(find)f(the)g(path)h(to)f(a)h
(BSD-compatible)d(name)i(lister)596 911 y(AC_DEFUN\(AC_PROG_NM,)596
993 y([AC_MSG_CHECKING\([for)d(BSD-compatible)h(nm]\))596
1075 y(AC_CACHE_VAL\(ac_cv_path_NM,)596 1158 y([if)i(test)g(-n)g
("$NM";)g(then)685 1240 y(#)h(Let)f(the)g(user)h(override)e(the)h
(test.)685 1322 y(ac_cv_path_NM="$NM")596 1404 y(else)685
1486 y(IFS="${IFS=)88 b(}";)44 b(ac_save_ifs="$IFS";)e
(IFS="${IFS}${PATH_SEPARATOR-:}")685 1569 y(for)j(ac_dir)e(in)i($PATH)f
(/usr/ccs/bin)f(/usr/ucb)g(/bin;)h(do)775 1651 y(test)g(-z)g("$ac_dir")
g(&&)g(ac_dir=.)775 1733 y(if)g(test)g(-f)h($ac_dir/nm)e(||)i(test)f
(-f)g($ac_dir/nm$ac_exeext)e(;)i(then)865 1815 y(#)g(Check)g(to)h(see)f
(if)g(the)h(nm)f(accepts)g(a)h(BSD-compat)e(flag.)865
1897 y(#)h(Adding)g(the)g(`sed)g(1q')h(prevents)e(false)h(positives)g
(on)g(HP-UX,)g(which)g(says:)865 1979 y(#)134 b(nm:)44
b(unknown)g(option)g("B")g(ignored)865 2062 y(if)g(\($ac_dir/nm)f(-B)h
(/dev/null)g(2)p Fa(>)p Fe(&1)g(|)h(sed)f('1q';)g(exit)g(0\))g(|)h
(egrep)f(/dev/null)f Fa(>)p Fe(/dev/null;)g(then)640
2144 y(ac_cv_path_NM="$ac_dir/nm)e(-B")640 2226 y(break)865
2308 y(elif)j(\($ac_dir/nm)f(-p)h(/dev/null)f(2)p Fa(>)p
Fe(&1)i(|)f(sed)h('1q';)f(exit)g(0\))g(|)h(egrep)f(/dev/null)f
Fa(>)p Fe(/dev/null;)g(then)640 2390 y(ac_cv_path_NM="$ac_dir/nm)e(-p")
640 2473 y(break)865 2555 y(else)640 2637 y
(ac_cv_path_NM=${ac_cv_path_NM="$ac_dir/nm)o("})e(#)45
b(keep)f(the)g(first)g(match,)g(but)640 2719 y(continue)g(#)g(so)h
(that)f(we)h(can)f(try)g(to)h(find)f(one)g(that)g(supports)g(BSD)g
(flags)865 2801 y(fi)775 2884 y(fi)685 2966 y(done)685
3048 y(IFS="$ac_save_ifs")685 3130 y(test)g(-z)h("$ac_cv_path_NM")d(&&)
i(ac_cv_path_NM=nm)596 3212 y(fi]\))596 3295 y(NM="$ac_cv_path_NM")596
3377 y(AC_MSG_RESULT\([$NM]\))596 3459 y(AC_SUBST\(NM\))596
3541 y(]\))596 3706 y(#)g(AC_CHECK_LIBM)f(-)h(check)g(for)h(math)f
(library)596 3788 y(AC_DEFUN\(AC_CHECK_LIBM,)596 3870
y([AC_REQUIRE\([AC_CANONICAL_HOST]\)dnl)596 3952 y(LIBM=)596
4034 y(case)g("$host")f(in)596 4116 y(*-*-beos*)g(|)h(*-*-cygwin*\))685
4199 y(#)h(These)f(system)g(don't)g(have)g(libm)685 4281
y(;;)596 4363 y(*-ncr-sysv4.3*\))685 4445 y(AC_CHECK_LIB\(mw,)e
(_mwvalidcheckl,)h(LIBM="-lmw"\))685 4527 y(AC_CHECK_LIB\(m,)f(main,)i
(LIBM="$LIBM)f(-lm"\))685 4610 y(;;)596 4692 y(*\))685
4774 y(AC_CHECK_LIB\(m,)f(main,)i(LIBM="-lm"\))685 4856
y(;;)596 4938 y(esac)596 5021 y(]\))596 5185 y(#)g
(AC_LIBLTDL_CONVENIENCE[\(dir\)])c(-)45 b(sets)f(LIBLTDL)g(to)g(the)g
(link)h(flags)f(for)596 5267 y(#)g(the)h(libltdl)e(convenience)g
(library,)h(adds)g(--enable-ltdl-convenience)c(to)596
5349 y(#)k(the)h(configure)e(arguments.)88 b(Note)44
b(that)g(LIBLTDL)g(is)g(not)h(AC_SUBSTed,)e(nor)596 5432
y(#)h(is)h(AC_CONFIG_SUBDIRS)d(called.)88 b(If)45 b(DIR)f(is)g(not)h
(provided,)e(it)i(is)f(assumed)p Black 197 5585 a Fd(18)p
Black eop
%%Page: 19 19
19 18 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(#)44 b(to)h(be)f(`${top_builddir}/libltdl'.)85
b(Make)45 b(sure)f(you)g(start)g(DIR)g(with)596 171 y(#)g
('${top_builddir}/')e(\(note)i(the)g(single)g(quotes!\))g(if)g(your)g
(package)g(is)g(not)596 253 y(#)g(flat,)g(and,)g(if)h(you're)f(not)g
(using)g(automake,)f(define)h(top_builddir)f(as)596 336
y(#)h(appropriate)f(in)i(the)f(Makefiles.)596 418 y
(AC_DEFUN\(AC_LIBLTDL_CONVENIENCE,)39 b
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)dnl)685 500 y(case)44
b("$enable_ltdl_convenience")d(in)685 582 y(no\))k(AC_MSG_ERROR\([this)
c(package)j(needs)g(a)h(convenience)e(libltdl]\))g(;;)685
664 y(""\))i(enable_ltdl_convenience=yes)865 747 y
(ac_configure_args="$ac_configure_arg)o(s)39 b
(--enable-ltdl-convenience")i(;;)685 829 y(esac)685 911
y(LIBLTDL=ifelse\($#,1,$1,['${top_builddir})o(/liblt)o(dl']\)/)o
(libltd)o(lc.la)685 993 y(INCLTDL=ifelse\($#,1,-I$1,['-I${top_build)o
(dir}/l)o(ibltdl)o(']\))596 1075 y(]\))596 1240 y(#)j
(AC_LIBLTDL_INSTALLABLE[\(dir\)])c(-)45 b(sets)f(LIBLTDL)g(to)g(the)g
(link)h(flags)f(for)596 1322 y(#)g(the)h(libltdl)e(installable)g
(library,)h(and)g(adds)g(--enable-ltdl-install)d(to)596
1404 y(#)j(the)h(configure)e(arguments.)88 b(Note)44
b(that)g(LIBLTDL)g(is)g(not)h(AC_SUBSTed,)e(nor)596 1486
y(#)h(is)h(AC_CONFIG_SUBDIRS)d(called.)88 b(If)45 b(DIR)f(is)g(not)h
(provided,)e(it)i(is)f(assumed)596 1569 y(#)g(to)h(be)f
(`${top_builddir}/libltdl'.)85 b(Make)45 b(sure)f(you)g(start)g(DIR)g
(with)596 1651 y(#)g('${top_builddir}/')e(\(note)i(the)g(single)g
(quotes!\))g(if)g(your)g(package)g(is)g(not)596 1733
y(#)g(flat,)g(and,)g(if)h(you're)f(not)g(using)g(automake,)f(define)h
(top_builddir)f(as)596 1815 y(#)h(appropriate)f(in)i(the)f(Makefiles.)
596 1897 y(#)g(In)h(the)f(future,)g(this)g(macro)g(may)g(have)g(to)h
(be)f(called)g(after)g(AC_PROG_LIBTOOL.)596 1979 y
(AC_DEFUN\(AC_LIBLTDL_INSTALLABLE,)39 b
([AC_BEFORE\([$0],[AC_LIBTOOL_SETUP]\)dnl)685 2062 y
(AC_CHECK_LIB\(ltdl,)j(main,)685 2144 y([test)i
(x"$enable_ltdl_install")d(!=)k(xyes)f(&&)g(enable_ltdl_install=no],)
685 2226 y([if)h(test)f(x"$enable_ltdl_install")d(=)j(xno;)g(then)820
2308 y(AC_MSG_WARN\([libltdl)d(not)j(installed,)g(but)g(installation)f
(disabled]\))730 2390 y(else)820 2473 y(enable_ltdl_install=yes)730
2555 y(fi)685 2637 y(]\))685 2719 y(if)i(test)f
(x"$enable_ltdl_install")d(=)j(x"yes";)g(then)775 2801
y(ac_configure_args="$ac_configure_args)38 b(--enable-ltdl-install")775
2884 y(LIBLTDL=ifelse\($#,1,$1,['${top_builddi)o(r}/lib)o(ltdl'])o
(\)/libl)o(tdl.la)775 2966 y(INCLTDL=ifelse\($#,1,-I$1,['-I${top_bui)o
(lddir})o(/liblt)o(dl']\))685 3048 y(else)775 3130 y
(ac_configure_args="$ac_configure_args)g(--enable-ltdl-install=no")775
3212 y(LIBLTDL="-lltdl")775 3295 y(INCLTDL=)685 3377
y(fi)596 3459 y(]\))596 3623 y(dnl)44 b(old)g(names)596
3706 y(AC_DEFUN\(AM_PROG_LIBTOOL,)c([indir\([AC_PROG_LIBTOOL]\)]\)dnl)
596 3788 y(AC_DEFUN\(AM_ENABLE_SHARED,)g([indir\([AC_ENABLE_SHARED],)g
($@\)]\)dnl)596 3870 y(AC_DEFUN\(AM_ENABLE_STATIC,)g
([indir\([AC_ENABLE_STATIC],)g($@\)]\)dnl)596 3952 y
(AC_DEFUN\(AM_DISABLE_SHARED,)g([indir\([AC_DISABLE_SHARED],)g
($@\)]\)dnl)596 4034 y(AC_DEFUN\(AM_DISABLE_STATIC,)g
([indir\([AC_DISABLE_STATIC],)g($@\)]\)dnl)596 4116 y
(AC_DEFUN\(AM_PROG_LD,)h([indir\([AC_PROG_LD]\)]\)dnl)596
4199 y(AC_DEFUN\(AM_PROG_NM,)g([indir\([AC_PROG_NM]\)]\)dnl)596
4363 y(dnl)j(This)g(is)g(just)h(to)f(silence)g(aclocal)f(about)h(the)h
(macro)f(not)g(being)g(used)596 4445 y
(ifelse\([AC_DISABLE_FAST_INSTALL]\)dnl)596 4692 y(dnl)g(AM_PROG_LEX)
596 4774 y(dnl)g(Look)g(for)g(flex,)g(lex)h(or)f(missing,)g(then)g(run)
g(AC_PROG_LEX)f(and)h(AC_DECL_YYTEXT)596 4856 y(AC_DEFUN\(AM_PROG_LEX,)
596 4938 y([missing_dir=ifelse\([$1]\204`cd)c($ac_aux_dir)j(&&)h
(pwd`,$1\))596 5021 y(AC_CHECK_PROGS\(LEX,)d(flex)j(lex,)g
("$missing_dir/missing)e(flex"\))596 5103 y(AC_PROG_LEX)596
5185 y(AC_DECL_YYTEXT]\))596 5359 y Fd(Code:)20 b(/home/mikal/opensour)
o(ce/trivsql/aclocal.m4)p Black 3601 5585 a(19)p Black
eop
%%Page: 20 20
20 19 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(#)44 b(This)g(file)g(is)h(a)g(shell)f(script)f(that)i
(caches)e(the)i(results)e(of)i(configure)596 171 y(#)f(tests)g(run)g
(on)h(this)f(system)g(so)g(they)h(can)f(be)g(shared)g(between)g
(configure)596 253 y(#)g(scripts)g(and)g(configure)f(runs.)89
b(It)45 b(is)f(not)h(useful)e(on)i(other)f(systems.)596
336 y(#)g(If)h(it)f(contains)g(results)f(you)i(don't)f(want)g(to)g
(keep,)g(you)h(may)f(remove)g(or)g(edit)g(it.)596 418
y(#)596 500 y(#)g(By)h(default,)e(configure)g(uses)i(./config.cache)d
(as)j(the)f(cache)g(file,)596 582 y(#)g(creating)g(it)g(if)h(it)f(does)
g(not)h(exist)f(already.)88 b(You)44 b(can)h(give)f(configure)596
664 y(#)g(the)h(--cache-file=FILE)c(option)j(to)h(use)f(a)h(different)e
(cache)h(file;)g(that)g(is)596 747 y(#)g(what)g(configure)g(does)g
(when)g(it)g(calls)g(configure)g(scripts)f(in)596 829
y(#)h(subdirectories,)e(so)j(they)f(share)g(the)g(cache.)596
911 y(#)g(Giving)g(--cache-file=/dev/null)d(disables)j(caching,)f(for)h
(debugging)g(configure.)596 993 y(#)g(config.status)f(only)h(pays)g
(attention)f(to)i(the)f(cache)g(file)g(if)h(you)f(give)g(it)h(the)596
1075 y(#)f(--recheck)f(option)h(to)h(rerun)f(configure.)596
1158 y(#)596 1240 y(ac_cv_exeext=${ac_cv_exeext=no})596
1322 y(ac_cv_header_dlfcn_h=${ac_cv_header_)o(dlfcn_)o(h=yes})596
1404 y(ac_cv_header_stdc=${ac_cv_header_std)o(c=yes})596
1486 y(ac_cv_lib_dl_dlopen=${ac_cv_lib_dl_d)o(lopen=)o(yes})596
1569 y(ac_cv_lib_fl_yywrap=${ac_cv_lib_fl_y)o(ywrap=)o(yes})596
1651 y(ac_cv_lib_m_atan=${ac_cv_lib_m_atan=)o(yes})596
1733 y(ac_cv_path_LD=${ac_cv_path_LD=/usr/b)o(in/ld})596
1815 y(ac_cv_path_NM=${ac_cv_path_NM='/usr/)o(bin/nm)38
b(-B'})596 1897 y(ac_cv_path_install=${ac_cv_path_inst)o(all='/)o
(usr/bi)o(n/inst)o(all)h(-c'})596 1979 y
(ac_cv_prog_CC=${ac_cv_prog_CC=gcc})596 2062 y
(ac_cv_prog_CPP=${ac_cv_prog_CPP='gcc)f(-E'})596 2144
y(ac_cv_prog_LEX=${ac_cv_prog_LEX=flex)o(})596 2226 y
(ac_cv_prog_LN_S=${ac_cv_prog_LN_S='l)o(n)h(-s'})596
2308 y(ac_cv_prog_RANLIB=${ac_cv_prog_RANLI)o(B=ranl)o(ib})596
2390 y(ac_cv_prog_YACC=${ac_cv_prog_YACC='b)o(ison)g(-y'})596
2473 y(ac_cv_prog_cc_cross=${ac_cv_prog_cc_)o(cross=)o(no})596
2555 y(ac_cv_prog_cc_g=${ac_cv_prog_cc_g=ye)o(s})596
2637 y(ac_cv_prog_cc_works=${ac_cv_prog_cc_)o(works=)o(yes})596
2719 y(ac_cv_prog_gcc=${ac_cv_prog_gcc=yes})596 2801
y(ac_cv_prog_gnu_ld=${ac_cv_prog_gnu_l)o(d=yes})596 2884
y(ac_cv_prog_lex_root=${ac_cv_prog_lex)o(_root=)o(lex.yy)o(})596
2966 y(ac_cv_prog_lex_yytext_pointer=${ac_c)o(v_prog)o(_lex_y)o(ytext_)
o(pointe)o(r=yes})596 3048 y(ac_cv_prog_make_make_set=${ac_cv_pro)o
(g_make)o(_make_)o(set=ye)o(s})596 3130 y
(lt_cv_dlopen=${lt_cv_dlopen=dlopen})596 3212 y
(lt_cv_dlopen_libs=${lt_cv_dlopen_lib)o(s=-ldl)o(})596
3295 y(lt_cv_dlopen_self=${lt_cv_dlopen_sel)o(f=yes})596
3377 y(lt_cv_dlopen_self_static=${lt_cv_dlo)o(pen_se)o(lf_sta)o(tic=no)
o(})596 3551 y Fd(Code:)20 b(/home/mikal/opensour)o
(ce/trivsql/con\002g.cache)596 3716 y Fe(#include)43
b Fa(<)p Fe(stdio.h)p Fa(>)596 3799 y Fe(#include)g("trivsql.h")596
3963 y(int)h(main\(int)f(argc,)h(char)g(*argv[]\){)685
4045 y(trivsql_state)f(*ourState;)685 4127 y(trivsql_recordset)f(*rs;)
685 4209 y(char)i(cmd[1000];)685 4374 y(if\(argc)g(!=)g(2\){)775
4456 y(fprintf\(stderr,)e("Please)i(specify)f(a)i(db)g(file\\n"\);)775
4538 y(exit\(42\);)685 4620 y(})685 4785 y(ourState)f(=)g
(trivsql_opendb\(argv[1]\);)685 4867 y(if\(trivsql_initok\(ourState\))c
(!=)45 b(TRIVSQL_TRUE\){)775 4949 y(fprintf\(stderr,)d("Database)h
(open)i(failed\\n"\);)775 5031 y(exit\(42\);)685 5114
y(})685 5278 y(while\(fgets\(cmd,)d(1000,)i(stdin\))g(!=)h(NULL\){)775
5360 y(rs)f(=)h(trivsql_execute\(ourState,)c(cmd\);)775
5442 y(if\(rs)j(!=)g(NULL\))g(trivsql_displayrs\(rs\);)p
Black 197 5585 a Fd(20)p Black eop
%%Page: 21 21
21 20 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 775 89 a Fe(else)44 b(printf\("NULL)f(recordset\\n"\);)775
171 y(trivsql_xfree\(rs\);)685 253 y(})596 336 y(})596
510 y Fd(Code:)20 b(/home/mikal/opensour)o(ce/trivsql/example.c)596
675 y Fe(#include)43 b("trivsql.h")596 840 y(char)h(*gTrivData)f(=)h
(NULL;)596 922 y(int)g(gTrivInset;)596 1086 y(extern)f(trivsql_state)g
(*gState;)596 1251 y(//)h(Interface)f(to)i(the)f(SQL)g(database)596
1333 y(trivsql_state)e(*trivsql_opendb\(char)g(*path\){)685
1415 y(return)i(trivsql_init\(path\);)596 1497 y(})596
1662 y(trivsql_recordset)d(*trivsql_execute\(trivsql_state)f(*state,)k
(char)g(*sql\){)685 1744 y(trivsql_xfree\(gTrivData\);)685
1826 y(gTrivData)f(=)i(trivsql_xsnprintf\("\045s",)c(sql\);)685
1908 y(gTrivInset)i(=)i(0;)685 2072 y(trivsql_xfree\(state-)p
Fa(>)p Fe(rs\);)685 2155 y(state-)p Fa(>)p Fe(rs)e(=)i(NULL;)685
2237 y(gState)f(=)h(state;)685 2319 y(yyparse\(\);)685
2401 y(return)f(gState-)p Fa(>)p Fe(rs;)596 2483 y(})596
2648 y(int)g(trivsql_gettext\(char)d(*buffer,)j(int)g(maxlen\){)685
2730 y(int)h(size;)685 2894 y(//)g(Determine)e(the)h(maximum)g(size)g
(to)h(return)685 2977 y(size)f(=)h(trivsql_min\(maxlen,)d
(strlen\(gTrivData\))g(-)i(gTrivInset\);)685 3141 y(if\(size)g
Fa(>)g Fe(0\){)775 3223 y(memcpy\(buffer,)e(gTrivData)i(+)g
(gTrivInset,)f(size\);)775 3305 y(gTrivInset)g(+=)h(size;)685
3388 y(})685 3552 y(return)g(size;)596 3634 y(})596 3799
y(void)g(trivsql_displayrs\(trivsql_recordset)39 b(*rs\){)685
3881 y(int)45 b(i,)f(col;)685 3963 y(char)g(*t,)h(*u,)f(*c,)g
(*localCols;)685 4127 y(//)h(Was)f(there)g(an)g(error?)685
4209 y(switch\(rs-)p Fa(>)p Fe(errno\){)685 4292 y(case)g
(TRIVSQL_FALSE:)775 4374 y(printf\("This)f(statement)g(produced)g(no)i
(results.\\n"\);)775 4456 y(return;)685 4620 y(case)f(TRIVSQL_TRUE:)775
4703 y(break;)685 4867 y(default:)775 4949 y(printf\("There)e(was)j(an)
f(error)g(processing)f(this)i(statement)e(\(\045d\).\\n",)775
5031 y(rs-)p Fa(>)p Fe(errno\);)775 5114 y(if\(rs-)p
Fa(>)p Fe(errstring)f(!=)i(NULL\))865 5196 y(printf\("trivsql)e(engine)
i(reported:)f(\045s\\n",)h(rs-)p Fa(>)p Fe(errstring\);)775
5278 y(return;)685 5360 y(})p Black 3601 5585 a Fd(21)p
Black eop
%%Page: 22 22
22 21 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(//)45 b(Print)f(the)g(header)g(line)685
171 y(printf\("\\n="\);)685 253 y(for\(i)g(=)h(0;)f(i)h
Fa(<)g Fe(rs-)p Fa(>)p Fe(numCols;)d(i++\){)775 336 y
(printf\("==============="\);)685 418 y(})685 500 y(printf\("\\n|"\);)
685 664 y(//)j(Print)f(out)g(the)g(column)g(names)685
747 y(localCols)f(=)i(trivsql_xsnprintf\("\045s",)c(rs-)p
Fa(>)p Fe(cols\);)685 829 y(c)k(=)g(strtok\(localCols,)c(";"\);)685
911 y(while\(c)j(!=)g(NULL\){)775 993 y(printf\(")f(\045-12s)h(|",)h
(c\);)775 1075 y(c)g(=)f(strtok\(NULL,)f(";"\);)685 1158
y(})685 1322 y(printf\("\\n="\);)685 1404 y(for\(i)h(=)h(0;)f(i)h
Fa(<)g Fe(rs-)p Fa(>)p Fe(numCols;)d(i++\){)775 1486
y(printf\("==============="\);)685 1569 y(})685 1651
y(printf\("\\n"\);)685 1815 y(//)j(Print)f(out)g(the)g(values)g(we)h
(have)f(found)685 1897 y(trivsql_rsmovefirst\(rs\);)685
1979 y(while\(trivsql_rseof\(rs\))d(!=)k(TRIVSQL_TRUE\){)775
2062 y(for\(i)f(=)g(0;)h(i)g Fa(<)f Fe(rs-)p Fa(>)p Fe(numCols;)f
(i++\))865 2144 y(printf\("|)g(\045-12s)h(",)g(trivsql_rsfield\(rs,)e
(i\)\);)775 2226 y(printf\("|\\n-"\);)775 2308 y(for\(i)i(=)g(0;)h(i)g
Fa(<)f Fe(rs-)p Fa(>)p Fe(numCols;)f(i++\){)865 2390
y(printf\("---------------"\);)775 2473 y(})775 2555
y(printf\("\\n"\);)775 2719 y(trivsql_rsmovenext\(rs\);)685
2801 y(})685 2966 y(printf\("\\n"\);)685 3048 y(printf\("Select)g
(returned)g(\045d)i(rows)f(of)g(\045d)h(columns\\n",)685
3130 y(rs-)p Fa(>)p Fe(numRows,)e(rs-)p Fa(>)p Fe(numCols\);)596
3212 y(})596 3377 y(void)h(trivsql_rsmovefirst\(trivsql_recordset)38
b(*rs\){)685 3459 y(rs-)p Fa(>)p Fe(currentRow)43 b(=)h(rs-)p
Fa(>)p Fe(rows;)596 3541 y(})596 3706 y(void)g
(trivsql_rsmovenext\(trivsql_recordset)38 b(*rs\){)685
3788 y(if\(rs-)p Fa(>)p Fe(currentRow-)p Fa(>)p Fe(next)j(!=)j(NULL\))
775 3870 y(rs-)p Fa(>)p Fe(currentRow)e(=)j(rs-)p Fa(>)p
Fe(currentRow-)p Fa(>)p Fe(next;)596 3952 y(})596 4116
y(int)f(trivsql_rseof\(trivsql_recordset)39 b(*rs\){)685
4199 y(if\(rs-)p Fa(>)p Fe(errno)k(!=)h(TRIVSQL_TRUE\))f(return)h
(TRIVSQL_TRUE;)685 4281 y(return)g(rs-)p Fa(>)p Fe(currentRow-)p
Fa(>)p Fe(next)d(==)k(NULL)f(?)h(TRIVSQL_TRUE)d(:)j(TRIVSQL_FALSE;)596
4363 y(})596 4527 y(int)f(trivsql_rsbof\(trivsql_recordset)39
b(*rs\){)685 4610 y(return)44 b(rs-)p Fa(>)p Fe(currentRow)e(==)j(rs-)p
Fa(>)p Fe(rows)e(?)i(TRIVSQL_TRUE)e(:)h(TRIVSQL_FALSE;)596
4692 y(})596 4856 y(char)g(*trivsql_rsfield\(trivsql_recordset)39
b(*rs,)44 b(int)g(colnum\){)685 4938 y(int)h(count;)685
5021 y(trivsql_col)e(*theCol;)685 5185 y(count)h(=)h(0;)685
5267 y(theCol)f(=)h(rs-)p Fa(>)p Fe(currentRow-)p Fa(>)p
Fe(cols;)685 5349 y(while\(\(theCol-)p Fa(>)p Fe(next)d(!=)i(NULL\))g
(&&)h(\(count)f Fa(<)g Fe(colnum\)\){)775 5432 y(theCol)g(=)g(theCol-)p
Fa(>)p Fe(next;)p Black 197 5585 a Fd(22)p Black eop
%%Page: 23 23
23 22 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 775 89 a Fe(count++;)685 171 y(})685 336 y(return)44
b(theCol-)p Fa(>)p Fe(val;)596 418 y(})596 582 y(void)g
(trivsql_updaters\(trivsql_state)39 b(*state,)44 b(trivsql_recordset)e
(*rs,)954 664 y(char)i(*col,)g(char)g(*newval\){)685
747 y(//)h(Was)f(there)g(an)g(error?)685 829 y(switch\(rs-)p
Fa(>)p Fe(errno\){)685 911 y(case)g(TRIVSQL_FALSE:)775
993 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)e(=)i
(TRIVSQL_NOROWSTOUPDATE;)775 1075 y(return;)685 1240
y(case)g(TRIVSQL_TRUE:)775 1322 y(break;)685 1486 y(default:)775
1569 y(return;)685 1651 y(})685 1815 y(//)h(For)f(the)g(moment)g(we)h
(assume)e(there)h(is)h(only)f(one)g(column)685 1897 y
(trivsql_rsmovefirst\(rs\);)685 1979 y(while\(trivsql_rseof\(rs\))d(!=)
k(TRIVSQL_TRUE\){)775 2062 y(trivsql_rsupdatefield\(state,)40
b(rs,)k(0,)h(newval\);)775 2144 y(trivsql_rsmovenext\(rs\);)685
2226 y(})596 2308 y(})596 2473 y(//)f(NOTE:)g(The)g(existing)g
(recordset)f(is)i(not)f(updated)g(--)g(you)g(need)h(to)f(reselect)596
2555 y(void)g(trivsql_rsupdatefield\(trivsql_state)39
b(*state,)k(trivsql_recordset)f(*rs,)865 2637 y(int)i(colnum,)f(char)i
(*newval\){)685 2719 y(int)g(count;)685 2801 y(trivsql_col)e(*theCol;)
685 2966 y(count)h(=)h(0;)685 3048 y(theCol)f(=)h(rs-)p
Fa(>)p Fe(currentRow-)p Fa(>)p Fe(cols;)685 3130 y(while\(\(theCol-)p
Fa(>)p Fe(next)d(!=)i(NULL\))g(&&)h(\(count)f Fa(<)g
Fe(colnum\)\){)775 3212 y(theCol)g(=)g(theCol-)p Fa(>)p
Fe(next;)775 3295 y(count++;)685 3377 y(})685 3541 y
(trivsql_dbwrite\(state,)d(theCol-)p Fa(>)p Fe(key,)i(newval\);)596
3623 y(})596 3798 y Fd(Code:)20 b(/home/mikal/opensour)o
(ce/trivsql/interface.c)596 3963 y Fe(#include)43 b("trivsql.h")596
4045 y(#include)g Fa(<)p Fe(stdarg.h)p Fa(>)596 4209
y Fe(extern)g(trivsql_state)g(*gState;)596 4292 y(const)h(char)g
(*trivsql_version)e(=)i(VERSION;)596 4456 y(trivsql_state)e
(*trivsql_init\(char)g(*filename\){)685 4538 y(trivsql_state)h(*state;)
685 4703 y(state)h(=)h(\(trivsql_state)d(*\))j
(trivsql_xmalloc\(sizeof\(trivsql_state\)\))o(;)685 4785
y(state-)p Fa(>)p Fe(db)e(=)i(tdb_open\(filename,)d(0,)i(0,)h(O_RDWR)f
(|)g(O_CREAT,)g(0600\);)685 4867 y(state-)p Fa(>)p Fe(rs)f(=)i(NULL;)
685 4949 y(state-)p Fa(>)p Fe(seltree)e(=)h(NULL;)685
5031 y(state-)p Fa(>)p Fe(table)f(=)i(NULL;)685 5196
y(//)g(We)f(write)g(the)g(version)g(of)h(trivsql)e(we)i(used)f(into)g
(a)h(tag)f(in)h(the)f(tdb)g(for)685 5278 y(//)h(debugging)685
5360 y(if\(state-)p Fa(>)p Fe(db)e(!=)h(NULL\))775 5442
y(trivsql_dbwrite\(state,)d("trivsql_lastversion",)g
(trivsql_version\);)p Black 3601 5585 a Fd(23)p Black
eop
%%Page: 24 24
24 23 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 171 a Fe(return)44 b(state;)596 253 y(})596
418 y(void)g(trivsql_docreate\(char)d(*tname,)j(char)g(*cols\))596
500 y({)685 582 y(char)g(*t;)685 664 y(char)g(*u;)685
747 y(int)h(colCount)e(=)i(0;)685 911 y(t)g(=)g
(trivsql_xsnprintf\("trivsql_\045s_numrow)o(s",)39 b(tname\);)685
993 y(trivsql_dbwrite\(gState,)i(t,)k("0"\);)685 1075
y(trivsql_xfree\(t\);)685 1240 y(u)g(=)g(strtok\(cols,)d(";"\);)685
1322 y(while\(u)i(!=)g(NULL\){)775 1404 y(t)h(=)f
(trivsql_xsnprintf\("trivsql_\045s_col\045d",)39 b(tname,)44
b(colCount\);)775 1486 y(trivsql_dbwrite\(gState,)d(t,)j(u\);)775
1569 y(trivsql_xfree\(t\);)775 1733 y(colCount++;)775
1815 y(u)h(=)f(strtok\(NULL,)f(";"\);)685 1897 y(})685
2062 y(t)i(=)g(trivsql_xsnprintf\("trivsql_\045s_numcol)o(s",)39
b(tname\);)685 2144 y(u)45 b(=)g(trivsql_xsnprintf\("\045d",)40
b(colCount\);)685 2226 y(trivsql_dbwrite\(gState,)h(t,)k(u\);)685
2308 y(trivsql_xfree\(t\);)685 2390 y(trivsql_xfree\(u\);)596
2473 y(})596 2637 y(void)f(trivsql_doinsert\(char)d(*tname,)j(char)g
(*cols,)g(char)g(*vals\){)685 2719 y(char)g(*t,)h(*u,)f(*c;)685
2801 y(int)h(rowCount,)e(i,)h(col,)g(numCols;)685 2884
y(int)h(*colNumbers;)685 3048 y(if\(\(rowCount)e(=)i
(trivsql_getrowcount\(tname\)\))40 b(==)k(-1\){)775 3130
y(return;)685 3212 y(})685 3377 y(//)h(Get)f(ready)g(for)g(columns)685
3459 y(if\(\(colNumbers)f(=)h(trivsql_parsecols\(tname,)d(cols,)j
(&numCols\)\))f(==)i(NULL\){)775 3541 y(return;)685 3623
y(})685 3788 y(//)g(How)f(we)g(have)h(the)f(right)g(number)g(of)g
(values?)685 3870 y(col)h(=)f(1;)685 3952 y(for\(i)g(=)h(0;)f(i)h
Fa(<)g Fe(strlen\(vals\);)d(i++\))775 4034 y(if\(vals[i])h(==)h(';'\))
865 4116 y(col++;)685 4281 y(if\(col)g(!=)g(numCols\){)775
4363 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)e(=)i
(TRIVSQL_BADVALUES;)775 4445 y(return;)685 4527 y(})685
4692 y(//)h(Save)f(each)g(column)g(value)685 4774 y(c)h(=)g
(strtok\(vals,)d(";"\);)685 4856 y(col)j(=)f(0;)685 4938
y(while\(c)g(!=)g(NULL\){)775 5021 y(t)h(=)f
(trivsql_xsnprintf\("trivsql_\045s_col\045drow\045d)o(",)39
b(tname,)44 b(colNumbers[col],)e(rowCount\);)775 5103
y(trivsql_dbwrite\(gState,)f(t,)j(c\);)775 5185 y(trivsql_xfree\(t\);)
775 5349 y(c)h(=)f(strtok\(NULL,)f(";"\);)775 5432 y(col++;)p
Black 197 5585 a Fd(24)p Black eop
%%Page: 25 25
25 24 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(})685 253 y(//)45 b(And)f(we)g(should)g(keep)g(count)
g(of)h(how)f(many)g(of)h(the)f(rows)g(are)h(in)f(the)h(table)685
336 y(t)g(=)g(trivsql_xsnprintf\("trivsql_\045s_numrow)o(s",)39
b(tname\);)685 418 y(u)45 b(=)g(trivsql_xsnprintf\("\045d",)40
b(rowCount)k(+)h(1\);)685 500 y(trivsql_dbwrite\(gState,)c(t,)k(u\);)
685 582 y(trivsql_xfree\(t\);)685 664 y(trivsql_xfree\(u\);)596
747 y(})596 911 y(void)f(trivsql_doselect\(char)d(*tname,)j(char)g
(*cols\){)685 993 y(int)h(*colNumbers;)685 1075 y(int)g(row,)f
(rowCount,)f(numCols;)685 1158 y(char)h(*t,)h(*u,)f(*localCols;)685
1322 y(//)h(If)f(the)g(columns)g(list)g(is)h('*',)f(substitute)f(a)i
(list)f(of)g(all)h(the)f(columns)685 1404 y(if\(strcmp\(cols,)e("*"\))j
(==)f(0\))775 1486 y(localCols)f(=)i(trivsql_getallcolumns\(tname\);)
685 1569 y(else)775 1651 y(localCols)e(=)i(cols;)685
1815 y(//)g(Get)f(ready)g(for)g(columns)685 1897 y(if\(\(colNumbers)f
(=)h(trivsql_parsecols\(tname,)d(localCols,)i(&numCols\)\))g(==)i
(NULL\){)775 1979 y(return;)685 2062 y(})685 2226 y(//)g(Populate)e
(recordset)685 2308 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p
Fe(numCols)f(=)i(numCols;)685 2390 y(gState-)p Fa(>)p
Fe(rs-)p Fa(>)p Fe(cols)e(=)j(trivsql_xsnprintf\("\045s",)c
(localCols\);)685 2473 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p
Fe(errno)h(=)j(TRIVSQL_TRUE;)685 2637 y(//)g(Decide)e(what)i(rows)f(on)
g(the)h(table)f(match)g(the)g(select)g(condition)685
2719 y(if\(\(rowCount)f(=)i(trivsql_getrowcount\(tname\)\))40
b(==)k(-1\){)775 2801 y(return;)685 2884 y(})685 3048
y(for\(row)g(=)g(0;)h(row)f Fa(<)h Fe(rowCount;)e(row++\){)775
3130 y(if\(trivsql_executeselector\(gState-)p Fa(>)p
Fe(sel)o(tree,)38 b(row\))45 b(==)f(SELTRUE\))865 3212
y(trivsql_addrow\(gState-)p Fa(>)p Fe(rs,)c(tname,)k(row,)g
(colNumbers\);)685 3295 y(})596 3377 y(})596 3541 y(void)g
(trivsql_doalter\(char)d(*tname,)j(char)g(*cols\))596
3623 y({)685 3706 y(char)g(*t;)685 3788 y(char)g(*u;)685
3870 y(int)h(colCount)e(=)i(0;)685 4034 y(t)g(=)g
(trivsql_xsnprintf\("trivsql_\045s_numcol)o(s",)39 b(tname\);)685
4116 y(u)45 b(=)g(trivsql_dbread\(gState,)c(t\);)685
4199 y(if\(u)j(==)h(NULL\))f(colCount)f(=)i(0;)685 4281
y(else)f(colCount)g(=)g(atoi\(u\);)685 4363 y(trivsql_xfree\(t\);)685
4445 y(trivsql_xfree\(u\);)685 4610 y(//)h(Add)f(the)g(column)685
4692 y(t)h(=)g(trivsql_xsnprintf\("trivsql_\045s_col\045d")o(,)39
b(tname,)44 b(colCount\);)685 4774 y(trivsql_dbwrite\(gState,)d(t,)k
(cols\);)685 4856 y(trivsql_xfree\(t\);)685 4938 y(colCount++;)685
5103 y(t)g(=)g(trivsql_xsnprintf\("trivsql_\045s_numcol)o(s",)39
b(tname\);)685 5185 y(u)45 b(=)g(trivsql_xsnprintf\("\045d",)40
b(colCount\);)685 5267 y(trivsql_dbwrite\(gState,)h(t,)k(u\);)685
5349 y(trivsql_xfree\(t\);)685 5432 y(trivsql_xfree\(u\);)p
Black 3601 5585 a Fd(25)p Black eop
%%Page: 26 26
26 25 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(})596 253 y(void)44 b(*)596 336 y(trivsql_xmalloc)e
(\(size_t)h(size\))596 418 y({)685 500 y(void)h(*buffer;)685
664 y(if)h(\(\(buffer)e(=)i(malloc)f(\(size\)\))f(==)i(NULL\))775
747 y({)865 829 y(//)f(todo_mikal:)f(improve)h(this)865
911 y(fprintf\(stderr,)e("trivsql)h(memory)h(allocation)f(error"\);)865
993 y(exit\(42\);)775 1075 y(})685 1240 y(return)h(buffer;)596
1322 y(})596 1486 y(void)596 1569 y(trivsql_dbwrite)e(\(trivsql_state)g
(*state,)i(char)g(*key,)g(char)g(*value\))596 1651 y({)685
1733 y(TDB_DATA)g(dbkey,)f(dbdata;)685 1897 y(if)i(\(key)f(==)g
(NULL\){)775 1979 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p
Fe(errno)e(=)i(TRIVSQL_TDBNULLKEY;)775 2062 y(return;)685
2144 y(})685 2308 y(if)h(\(value)e(==)i(NULL\){)775 2390
y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)d(=)i(TRIVSQL_TDBNULLDATA;)
775 2473 y(return;)685 2555 y(})685 2719 y(//)h(We)f(need)g(to)h(build)
f(the)g(structures)f(for)i(the)f(TDB)g(call)685 2801
y(dbkey.dptr)f(=)i(key;)685 2884 y(dbkey.dsize)e(=)i(strlen)f(\(key\))g
(+)g(1;)685 2966 y(dbdata.dptr)f(=)i(value;)685 3048
y(dbdata.dsize)e(=)i(strlen)e(\(value\))h(+)h(1;)685
3212 y(if)g(\(tdb_store)e(\(state-)p Fa(>)p Fe(db,)g(dbkey,)h(dbdata,)f
(TDB_REPLACE\))g(!=)h(0\))775 3295 y({)865 3377 y(gState-)p
Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)d(=)k(TRIVSQL_TDBSTOREERROR;)865
3459 y(return;)775 3541 y(})596 3623 y(})596 3788 y(char)f(*)596
3870 y(trivsql_dbread)e(\(trivsql_state)g(*state,)i(char)g(*key\))596
3952 y({)685 4034 y(TDB_DATA)g(dbkey,)f(dbdata;)685 4199
y(if)i(\(key)f(==)g(NULL\){)775 4281 y(gState-)p Fa(>)p
Fe(rs-)p Fa(>)p Fe(errno)e(=)i(TRIVSQL_TDBNULLKEY;)775
4363 y(return)g(NULL;)685 4445 y(})685 4610 y(//)h(We)f(need)g(to)h
(build)f(the)g(structures)f(for)i(the)f(TDB)g(call)685
4692 y(dbkey.dptr)f(=)i(key;)685 4774 y(dbkey.dsize)e(=)i(strlen)f
(\(key\))g(+)g(1;)685 4938 y(dbdata)g(=)h(tdb_fetch)e(\(state-)p
Fa(>)p Fe(db,)g(dbkey\);)685 5103 y(return)h(dbdata.dptr;)596
5185 y(})596 5349 y(char)g(*)596 5432 y(trivsql_xsnprintf)d(\(char)j
(*format,)g(...\))p Black 197 5585 a Fd(26)p Black eop
%%Page: 27 27
27 26 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe({)685 171 y(char)44 b(*output)g(=)h(NULL;)685
253 y(int)g(size,)e(result;)685 336 y(va_list)h(ap;)685
500 y(/*)h(We)f(start)g(with)g(the)h(size)f(of)g(the)h(format)e(string)
h(as)h(a)f(guess)g(*/)685 582 y(size)g(=)h(strlen)f(\(format\);)685
664 y(va_start)g(\(ap,)g(format\);)685 829 y(while)g(\(1\))775
911 y({)865 993 y(output)f(=)i(\(char)f(*\))g(trivsql_xrealloc)f
(\(output,)g(size\);)865 1075 y(result)g(=)i(vsnprintf)e(\(output,)h
(size,)g(format,)f(ap\);)865 1240 y(if)h(\(result)g(==)g(-1\))954
1322 y({)1044 1404 y(/*)g(Up)h(to)f(glibc)g(2.0.6)g(and)h(Microsoft's)e
(implementation)f(*/)1044 1486 y(size)i(+=)g(100;)954
1569 y(})865 1651 y(else)954 1733 y({)1044 1815 y(/*)g(Check)g(if)h(we)
f(are)h(done)f(*/)1044 1897 y(if)g(\(result)g Fa(<)h
Fe(size\))1133 1979 y(break;)1044 2144 y(/*)f(Glibc)g(from)g(now)h(on)f
(*/)1044 2226 y(size)g(=)h(result)e(+)i(1;)954 2308 y(})775
2390 y(})685 2555 y(va_end)f(\(ap\);)685 2637 y(return)g(output;)596
2719 y(})596 2884 y(void)596 2966 y(trivsql_xfree)e(\(void)i(*memory\))
596 3048 y({)685 3130 y(if)h(\(memory)e(!=)i(NULL\))775
3212 y(free\(memory\);)596 3295 y(})596 3459 y(void)f(*)596
3541 y(trivsql_xrealloc)e(\(void)i(*memory,)f(size_t)h(size\))596
3623 y({)685 3706 y(void)g(*buffer;)685 3870 y(if)h(\(\(buffer)e(=)i
(realloc)e(\(memory,)h(size\)\))g(==)g(NULL\))775 3952
y({)865 4034 y(fprintf\(stderr,)e("Realloc)h(of)i(memory)f(failed"\);)
865 4116 y(exit\(42\);)775 4199 y(})685 4363 y(return)g(buffer;)596
4445 y(})596 4610 y(int)g(*trivsql_parsecols\(char)d(*tname,)i(char)i
(*cols,)e(int)i(*numCols\){)685 4692 y(int)g(i,)f(col;)685
4774 y(int)h(*colNumbers)d(=)j(NULL;)685 4856 y(char)f(*t,)h(*u,)f
(*coltmp,)f(*c;)685 5021 y(//)i(How)f(many)g(columns)g(do)g(we)h(have?)
685 5103 y(*numCols)f(=)g(1;)685 5185 y(for\(i)g(=)h(0;)f(i)h
Fa(<)g Fe(strlen\(cols\);)d(i++\))775 5267 y(if\(cols[i])h(==)h(';'\))
865 5349 y(\(*numCols\)++;)p Black 3601 5585 a Fd(27)p
Black eop
%%Page: 28 28
28 27 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(coltmp)44 b(=)h(trivsql_xsnprintf\("\045s",)c
(cols\);)685 171 y(colNumbers)i(=)i(trivsql_xmalloc\(sizeof\(int\))40
b(*)45 b(\(*numCols\)\);)685 336 y(//)g(Determine)e(that)h(the)g(named)
g(columns)g(exist)685 418 y(col)h(=)f(0;)685 500 y(c)h(=)g
(strtok\(coltmp,)d(";"\);)685 582 y(while\(c)i(!=)g(NULL\){)775
664 y(i)h(=)f(0;)775 747 y(while\(1\){)865 829 y(t)g(=)h
(trivsql_xsnprintf\("trivsql_\045s_col\045d",)38 b(tname,)44
b(i\);)865 911 y(u)g(=)h(trivsql_dbread\(gState,)c(t\);)865
1075 y(if\(u)j(==)g(NULL\){)640 1158 y(trivsql_xfree\(t\);)640
1240 y(//)h(todo_mikal:)e(this)h(make)g(break)g(if)h(used)f(during)g(a)
g(selection...)640 1322 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p
Fe(errno)e(=)j(TRIVSQL_NOSUCHCOLUMN;)640 1404 y(gState-)p
Fa(>)p Fe(rs-)p Fa(>)p Fe(errstring)c(=)k(trivsql_xsnprintf\("The)c
(column)j(\\"\045s\\")g(does)g(not)g(ex-)596 1486 y(ist)g(in)g(the)h
(table)f(\\"\045s\\")f(\(search)h(inset)g(is)h(\045d\).",)e(c,)i
(tname,)f(i\);)640 1569 y(return)g(NULL;)865 1651 y(})865
1733 y(else)g(if\(strcmp\(u,)e(c\))j(==)f(0\){)640 1815
y(trivsql_xfree\(t\);)640 1897 y(trivsql_xfree\(u\);)640
1979 y(break;)865 2062 y(})865 2226 y(trivsql_xfree\(t\);)865
2308 y(trivsql_xfree\(u\);)865 2390 y(i++;)775 2473 y(})775
2637 y(colNumbers[col])e(=)j(i;)775 2719 y(c)g(=)f(strtok\(NULL,)f
(";"\);)775 2801 y(col++;)685 2884 y(})685 3048 y(return)h(colNumbers;)
596 3130 y(})596 3295 y(int)g(trivsql_findcol\(char)d(*tname,)j(char)g
(*cols,)g(char)g(*col\){)685 3377 y(char)g(*t,)h(*u,)f(*coltmp,)f(*c;)
685 3459 y(int)i(colNum;)685 3623 y(coltmp)f(=)h
(trivsql_xsnprintf\("\045s",)c(cols\);)685 3706 y(colNum)j(=)h(0;)685
3870 y(//)g(Determine)e(that)h(the)g(named)g(columns)g(exist)685
3952 y(c)h(=)g(strtok\(coltmp,)d(";"\);)685 4034 y(while\(c)i(!=)g
(NULL\){)775 4116 y(if\(strcmp\(c,)f(col\))h(==)g(0\))865
4199 y(return)f(colNum;)775 4363 y(c)i(=)f(strtok\(NULL,)f(";"\);)775
4445 y(colNum++;)685 4527 y(})685 4692 y(return)h(-1;)596
4774 y(})596 4938 y(int)g(trivsql_getrowcount\(char)d(*tname\){)685
5021 y(char)j(*t,)h(*u;)685 5103 y(int)g(rowCount;)685
5267 y(//)g(Determine)e(if)h(the)h(table)f(exists,)f(and)i(if)f(so)h
(how)f(many)g(rows)g(it)h(has)685 5349 y(t)g(=)g
(trivsql_xsnprintf\("trivsql_\045s_numrow)o(s",)39 b(tname\);)685
5432 y(u)45 b(=)g(trivsql_dbread\(gState,)c(t\);)p Black
197 5585 a Fd(28)p Black eop
%%Page: 29 29
29 28 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 171 a Fe(if\(u)44 b(==)h(NULL\){)775 253 y(gState-)p
Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)d(=)i(TRIVSQL_NOSUCHTABLE;)775
336 y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errstring)d(=)k
(trivsql_xsnprintf\("Could)40 b(not)45 b(determine)e(the)h(row)h(count)
f(for)g(the)g(ta-)596 418 y(ble)g(\\"\045s\\")g(because)f(the)i(table)f
(does)g(not)g(exist",)g(tname\);)775 500 y(return)g(-1;)685
582 y(})685 747 y(rowCount)g(=)g(atoi\(u\);)685 829 y
(trivsql_xfree\(u\);)685 911 y(trivsql_xfree\(t\);)685
1075 y(return)g(rowCount;)596 1158 y(})596 1322 y(void)g
(trivsql_addrow\(trivsql_recordset)39 b(*rs,)44 b(char)g(*tname,)g(int)
g(row,)h(int)f(*cols\){)685 1404 y(char)g(*t;)685 1486
y(int)h(colCount;)685 1569 y(trivsql_row)e(*theRow;)685
1651 y(trivsql_col)g(*theCol;)685 1815 y(//)i(Make)f(space)g(for)g(the)
g(new)h(row)685 1897 y(rs-)p Fa(>)p Fe(numRows++;)685
1979 y(theRow)f(=)h(rs-)p Fa(>)p Fe(rows;)685 2062 y(while\(theRow-)p
Fa(>)p Fe(next)d(!=)i(NULL\))775 2144 y(theRow)g(=)g(theRow-)p
Fa(>)p Fe(next;)685 2308 y(theRow-)p Fa(>)p Fe(next)f(=)i
(trivsql_xmalloc\(sizeof\(trivsql_row\)\);)685 2390 y(theRow-)p
Fa(>)p Fe(next-)p Fa(>)p Fe(next)d(=)i(NULL;)685 2555
y(theRow-)p Fa(>)p Fe(cols)f(=)i
(trivsql_xmalloc\(sizeof\(trivsql_col\)\);)685 2637 y(theRow-)p
Fa(>)p Fe(cols-)p Fa(>)p Fe(next)d(=)i(NULL;)685 2719
y(theCol)g(=)h(theRow-)p Fa(>)p Fe(cols;)685 2884 y(//)g(Get)f(the)g
(row)685 2966 y(for\(colCount)f(=)i(0;)f(colCount)g Fa(<)g
Fe(rs-)p Fa(>)p Fe(numCols;)f(colCount++\){)775 3048
y(t)i(=)f(trivsql_xsnprintf\("trivsql_\045s_col\045drow\045d)o(",)39
b(tname,)44 b(cols[colCount],)e(row\);)775 3212 y(theCol-)p
Fa(>)p Fe(val)h(=)h(trivsql_dbread\(gState,)e(t\);)775
3295 y(theCol-)p Fa(>)p Fe(key)h(=)h(t;)775 3377 y(theCol-)p
Fa(>)p Fe(next)f(=)h(trivsql_xmalloc\(sizeof\(trivsql_col\)\);)775
3459 y(theCol-)p Fa(>)p Fe(next-)p Fa(>)p Fe(next)d(=)k(NULL;)775
3541 y(theCol)f(=)g(theCol-)p Fa(>)p Fe(next;)685 3623
y(})596 3706 y(})596 3870 y(char)g(*trivsql_getallcolumns\(char)c
(*tname\))596 3952 y({)685 4034 y(char)k(*t,)h(*u,)f(*retVal,)f
(*retVal2;)685 4116 y(int)i(i,)f(maxCols;)685 4281 y(t)h(=)g
(trivsql_xsnprintf\("trivsql_\045s_numcol)o(s",)39 b(tname\);)685
4363 y(u)45 b(=)g(trivsql_dbread\(gState,)c(t\);)685
4445 y(if\(u)j(==)h(NULL\))f(maxCols)f(=)i(0;)685 4527
y(else)f(maxCols)g(=)h(atoi\(u\);)685 4610 y(trivsql_xfree\(t\);)685
4692 y(trivsql_xfree\(u\);)685 4856 y(retVal)f(=)h
(trivsql_xsnprintf\(""\);)685 5021 y(for\(i)f(=)h(0;)f(i)h
Fa(<)g Fe(maxCols;)e(i++\){)865 5103 y(t)h(=)h
(trivsql_xsnprintf\("trivsql_\045s_col\045d",)38 b(tname,)44
b(i\);)865 5185 y(u)g(=)h(trivsql_dbread\(gState,)c(t\);)865
5349 y(if\(strcmp\(retVal,)g(""\))k(!=)f(0\))640 5432
y(retVal2)g(=)h(trivsql_xsnprintf\("\045s;\045s",)40
b(retVal,)k(u\);)p Black 3601 5585 a Fd(29)p Black eop
%%Page: 30 30
30 29 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 865 89 a Fe(else)640 171 y(retVal2)44 b(=)h
(trivsql_xsnprintf\("\045s",)c(u\);)865 336 y(trivsql_xfree\(t\);)865
418 y(trivsql_xfree\(u\);)865 500 y(trivsql_xfree\(retVal\);)865
582 y(retVal)i(=)i(retVal2;)685 664 y(})685 829 y(return)f(retVal;)596
911 y(})596 1075 y(int)g(trivsql_min\(int)e(a,)j(int)f(b\){)685
1158 y(if\(a)g Fa(>)h Fe(b\))f(return)g(b;)685 1240 y(return)g(a;)596
1322 y(})596 1486 y(void)g(trivsql_checktable\(char)d(*tname,)i
(trivsql_recordset)f(*rs\){)685 1569 y(char)i(*t,)h(*u;)685
1733 y(t)g(=)g(trivsql_xsnprintf\("trivsql_\045s_numrow)o(s",)39
b(tname\);)685 1815 y(u)45 b(=)g(trivsql_dbread\(gState,)c(t\);)685
1897 y(trivsql_xfree\(t\);)685 2062 y(if\(u)j(==)h(NULL\){)775
2144 y(\(*rs\).errno)e(=)h(TRIVSQL_NOSUCHTABLE;)775 2226
y(\(*rs\).errstring)e(=)j(trivsql_xsnprintf\("Existance)40
b(check)k(for)g(the)h(table)f(\\"\045s\\")f(de-)596 2308
y(termined)g(that)h(the)g(table)g(does)h(not)f(exist.",)f(tname\);)685
2390 y(})596 2473 y(})596 2637 y(trivsql_recordset*)e
(trivsql_makers\(char)h(*tname\){)685 2719 y(trivsql_recordset)g(*rrs;)
685 2884 y(//)j(Build)f(the)g(recordset)685 2966 y(rrs)h(=)f
(trivsql_xmalloc\(sizeof\(trivsql_recordset)o(\)\);)685
3048 y(rrs-)p Fa(>)p Fe(rows)f(=)i
(trivsql_xmalloc\(sizeof\(trivsql_row\)\);)685 3130 y(rrs-)p
Fa(>)p Fe(rows-)p Fa(>)p Fe(next)d(=)j(NULL;)685 3212
y(rrs-)p Fa(>)p Fe(rows-)p Fa(>)p Fe(cols)d(=)j(NULL;)685
3295 y(rrs-)p Fa(>)p Fe(numCols)e(=)i(0;)685 3377 y(rrs-)p
Fa(>)p Fe(numRows)e(=)i(0;)685 3459 y(rrs-)p Fa(>)p Fe(tname)e(=)i
(trivsql_xsnprintf\("\045s",)c(tname\);)685 3541 y(rrs-)p
Fa(>)p Fe(currentRow)h(=)j(rrs-)p Fa(>)p Fe(rows;)685
3623 y(rrs-)p Fa(>)p Fe(errno)e(=)i(TRIVSQL_FALSE;)685
3706 y(rrs-)p Fa(>)p Fe(errstring)e(=)h(NULL;)685 3788
y(rrs-)p Fa(>)p Fe(cols)f(=)i(NULL;)685 3952 y(if\(gState-)p
Fa(>)p Fe(db)e(==)h(NULL\){)775 4034 y(rrs-)p Fa(>)p
Fe(errno)f(=)i(TRIVSQL_DBOPENFAIL;)685 4116 y(})685 4281
y(return)f(rrs;)596 4363 y(})596 4527 y(trivsql_seltreenode*)d
(trivsql_makest\(\){)685 4610 y(trivsql_seltreenode)h(*rst;)685
4774 y(//)j(Build)f(the)g(recordset)685 4856 y(rst)h(=)f
(trivsql_xmalloc\(sizeof\(trivsql_seltreeno)o(de\)\);)685
4938 y(rst-)p Fa(>)p Fe(selArgOne)f(=)h(NULL;)685 5021
y(rst-)p Fa(>)p Fe(selColOne)f(=)h(-1;)685 5103 y(rst-)p
Fa(>)p Fe(selArgTwo)f(=)h(NULL;)685 5185 y(rst-)p Fa(>)p
Fe(selColTwo)f(=)h(-1;)685 5267 y(rst-)p Fa(>)p Fe(selector)f(=)h
(NULL;)685 5349 y(rst-)p Fa(>)p Fe(left)f(=)i(NULL;)685
5432 y(rst-)p Fa(>)p Fe(right)e(=)i(NULL;)p Black 197
5585 a Fd(30)p Black eop
%%Page: 31 31
31 30 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 171 a Fe(return)44 b(rst;)596 253 y(})596 418
y(trivsql_seltreenode*)d(trivsql_makesel\(trivsql_selectorfunc)e(func,)
44 b(char)g(*a1,)999 500 y(char)g(*a2\){)685 582 y(int)h(*colNumbers,)d
(numCols;)685 747 y(trivsql_seltreenode)g(*tst)i(=)h
(trivsql_makest\(\);)685 829 y(tst-)p Fa(>)p Fe(selector)e(=)h(func;)
685 993 y(if\(\(colNumbers)f(=)h(trivsql_parsecols\(gState-)p
Fa(>)p Fe(table,)c(a1,)k(&numCols\)\))f(==)i(NULL\){)865
1075 y(tst-)p Fa(>)p Fe(selArgOne)d(=)j(a1;)865 1158
y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)c(=)k(TRIVSQL_FALSE;)685
1240 y(})685 1322 y(else{)865 1404 y(tst-)p Fa(>)p Fe(selColOne)d(=)j
(colNumbers[0];)685 1486 y(})685 1569 y(trivsql_xfree\(colNumbers\);)
685 1733 y(if\(\(colNumbers)e(=)h(trivsql_parsecols\(gState-)p
Fa(>)p Fe(table,)c(a2,)k(&numCols\)\))f(==)i(NULL\){)865
1815 y(tst-)p Fa(>)p Fe(selArgTwo)d(=)j(a2;)865 1897
y(gState-)p Fa(>)p Fe(rs-)p Fa(>)p Fe(errno)c(=)k(TRIVSQL_FALSE;)685
1979 y(})685 2062 y(else{)865 2144 y(tst-)p Fa(>)p Fe(selColTwo)d(=)j
(colNumbers[0];)685 2226 y(})685 2308 y(trivsql_xfree\(colNumbers\);)
685 2473 y(return)f(tst;)596 2555 y(})596 2719 y(trivsql_seltreenode*)d
(trivsql_makeslr\(trivsql_selectorfunc)e(func,)999 2801
y(trivsql_seltreenode)j(*left,)999 2884 y(trivsql_seltreenode)g
(*right\){)685 2966 y(trivsql_seltreenode*)g(tst)i(=)h
(trivsql_makest\(\);)685 3048 y(tst-)p Fa(>)p Fe(selector)e(=)h(func;)
685 3130 y(tst-)p Fa(>)p Fe(left)f(=)i(left;)685 3212
y(tst-)p Fa(>)p Fe(right)e(=)i(right;)596 3295 y(})596
3459 y(int)f(trivsql_executeselector\(trivsql_seltre)o(enode*)38
b(node,)44 b(int)h(row\){)685 3541 y(char)f(*a1,)g(*a2,)h(*t;)685
3706 y(if\(node)f(==)g(NULL\))775 3788 y(return)g(SELTRUE;)685
3952 y(if\(\(\(node-)p Fa(>)p Fe(selArgOne)e(!=)i(NULL\))g(||)h
(\(node-)p Fa(>)p Fe(selColOne)d(!=)i(-1\)\))g(&&)820
4034 y(\(\(node-)p Fa(>)p Fe(selArgTwo)e(!=)i(NULL\))g(||)h(\(node-)p
Fa(>)p Fe(selColTwo)d(!=)i(-1\)\)\){)775 4116 y(if\(node-)p
Fa(>)p Fe(selColOne)e(==)i(-1\))865 4199 y(a1)g(=)h(node-)p
Fa(>)p Fe(selArgOne;)775 4281 y(else{)865 4363 y(t)f(=)h
(trivsql_xsnprintf\("trivsql_\045s_col\045drow)o(\045d",)39
b(gState-)p Fa(>)p Fe(table,)909 4445 y(node-)p Fa(>)p
Fe(selColOne,)j(row\);)865 4527 y(a1)i(=)h(trivsql_dbread\(gState,)c
(t\);)865 4610 y(trivsql_xfree\(t\);)865 4774 y(if\(a1)i(==)i(NULL\))
640 4856 y(return)f(SELFALSE;)775 4938 y(})775 5103 y(if\(node-)p
Fa(>)p Fe(selColTwo)e(==)i(-1\))865 5185 y(a2)g(=)h(node-)p
Fa(>)p Fe(selArgTwo;)775 5267 y(else{)865 5349 y(t)f(=)h
(trivsql_xsnprintf\("trivsql_\045s_col\045drow)o(\045d",)39
b(gState-)p Fa(>)p Fe(table,)909 5432 y(node-)p Fa(>)p
Fe(selColTwo,)j(row\);)p Black 3601 5585 a Fd(31)p Black
eop
%%Page: 32 32
32 31 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 865 89 a Fe(a2)44 b(=)h(trivsql_dbread\(gState,)c(t\);)865
171 y(trivsql_xfree\(t\);)865 336 y(if\(a2)i(==)i(NULL\))640
418 y(return)f(SELFALSE;)775 500 y(})775 664 y(return)g(\(node-)p
Fa(>)p Fe(selector\)\(a1,)d(a2\);)685 747 y(})685 911
y(return)j(\(node-)p Fa(>)p Fe(selector\)\(trivsql_executeselecto)o
(r\(node)o(-)p Fa(>)p Fe(lef)o(t,)39 b(row\),)820 993
y(trivsql_executeselector\(node-)p Fa(>)p Fe(right,)f(row\)\);)596
1075 y(})596 1240 y(int)44 b(trivsql_initok\(trivsql_state)c(*state\){)
685 1322 y(if\(state-)p Fa(>)p Fe(db)j(==)h(NULL\))775
1404 y(return)g(TRIVSQL_FALSE;)685 1486 y(return)g(TRIVSQL_TRUE;)596
1569 y(})596 1743 y Fd(Code:)20 b(/home/mikal/opensour)o
(ce/trivsql/internal.c)596 1908 y Fe(#include)43 b("trivsql.h")596
1990 y(#include)g Fa(<)p Fe(string.h)p Fa(>)596 2155
y Fe(int)h(trivsql_selequal\(char)d(*arg1,)j(char)g(*arg2\){)685
2237 y(if\(strcmp\(arg1,)e(arg2\))i(==)h(0\))f(return)g(SELTRUE;)685
2319 y(return)g(SELFALSE;)596 2401 y(})596 2566 y(//)g(todo:)g
(implement)f(\045's)596 2648 y(int)h(trivsql_sellike\(char)d(*arg1,)j
(char)g(*arg2\){)685 2730 y(int)h(front)e(=)i(0,)g(back)f(=)g(0,)h
(ret;)685 2812 y(char)f(*sel,)g(*str;)685 2977 y(sel)h(=)f
(strdup\(arg2\);)685 3141 y(if\(arg2[0])f(==)i('\045'\){)775
3223 y(front)f(=)g(1;)775 3305 y(sel++;)685 3388 y(})685
3552 y(if\(arg2[strlen\(arg2\))e(-)i(1])h(==)f('\045'\){)775
3634 y(back)g(=)h(1;)775 3716 y(sel[strlen\(sel\))d(-)j(1])f(=)h
('\\0';)685 3799 y(})685 3963 y(printf\("\045d)e(\045d)i
(\(\045s\)\\n",)e(front,)h(back,)g(sel\);)685 4127 y(if\(\(str)g(=)g
(strstr\(arg1,)f(sel\)\))h(!=)h(NULL\){)775 4209 y(if\(\(front)e(==)i
(1\))f(&&)h(\(str)f(==)g(arg1\)\))865 4292 y(ret)g(=)g(SELFALSE;)775
4374 y(else)865 4456 y(ret)g(=)g(SELTRUE;)685 4538 y(})685
4620 y(else)g(ret)h(=)f(SELFALSE;)685 4785 y(//trivsql_xfree\(sel\);)
685 4867 y(return)g(ret;)596 4949 y(})596 5114 y(int)g
(trivsql_selor\(int)e(left,)i(int)g(right\){)685 5196
y(if\(left)g(==)g(SELTRUE\))g(return)g(SELTRUE;)685 5278
y(if\(right)g(==)g(SELTRUE\))g(return)f(SELTRUE;)685
5360 y(return)h(SELFALSE;)596 5442 y(})p Black 197 5585
a Fd(32)p Black eop
%%Page: 33 33
33 32 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(int)44 b(trivsql_seland\(int)e(left,)i(int)g
(right\){)685 253 y(if\(left)g(==)g(SELFALSE\))g(return)f(SELFALSE;)685
336 y(if\(right)h(==)g(SELFALSE\))f(return)h(SELFALSE;)685
418 y(return)g(SELTRUE;)596 500 y(})596 674 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/selectors.c)596 840
y Fe(/*)730 922 y(Unix)44 b(SMB/Netbios)f(implementation.)730
1004 y(Version)h(3.0)730 1086 y(Samba)g(database)f(functions)730
1168 y(Copyright)g(\(C\))i(Anton)f(Blanchard)850 b(2001)730
1333 y(This)44 b(program)g(is)g(free)g(software;)g(you)g(can)g
(redistribute)f(it)i(and/or)f(modify)730 1415 y(it)h(under)e(the)i
(terms)f(of)g(the)h(GNU)f(General)g(Public)f(License)h(as)h(published)e
(by)730 1497 y(the)h(Free)g(Software)g(Foundation;)f(either)h(version)f
(2)i(of)g(the)f(License,)f(or)730 1579 y(\(at)h(your)g(option\))g(any)g
(later)g(version.)730 1744 y(This)g(program)g(is)g(distributed)f(in)i
(the)f(hope)g(that)g(it)h(will)f(be)h(useful,)730 1826
y(but)f(WITHOUT)g(ANY)g(WARRANTY;)g(without)f(even)h(the)h(implied)e
(warranty)h(of)730 1908 y(MERCHANTABILITY)e(or)j(FITNESS)e(FOR)i(A)f
(PARTICULAR)g(PURPOSE.)88 b(See)44 b(the)730 1990 y(GNU)g(General)g
(Public)g(License)f(for)i(more)f(details.)730 2155 y(You)g(should)g
(have)g(received)g(a)g(copy)h(of)f(the)g(GNU)h(General)e(Public)h
(License)730 2237 y(along)g(with)g(this)g(program;)g(if)g(not,)g(write)
g(to)h(the)f(Free)g(Software)730 2319 y(Foundation,)f(Inc.,)h(675)g
(Mass)g(Ave,)h(Cambridge,)e(MA)h(02139,)g(USA.)596 2401
y(*/)596 2483 y(#if)g(HAVE_CONFIG_H)596 2566 y(#include)f
Fa(<)p Fe(config.h)p Fa(>)596 2648 y Fe(#endif)596 2812
y(#include)g Fa(<)p Fe(stdlib.h)p Fa(>)596 2894 y Fe(#include)g
Fa(<)p Fe(stdio.h)p Fa(>)596 2977 y Fe(#include)g Fa(<)p
Fe(unistd.h)p Fa(>)596 3059 y Fe(#include)g Fa(<)p Fe(string.h)p
Fa(>)596 3141 y Fe(#include)g Fa(<)p Fe(fcntl.h)p Fa(>)596
3223 y Fe(#include)g Fa(<)p Fe(errno.h)p Fa(>)596 3305
y Fe(#include)g Fa(<)p Fe(sys/stat.h)p Fa(>)596 3388
y Fe(#include)g Fa(<)p Fe(time.h)p Fa(>)596 3470 y Fe(#include)g
("tdb.h")596 3552 y(#include)g("spinlock.h")596 3716
y(#define)g(DEBUG)596 3881 y(#ifdef)g(USE_SPINLOCKS)596
4045 y(/*)640 4127 y(*)i(ARCH)f(SPECIFIC)640 4209 y(*/)596
4374 y(#if)g(defined\(SPARC_SPINLOCKS\))596 4538 y(static)f(inline)h
(int)g(__spin_trylock\(spinlock_t)d(*lock\))596 4620
y({)640 4703 y(unsigned)j(int)g(result;)640 4867 y(asm)h
(volatile\("ldstub)176 b([\0451],)44 b(\0450")685 4949
y(:)h("=r")f(\(result\))685 5031 y(:)h("r")f(\(lock\))685
5114 y(:)h("memory"\);)640 5278 y(return)f(\(result)g(==)g(0\))h(?)f(0)
h(:)g(EBUSY;)596 5360 y(})p Black 3601 5585 a Fd(33)p
Black eop
%%Page: 34 34
34 33 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(static)43 b(inline)h(void)g
(__spin_unlock\(spinlock_t)d(*lock\))596 171 y({)640
253 y(asm)k(volatile\("":::"memory"\);)640 336 y(*lock)f(=)h(0;)596
418 y(})596 582 y(static)e(inline)h(void)g
(__spin_lock_init\(spinlock_t)d(*lock\))596 664 y({)640
747 y(*lock)j(=)h(0;)596 829 y(})596 993 y(static)e(inline)h(int)g
(__spin_is_locked\(spinlock_t)d(*lock\))596 1075 y({)640
1158 y(return)j(\(*lock)g(!=)g(0\);)596 1240 y(})596
1404 y(#elif)g(defined\(POWERPC_SPINLOCKS\))596 1569
y(static)f(inline)h(int)g(__spin_trylock\(spinlock_t)d(*lock\))596
1651 y({)640 1733 y(unsigned)j(int)g(result;)640 1897
y(__asm__)g(__volatile__\()596 1979 y("1:)g(lwarx)89
b(\0450,0,\0451\\n\\)640 2062 y(cmpwi)g(0,\0450,0\\n\\)640
2144 y(li)h(\0450,0\\n\\)640 2226 y(bne-)f(2f\\n\\)640
2308 y(li)h(\0450,1\\n\\)640 2390 y(stwcx.)f(\0450,0,\0451\\n\\)640
2473 y(bne-)g(1b\\n\\)640 2555 y(isync\\n\\)596 2637
y(2:")44 b(:)h("=&r"\(result\))640 2719 y(:)g("r"\(lock\))640
2801 y(:)g("cr0",)f("memory"\);)640 2966 y(return)g(\(result)g(==)g
(1\))h(?)f(0)h(:)g(EBUSY;)596 3048 y(})596 3212 y(static)e(inline)h
(void)g(__spin_unlock\(spinlock_t)d(*lock\))596 3295
y({)640 3377 y(asm)k(volatile\("eieio":::"memory"\);)640
3459 y(*lock)f(=)h(0;)596 3541 y(})596 3706 y(static)e(inline)h(void)g
(__spin_lock_init\(spinlock_t)d(*lock\))596 3788 y({)640
3870 y(*lock)j(=)h(0;)596 3952 y(})596 4116 y(static)e(inline)h(int)g
(__spin_is_locked\(spinlock_t)d(*lock\))596 4199 y({)640
4281 y(return)j(\(*lock)g(!=)g(0\);)596 4363 y(})596
4527 y(#elif)g(defined\(INTEL_SPINLOCKS\))596 4692 y(static)f(inline)h
(int)g(__spin_trylock\(spinlock_t)d(*lock\))596 4774
y({)640 4856 y(int)k(oldval;)640 5021 y(asm)g(volatile\("xchgl)d
(\0450,\0451")685 5103 y(:)j("=r")f(\(oldval\),)f("=m")h(\(*lock\))685
5185 y(:)h("0")f(\(0\))685 5267 y(:)h("memory"\);)640
5432 y(return)f(oldval)g Fa(>)h Fe(0)f(?)h(0)g(:)f(EBUSY;)p
Black 197 5585 a Fd(34)p Black eop
%%Page: 35 35
35 34 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(})596 253 y(static)43 b(inline)h(void)g
(__spin_unlock\(spinlock_t)d(*lock\))596 336 y({)640
418 y(asm)k(volatile\("":::"memory"\);)640 500 y(*lock)f(=)h(1;)596
582 y(})596 747 y(static)e(inline)h(void)g
(__spin_lock_init\(spinlock_t)d(*lock\))596 829 y({)640
911 y(*lock)j(=)h(1;)596 993 y(})596 1158 y(static)e(inline)h(int)g
(__spin_is_locked\(spinlock_t)d(*lock\))596 1240 y({)640
1322 y(return)j(\(*lock)g(!=)g(1\);)596 1404 y(})596
1569 y(#elif)g(defined\(MIPS_SPINLOCKS\))596 1733 y(static)f(inline)h
(unsigned)g(int)g(load_linked\(unsigned)d(long)k(addr\))596
1815 y({)640 1897 y(unsigned)f(int)g(res;)640 2062 y(__asm__)g
(__volatile__\("ll\\t\0450,\(\0451\)")685 2144 y(:)h("=r")f(\(res\))685
2226 y(:)h("r")f(\(addr\)\);)640 2390 y(return)g(res;)596
2473 y(})596 2637 y(static)f(inline)h(unsigned)g(int)g
(store_conditional\(unsigned)c(long)45 b(addr,)f(unsigned)f(int)h
(value\))596 2719 y({)640 2801 y(unsigned)g(int)g(res;)640
2966 y(__asm__)g(__volatile__\("sc\\t\0450,\(\0452\)")685
3048 y(:)h("=r")f(\(res\))685 3130 y(:)h("0")f(\(value\),)g("r")g
(\(addr\)\);)640 3212 y(return)g(res;)596 3295 y(})596
3459 y(static)f(inline)h(int)g(__spin_trylock\(spinlock_t)d(*lock\))596
3541 y({)640 3623 y(unsigned)j(int)g(mw;)640 3788 y(do)h({)685
3870 y(mw)g(=)f(load_linked\(lock\);)685 3952 y(if)h(\(mw\))730
4034 y(return)f(EBUSY;)640 4116 y(})h(while)f
(\(!store_conditional\(lock,)d(1\)\);)640 4281 y(asm)k
(volatile\("":::"memory"\);)640 4445 y(return)f(0;)596
4527 y(})596 4692 y(static)f(inline)h(void)g(__spin_unlock\(spinlock_t)
d(*lock\))596 4774 y({)640 4856 y(asm)k(volatile\("":::"memory"\);)640
4938 y(*lock)f(=)h(0;)596 5021 y(})596 5185 y(static)e(inline)h(void)g
(__spin_lock_init\(spinlock_t)d(*lock\))596 5267 y({)640
5349 y(*lock)j(=)h(0;)596 5432 y(})p Black 3601 5585
a Fd(35)p Black eop
%%Page: 36 36
36 35 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(static)43 b(inline)h(int)g
(__spin_is_locked\(spinlock_t)d(*lock\))596 253 y({)640
336 y(return)j(\(*lock)g(!=)g(0\);)596 418 y(})596 582
y(#else)596 664 y(#error)f(Need)h(to)h(implement)e(spinlock)h(code)g
(in)g(spinlock.c)596 747 y(#endif)596 911 y(/*)640 993
y(*)h(OS)g(SPECIFIC)640 1075 y(*/)596 1240 y(static)e(void)h
(yield_cpu\(void\))596 1322 y({)640 1404 y(struct)g(timespec)g(tm;)596
1569 y(#ifdef)f(USE_SCHED_YIELD)640 1651 y(sched_yield\(\);)596
1733 y(#else)640 1815 y(/*)i(Linux)f(will)g(busy)g(loop)g(for)h(delays)
e Fa(<)i Fe(2ms)f(on)h(real)f(time)g(tasks)g(*/)640 1897
y(tm.tv_sec)g(=)g(0;)640 1979 y(tm.tv_nsec)f(=)i(2000000L)f(+)g(1;)640
2062 y(nanosleep\(&tm,)f(NULL\);)596 2144 y(#endif)596
2226 y(})596 2390 y(static)g(int)i(this_is_smp\(void\))596
2473 y({)640 2555 y(return)f(0;)596 2637 y(})596 2801
y(/*)640 2884 y(*)h(GENERIC)640 2966 y(*/)596 3130 y(static)e(int)i
(smp_machine)e(=)h(0;)596 3295 y(static)f(inline)h(void)g
(__spin_lock\(spinlock_t)d(*lock\))596 3377 y({)640 3459
y(int)k(ntries)e(=)i(0;)640 3623 y(while\(__spin_trylock\(lock\)\))c({)
685 3706 y(while\(__spin_is_locked\(lock\)\))f({)730
3788 y(if)45 b(\(smp_machine)d(&&)j(ntries++)e Fa(<)i
Fe(MAX_BUSY_LOOPS\))775 3870 y(continue;)730 3952 y(yield_cpu\(\);)685
4034 y(})640 4116 y(})596 4199 y(})596 4363 y(static)e(void)h
(__read_lock\(tdb_rwlock_t)d(*rwlock\))596 4445 y({)640
4527 y(int)k(ntries)e(=)i(0;)640 4692 y(while\(1\))f({)685
4774 y(__spin_lock\(&rwlock-)p Fa(>)p Fe(lock\);)685
4938 y(if)h(\(!\(rwlock-)p Fa(>)p Fe(count)d(&)i(RWLOCK_BIAS\)\))f({)
730 5021 y(rwlock-)p Fa(>)p Fe(count++;)730 5103 y
(__spin_unlock\(&rwlock-)p Fa(>)p Fe(lock\);)730 5185
y(return;)685 5267 y(})685 5432 y(__spin_unlock\(&rwlock-)p
Fa(>)p Fe(lock\);)p Black 197 5585 a Fd(36)p Black eop
%%Page: 37 37
37 36 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 171 a Fe(while\(rwlock-)p Fa(>)p Fe(count)42
b(&)i(RWLOCK_BIAS\))f({)730 253 y(if)i(\(smp_machine)d(&&)j(ntries++)e
Fa(<)i Fe(MAX_BUSY_LOOPS\))775 336 y(continue;)730 418
y(yield_cpu\(\);)685 500 y(})640 582 y(})596 664 y(})596
829 y(static)e(void)h(__write_lock\(tdb_rwlock_t)d(*rwlock\))596
911 y({)640 993 y(int)k(ntries)e(=)i(0;)640 1158 y(while\(1\))f({)685
1240 y(__spin_lock\(&rwlock-)p Fa(>)p Fe(lock\);)685
1404 y(if)h(\(rwlock-)p Fa(>)p Fe(count)d(==)j(0\))f({)730
1486 y(rwlock-)p Fa(>)p Fe(count)f(|=)h(RWLOCK_BIAS;)730
1569 y(__spin_unlock\(&rwlock-)p Fa(>)p Fe(lock\);)730
1651 y(return;)685 1733 y(})685 1897 y(__spin_unlock\(&rwlock-)p
Fa(>)p Fe(lock\);)685 2062 y(while\(rwlock-)p Fa(>)p
Fe(count)e(!=)i(0\))h({)730 2144 y(if)g(\(smp_machine)d(&&)j(ntries++)e
Fa(<)i Fe(MAX_BUSY_LOOPS\))775 2226 y(continue;)730 2308
y(yield_cpu\(\);)685 2390 y(})640 2473 y(})596 2555 y(})596
2719 y(static)e(void)h(__write_unlock\(tdb_rwlock_t)d(*rwlock\))596
2801 y({)640 2884 y(__spin_lock\(&rwlock-)p Fa(>)p Fe(lock\);)596
3048 y(#ifdef)i(DEBUG)640 3130 y(if)i(\(!\(rwlock-)p
Fa(>)p Fe(count)d(&)j(RWLOCK_BIAS\)\))685 3212 y(fprintf\(stderr,)d
("bug:)i(write_unlock\\n"\);)596 3295 y(#endif)640 3459
y(rwlock-)p Fa(>)p Fe(count)f(&=)h(~RWLOCK_BIAS;)640
3541 y(__spin_unlock\(&rwlock-)p Fa(>)p Fe(lock\);)596
3623 y(})596 3788 y(static)f(void)h(__read_unlock\(tdb_rwlock_t)d
(*rwlock\))596 3870 y({)640 3952 y(__spin_lock\(&rwlock-)p
Fa(>)p Fe(lock\);)596 4116 y(#ifdef)i(DEBUG)640 4199
y(if)i(\(!rwlock-)p Fa(>)p Fe(count\))685 4281 y(fprintf\(stderr,)d
("bug:)i(read_unlock\\n"\);)640 4445 y(if)h(\(rwlock-)p
Fa(>)p Fe(count)d(&)j(RWLOCK_BIAS\))685 4527 y(fprintf\(stderr,)d
("bug:)i(read_unlock\\n"\);)596 4610 y(#endif)640 4774
y(rwlock-)p Fa(>)p Fe(count--;)640 4856 y(__spin_unlock\(&rwlock-)p
Fa(>)p Fe(lock\);)596 4938 y(})596 5103 y(/*)g(TDB)g(SPECIFIC)g(*/)596
5267 y(/*)g(lock)g(a)h(list)f(in)g(the)h(database.)e(list)h(-1)h(is)f
(the)h(alloc)f(list)g(*/)596 5349 y(int)g(tdb_spinlock\(TDB_CONTEXT)d
(*tdb,)j(int)g(list,)g(int)g(rw_type\))596 5432 y({)p
Black 3601 5585 a Fd(37)p Black eop
%%Page: 38 38
38 37 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(tdb_rwlock_t)43 b(*rwlocks;)640 253
y(if)i(\(!tdb-)p Fa(>)p Fe(map_ptr\))d(return)i(-1;)640
336 y(rwlocks)g(=)h(\(tdb_rwlock_t)d(*\)\(\(char)i(*\)tdb-)p
Fa(>)p Fe(map_ptr)e(+)j(tdb-)p Fa(>)p Fe(header.rwlocks\);)640
500 y(switch\(rw_type\))e({)640 582 y(case)i(F_RDLCK:)685
664 y(__read_lock\(&rwlocks[list+1]\);)685 747 y(break;)640
911 y(case)g(F_WRLCK:)685 993 y(__write_lock\(&rwlocks[list+1]\);)685
1075 y(break;)640 1240 y(default:)685 1322 y(return)f
(TDB_ERRCODE\(TDB_ERR_LOCK,)d(-1\);)640 1404 y(})640
1486 y(return)j(0;)596 1569 y(})596 1733 y(/*)g(unlock)g(the)g
(database.)f(*/)596 1815 y(int)h(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k
(int)h(list,)f(int)g(rw_type\))596 1897 y({)640 1979
y(tdb_rwlock_t)f(*rwlocks;)640 2144 y(if)i(\(!tdb-)p
Fa(>)p Fe(map_ptr\))d(return)i(-1;)640 2226 y(rwlocks)g(=)h
(\(tdb_rwlock_t)d(*\)\(\(char)i(*\)tdb-)p Fa(>)p Fe(map_ptr)e(+)j(tdb-)
p Fa(>)p Fe(header.rwlocks\);)640 2390 y(switch\(rw_type\))e({)640
2473 y(case)i(F_RDLCK:)685 2555 y(__read_unlock\(&rwlocks[list+1]\);)
685 2637 y(break;)640 2801 y(case)g(F_WRLCK:)685 2884
y(__write_unlock\(&rwlocks[list+1]\);)685 2966 y(break;)640
3130 y(default:)685 3212 y(return)f(TDB_ERRCODE\(TDB_ERR_LOCK,)d(-1\);)
640 3295 y(})640 3459 y(return)j(0;)596 3541 y(})596
3706 y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g(int)g
(hash_size\))596 3788 y({)640 3870 y(unsigned)g(size,)g(i;)640
3952 y(tdb_rwlock_t)f(*rwlocks;)640 4116 y(size)i(=)f(\(hash_size)f(+)i
(1\))f(*)h(sizeof\(tdb_rwlock_t\);)640 4199 y(rwlocks)f(=)h
(malloc\(size\);)640 4281 y(if)g(\(!rwlocks\))685 4363
y(return)f(-1;)640 4527 y(for\(i)g(=)h(0;)f(i)h Fa(<)g
Fe(hash_size+1;)e(i++\))h({)685 4610 y
(__spin_lock_init\(&rwlocks[i].lock\);)685 4692 y(rwlocks[i].count)e(=)
j(0;)640 4774 y(})640 4938 y(/*)g(Write)f(it)g(out)h(\(appending)e(to)h
(end\))g(*/)640 5021 y(if)h(\(write\(fd,)e(rwlocks,)g(size\))h(!=)h
(size\))f({)685 5103 y(free\(rwlocks\);)685 5185 y(return)g(-1;)640
5267 y(})640 5349 y(smp_machine)f(=)i(this_is_smp\(\);)640
5432 y(free\(rwlocks\);)p Black 197 5585 a Fd(38)p Black
eop
%%Page: 39 39
39 38 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(return)44 b(0;)596 171 y(})596 336
y(int)g(tdb_clear_spinlocks\(TDB_CONTEXT)39 b(*tdb\))596
418 y({)640 500 y(tdb_rwlock_t)k(*rwlocks;)640 582 y(unsigned)h(i;)640
747 y(if)h(\(tdb-)p Fa(>)p Fe(header.rwlocks)c(==)k(0\))f(return)g(0;)
640 829 y(if)h(\(!tdb-)p Fa(>)p Fe(map_ptr\))d(return)i(-1;)640
993 y(/*)h(We're)f(mmapped)f(here)i(*/)640 1075 y(rwlocks)f(=)h
(\(tdb_rwlock_t)d(*\)\(\(char)i(*\)tdb-)p Fa(>)p Fe(map_ptr)e(+)j(tdb-)
p Fa(>)p Fe(header.rwlocks\);)640 1158 y(for\(i)f(=)h(0;)f(i)h
Fa(<)g Fe(tdb-)p Fa(>)p Fe(header.hash_size+1;)40 b(i++\))45
b({)685 1240 y(__spin_lock_init\(&rwlocks[i].lock\);)685
1322 y(rwlocks[i].count)d(=)j(0;)640 1404 y(})640 1486
y(return)f(0;)596 1569 y(})596 1651 y(#else)596 1733
y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g(int)g(hash_size\))f
({)i(return)f(0;)g(})596 1815 y(int)g(tdb_spinlock\(TDB_CONTEXT)d
(*tdb,)j(int)g(list,)g(int)g(rw_type\))g({)g(return)g(-1;)h(})596
1897 y(int)f(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k(int)h(list,)f(int)g
(rw_type\))f({)i(return)f(-)596 1979 y(1;)g(})596 2144
y(/*)g(Non-spinlock)f(version:)g(remove)h(spinlock)g(pointer)f(*/)596
2226 y(int)h(tdb_clear_spinlocks\(TDB_CONTEXT)39 b(*tdb\))596
2308 y({)640 2390 y(tdb_off)44 b(off)g(=)h(\(tdb_off\)\(\(char)d
(*\)&tdb-)p Fa(>)p Fe(header.rwlocks)775 2473 y(-)j(\(char)e(*\)&tdb-)p
Fa(>)p Fe(header\);)640 2637 y(tdb-)p Fa(>)p Fe(header.rwlocks)f(=)j
(0;)640 2719 y(if)g(\(lseek\(tdb-)p Fa(>)p Fe(fd,)d(off,)i(SEEK_SET\))g
(!=)g(off)820 2801 y(||)g(write\(tdb-)p Fa(>)p Fe(fd,)f(\(void)h
(*\)&tdb-)p Fa(>)p Fe(header.rwlocks,)909 2884 y(sizeof\(tdb-)p
Fa(>)p Fe(header.rwlocks\)\))820 2966 y(!=)g(sizeof\(tdb-)p
Fa(>)p Fe(header.rwlocks\)\))685 3048 y(return)g(-1;)640
3130 y(return)g(0;)596 3212 y(})596 3295 y(#endif)596
3469 y Fd(Code:)20 b(/home/mikal/opensour)o(ce/trivsql/spinlock.c)640
3634 y Fe(/*)730 3716 y(Unix)44 b(SMB/Netbios)f(implementation.)730
3799 y(Version)h(3.0)730 3881 y(Samba)g(database)f(functions)730
3963 y(Copyright)g(\(C\))i(Andrew)e(Tridgell)627 b(1999-2000)730
4045 y(Copyright)43 b(\(C\))i(Luke)f(Kenneth)f(Casson)h(Leighton)268
b(2000)730 4127 y(Copyright)43 b(\(C\))i(Paul)f(`Rusty')f(Russell)223
b(2000)730 4209 y(Copyright)43 b(\(C\))i(Jeremy)e(Allison)268
b(2000)730 4374 y(This)44 b(program)g(is)g(free)g(software;)g(you)g
(can)g(redistribute)f(it)i(and/or)f(modify)730 4456 y(it)h(under)e(the)
i(terms)f(of)g(the)h(GNU)f(General)g(Public)f(License)h(as)h(published)
e(by)730 4538 y(the)h(Free)g(Software)g(Foundation;)f(either)h(version)
f(2)i(of)g(the)f(License,)f(or)730 4620 y(\(at)h(your)g(option\))g(any)
g(later)g(version.)730 4785 y(This)g(program)g(is)g(distributed)f(in)i
(the)f(hope)g(that)g(it)h(will)f(be)h(useful,)730 4867
y(but)f(WITHOUT)g(ANY)g(WARRANTY;)g(without)f(even)h(the)h(implied)e
(warranty)h(of)730 4949 y(MERCHANTABILITY)e(or)j(FITNESS)e(FOR)i(A)f
(PARTICULAR)g(PURPOSE.)88 b(See)44 b(the)730 5031 y(GNU)g(General)g
(Public)g(License)f(for)i(more)f(details.)730 5196 y(You)g(should)g
(have)g(received)g(a)g(copy)h(of)f(the)g(GNU)h(General)e(Public)h
(License)730 5278 y(along)g(with)g(this)g(program;)g(if)g(not,)g(write)
g(to)h(the)f(Free)g(Software)730 5360 y(Foundation,)f(Inc.,)h(675)g
(Mass)g(Ave,)h(Cambridge,)e(MA)h(02139,)g(USA.)596 5442
y(*/)p Black 3601 5585 a Fd(39)p Black eop
%%Page: 40 40
40 39 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(#if)44 b(HAVE_CONFIG_H)596 171 y(#include)f
Fa(<)p Fe(config.h)p Fa(>)596 253 y Fe(#endif)596 418
y(#include)g Fa(<)p Fe(stdlib.h)p Fa(>)596 500 y Fe(#include)g
Fa(<)p Fe(stdio.h)p Fa(>)596 582 y Fe(#include)g Fa(<)p
Fe(fcntl.h)p Fa(>)596 664 y Fe(#include)g Fa(<)p Fe(unistd.h)p
Fa(>)596 747 y Fe(#include)g Fa(<)p Fe(string.h)p Fa(>)596
829 y Fe(#include)g Fa(<)p Fe(fcntl.h)p Fa(>)596 911
y Fe(#include)g Fa(<)p Fe(errno.h)p Fa(>)596 993 y Fe(#include)g
Fa(<)p Fe(sys/mman.h)p Fa(>)596 1075 y Fe(#include)g
Fa(<)p Fe(sys/stat.h)p Fa(>)596 1158 y Fe(#include)g("tdb.h")596
1240 y(#include)g("spinlock.h")596 1404 y(#define)g(TDB_MAGIC_FOOD)g
("TDB)h(file\\n")596 1486 y(#define)f(TDB_VERSION)g(\(0x26011967)g(+)i
(6\))596 1569 y(#define)e(TDB_MAGIC)g(\(0x26011999U\))596
1651 y(#define)g(TDB_FREE_MAGIC)g(\(~TDB_MAGIC\))596
1733 y(#define)g(TDB_DEAD_MAGIC)g(\(0xFEE1DEAD\))596
1815 y(#define)g(TDB_ALIGNMENT)g(4)596 1897 y(#define)g(MIN_REC_SIZE)g
(\(2*sizeof\(struct)f(list_struct\))h(+)i(TDB_ALIGNMENT\))596
1979 y(#define)e(DEFAULT_HASH_SIZE)f(131)596 2062 y(#define)h
(TDB_PAGE_SIZE)g(0x2000)596 2144 y(#define)g(FREELIST_TOP)g
(\(sizeof\(struct)f(tdb_header\)\))596 2226 y(#define)h
(TDB_ALIGN\(x,a\))g(\(\(\(x\))h(+)g(\(a\)-1\))g(&)h(~\(\(a\)-1\)\))596
2308 y(#define)e(TDB_BYTEREV\(x\))g(\(\(\(\(\(x\)&0xff\))p
Fa(<<)p Fe(24\)|\(\(x\)&0xFF00\))p Fa(<<)p Fe(8\))o(|\(\(\(x\))o
Fa(>>)p Fe(8\))o(&0xFF0)o(0\)|\(\(x)o(\))p Fa(>>)p Fe(24)o(\)\))596
2390 y(#define)g(TDB_DEAD\(r\))g(\(\(r\)-)p Fa(>)p Fe(magic)g(==)i
(TDB_DEAD_MAGIC\))596 2473 y(#define)e(TDB_BAD_MAGIC\(r\))f(\(\(r\)-)p
Fa(>)p Fe(magic)h(!=)i(TDB_MAGIC)e(&&)i(!TDB_DEAD\(r\)\))596
2555 y(#define)e(TDB_HASH_TOP\(hash\))f(\(FREELIST_TOP)h(+)h
(\(BUCKET\(hash\)+1\)*sizeof\(tdb_off\)\))596 2719 y(/*)g(NB)h(assumes)
e(there)h(is)h(a)f(local)g(variable)g(called)g("tdb")g(that)g(is)g(the)
640 2801 y(*)h(current)f(context,)f(also)h(takes)g
(doubly-parenthesized)e(print-style)640 2884 y(*)j(argument.)e(*/)596
2966 y(#define)g(TDB_LOG\(x\))g(\(tdb-)p Fa(>)p Fe(log_fn?\(\(tdb-)p
Fa(>)p Fe(log_fn)e(x\),0\))j(:)g(0\))596 3130 y(/*)g(lock)g(offsets)g
(*/)596 3212 y(#define)f(GLOBAL_LOCK)g(0)596 3295 y(#define)g
(ACTIVE_LOCK)g(4)596 3459 y(#ifndef)g(MAP_FILE)596 3541
y(#define)g(MAP_FILE)h(0)596 3623 y(#endif)596 3788 y(#ifndef)f
(MAP_FAILED)596 3870 y(#define)g(MAP_FAILED)g(\(\(void)h(*\)-1\))596
3952 y(#endif)596 4116 y(/*)g(free)g(memory)g(if)g(the)h(pointer)e(is)i
(valid)f(and)g(zero)g(the)h(pointer)e(*/)596 4199 y(#ifndef)g
(SAFE_FREE)596 4281 y(#define)g(SAFE_FREE\(x\))g(do)h({)h(if)g(\(\(x\))
f(!=)g(NULL\))g({free\(\(x\)\);)f(\(x\)=NULL;})g(})i(while\(0\))596
4363 y(#endif)596 4527 y(#define)e(BUCKET\(hash\))g(\(\(hash\))h(\045)g
(tdb-)p Fa(>)p Fe(header.hash_size\))596 4610 y(TDB_DATA)f(tdb_null;)
596 4774 y(/*)h(all)g(contexts,)g(to)g(ensure)g(no)g(double-opens)f
(\(fcntl)h(locks)g(don't)g(nest!\))g(*/)596 4856 y(static)f
(TDB_CONTEXT)g(*tdbs)h(=)h(NULL;)596 5021 y(static)e(void)h
(tdb_munmap\(TDB_CONTEXT)e(*tdb\))596 5103 y({)640 5185
y(if)j(\(tdb-)p Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))685
5267 y(return;)596 5432 y(#ifdef)f(HAVE_MMAP)p Black
197 5585 a Fd(40)p Black eop
%%Page: 41 41
41 40 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(if)45 b(\(tdb-)p Fa(>)p Fe(map_ptr\))685
171 y(munmap\(tdb-)p Fa(>)p Fe(map_ptr,)d(tdb-)p Fa(>)p
Fe(map_size\);)596 253 y(#endif)640 336 y(tdb-)p Fa(>)p
Fe(map_ptr)h(=)i(NULL;)596 418 y(})596 582 y(static)e(void)h
(tdb_mmap\(TDB_CONTEXT)e(*tdb\))596 664 y({)640 747 y(if)j(\(tdb-)p
Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))685 829 y(return;)596
993 y(#ifdef)f(HAVE_MMAP)640 1075 y(if)i(\(!\(tdb-)p
Fa(>)p Fe(flags)d(&)j(TDB_NOMMAP\)\))e({)685 1158 y(tdb-)p
Fa(>)p Fe(map_ptr)g(=)i(mmap\(NULL,)e(tdb-)p Fa(>)p Fe(map_size,)954
1240 y(PROT_READ|\(tdb-)p Fa(>)p Fe(read_only?)e(0:PROT_WRITE\),)954
1322 y(MAP_SHARED|MAP_FILE,)h(tdb-)p Fa(>)p Fe(fd,)h(0\);)685
1486 y(/*)730 1569 y(*)i(NB.)f(When)g(mmap)g(fails)g(it)h(returns)e
(MAP_FAILED)h(*NOT*)g(NULL)g(!!!!)730 1651 y(*/)685 1815
y(if)h(\(tdb-)p Fa(>)p Fe(map_ptr)d(==)j(MAP_FAILED\))e({)730
1897 y(tdb-)p Fa(>)p Fe(map_ptr)g(=)h(NULL;)730 1979
y(TDB_LOG\(\(tdb,)f(2,)h("tdb_mmap)f(failed)h(for)h(size)f(\045d)g
(\(\045s\)\\n",)820 2062 y(tdb-)p Fa(>)p Fe(map_size,)e
(strerror\(errno\)\)\);)685 2144 y(})640 2226 y(})j(else)f({)685
2308 y(tdb-)p Fa(>)p Fe(map_ptr)f(=)i(NULL;)640 2390
y(})596 2473 y(#else)640 2555 y(tdb-)p Fa(>)p Fe(map_ptr)e(=)i(NULL;)
596 2637 y(#endif)596 2719 y(})596 2884 y(/*)f(Endian)g(conversion:)f
(we)h(only)g(ever)h(deal)f(with)g(4)h(byte)f(quantities)f(*/)596
2966 y(static)g(void)h(*convert\(void)f(*buf,)h(u32)g(size\))596
3048 y({)640 3130 y(u32)h(i,)f(*p)h(=)f(buf;)640 3212
y(for)h(\(i)f(=)h(0;)f(i)h Fa(<)g Fe(size)f(/)g(4;)h(i++\))685
3295 y(p[i])f(=)h(TDB_BYTEREV\(p[i]\);)640 3377 y(return)f(buf;)596
3459 y(})596 3541 y(#define)f(DOCONV\(\))h(\(tdb-)p Fa(>)p
Fe(flags)f(&)h(TDB_CONVERT\))596 3623 y(#define)f(CONVERT\(x\))g
(\(DOCONV\(\))h(?)g(convert\(&x,)f(sizeof\(x\)\))g(:)i(&x\))596
3788 y(/*)f(the)g(body)g(of)h(the)f(database)g(is)g(made)g(of)h(one)f
(list_struct)f(for)i(the)f(free)g(space)730 3870 y(plus)g(a)h(separate)
e(data)h(list)h(for)f(each)g(hash)g(value)g(*/)596 3952
y(struct)f(list_struct)g({)640 4034 y(tdb_off)h(next;)g(/*)g(offset)g
(of)h(the)f(next)g(record)g(in)h(the)f(list)g(*/)640
4116 y(tdb_len)g(rec_len;)f(/*)i(total)f(byte)g(length)g(of)g(record)g
(*/)640 4199 y(tdb_len)g(key_len;)f(/*)i(byte)f(length)g(of)g(key)h(*/)
640 4281 y(tdb_len)f(data_len;)f(/*)i(byte)f(length)g(of)g(data)g(*/)
640 4363 y(u32)h(full_hash;)e(/*)h(the)h(full)f(32)g(bit)h(hash)f(of)g
(the)h(key)f(*/)640 4445 y(u32)h(magic;)133 b(/*)45 b(try)f(to)g(catch)
g(errors)g(*/)640 4527 y(/*)h(the)f(following)f(union)h(is)h(implied:)
685 4610 y(union)f({)730 4692 y(char)g(record[rec_len];)730
4774 y(struct)g({)775 4856 y(char)g(key[key_len];)775
4938 y(char)g(data[data_len];)730 5021 y(})730 5103 y(u32)g(totalsize;)
f(\(tailer\))685 5185 y(})640 5267 y(*/)596 5349 y(};)p
Black 3601 5585 a Fd(41)p Black eop
%%Page: 42 42
42 41 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(/*)44 b(a)h(byte)f(range)g(locking)f(function)h(-)h
(return)e(0)i(on)g(success)730 171 y(this)f(functions)f(locks/unlocks)g
(1)i(byte)f(at)g(the)h(specified)e(offset.)730 336 y(On)i(error,)e
(errno)h(is)h(also)f(set)g(so)h(that)f(errors)g(are)g(passed)g(back)g
(properly)730 418 y(through)g(tdb_open\(\).)f(*/)596
500 y(static)g(int)i(tdb_brlock\(TDB_CONTEXT)c(*tdb,)j(tdb_off)f
(offset,)954 582 y(int)h(rw_type,)g(int)g(lck_type,)g(int)g(probe\))596
664 y({)640 747 y(struct)g(flock)g(fl;)640 911 y(if)h(\(tdb-)p
Fa(>)p Fe(flags)e(&)h(TDB_NOLOCK\))685 993 y(return)g(0;)640
1075 y(if)h(\(tdb-)p Fa(>)p Fe(read_only\))d({)685 1158
y(errno)i(=)h(EACCES;)685 1240 y(return)f(-1;)640 1322
y(})640 1486 y(fl.l_type)g(=)g(rw_type;)640 1569 y(fl.l_whence)f(=)i
(SEEK_SET;)640 1651 y(fl.l_start)e(=)i(offset;)640 1733
y(fl.l_len)f(=)g(1;)640 1815 y(fl.l_pid)g(=)g(0;)640
1979 y(if)h(\(fcntl\(tdb-)p Fa(>)p Fe(fd,lck_type,&fl\))40
b(==)k(-1\))h({)685 2062 y(if)g(\(!probe\))e({)730 2144
y(TDB_LOG\(\(tdb,)g(5,"tdb_brlock)f(failed)i(\(fd=\045d\))g(at)g
(offset)g(\045d)h(rw_type=\045d)e(lck_type=\045d\\n",)820
2226 y(tdb-)p Fa(>)p Fe(fd,)g(offset,)h(rw_type,)f(lck_type\)\);)685
2308 y(})685 2390 y(/*)i(errno)f(set)g(by)g(fcntl)g(*/)685
2473 y(return)g(TDB_ERRCODE\(TDB_ERR_LOCK,)d(-1\);)640
2555 y(})640 2637 y(return)j(0;)596 2719 y(})596 2884
y(/*)g(lock)g(a)h(list)f(in)g(the)h(database.)e(list)h(-1)h(is)f(the)h
(alloc)f(list)g(*/)596 2966 y(static)f(int)i(tdb_lock\(TDB_CONTEXT)c
(*tdb,)j(int)g(list,)g(int)h(ltype\))596 3048 y({)640
3130 y(if)g(\(list)f Fa(<)g Fe(-1)h(||)f(list)h Fa(>)p
Fe(=)f(\(int\)tdb-)p Fa(>)p Fe(header.hash_size\))c({)685
3212 y(TDB_LOG\(\(tdb,)j(0,"tdb_lock:)g(invalid)g(list)h(\045d)h(for)f
(ltype=\045d\\n",)865 3295 y(list,)f(ltype\)\);)685 3377
y(return)h(-1;)640 3459 y(})640 3541 y(if)h(\(tdb-)p
Fa(>)p Fe(flags)e(&)h(TDB_NOLOCK\))685 3623 y(return)g(0;)640
3788 y(/*)h(Since)f(fcntl)g(locks)g(don't)g(nest,)g(we)g(do)h(a)f(lock)
h(for)f(the)g(first)g(one,)775 3870 y(and)g(simply)g(bump)g(the)g
(count)g(for)h(future)f(ones)g(*/)640 3952 y(if)h(\(tdb-)p
Fa(>)p Fe(locked[list+1].count)40 b(==)45 b(0\))f({)685
4034 y(if)h(\(!tdb-)p Fa(>)p Fe(read_only)d(&&)i(tdb-)p
Fa(>)p Fe(header.rwlocks\))e({)730 4116 y(if)j(\(tdb_spinlock\(tdb,)c
(list,)j(ltype\)\))g({)775 4199 y(TDB_LOG\(\(tdb,)e(0,)j("tdb_lock)e
(spinlock)h(failed)g(on)g(list)g(ltype=\045d\\n",)954
4281 y(list,)g(ltype\)\);)775 4363 y(return)g(-1;)730
4445 y(})685 4527 y(})h(else)f(if)g
(\(tdb_brlock\(tdb,FREELIST_TOP+4*list,ltype,)o(F_SETL)o(KW,)39
b(0\)\))44 b({)730 4610 y(TDB_LOG\(\(tdb,)f(0,"tdb_lock)g(failed)g(on)i
(list)f(\045d)h(ltype=\045d)e(\(\045s\)\\n",)954 4692
y(list,)h(ltype,)g(strerror\(errno\)\)\);)730 4774 y(return)g(-1;)685
4856 y(})685 4938 y(tdb-)p Fa(>)p Fe(locked[list+1].ltype)d(=)j(ltype;)
640 5021 y(})640 5103 y(tdb-)p Fa(>)p Fe(locked[list+1].count++;)640
5185 y(return)g(0;)596 5267 y(})596 5432 y(/*)g(unlock)g(the)g
(database:)f(returns)h(void)g(because)g(it's)g(too)g(late)h(for)f
(errors.)g(*/)p Black 197 5585 a Fd(42)p Black eop
%%Page: 43 43
43 42 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(static)43 b(void)h(tdb_unlock\(TDB_CONTEXT)e(*tdb,)i
(int)g(list,)g(int)g(ltype\))596 171 y({)640 253 y(if)h(\(tdb-)p
Fa(>)p Fe(flags)e(&)h(TDB_NOLOCK\))685 336 y(return;)640
500 y(/*)h(Sanity)f(checks)f(*/)640 582 y(if)i(\(list)f
Fa(<)g Fe(-1)h(||)f(list)h Fa(>)p Fe(=)f(\(int\)tdb-)p
Fa(>)p Fe(header.hash_size\))685 664 y(return;)640 747
y(if)h(\(tdb-)p Fa(>)p Fe(locked[list+1].count==0\))685
829 y(return;)640 993 y(if)g(\(tdb-)p Fa(>)p Fe(locked[list+1].count)40
b(==)45 b(1\))f({)685 1075 y(/*)h(Down)f(to)g(last)g(nested)g(lock:)g
(unlock)g(underneath)f(*/)685 1158 y(if)i(\(!tdb-)p Fa(>)p
Fe(read_only)d(&&)i(tdb-)p Fa(>)p Fe(header.rwlocks\))730
1240 y(tdb_spinunlock\(tdb,)e(list,)i(ltype\);)685 1322
y(else)730 1404 y(tdb_brlock\(tdb,)e(FREELIST_TOP+4*list,)g(F_UNLCK,)h
(F_SETLKW,)h(0\);)640 1486 y(})640 1569 y(tdb-)p Fa(>)p
Fe(locked[list+1].count--;)596 1651 y(})596 1815 y(/*)g(This)g(is)h
(based)f(on)g(the)g(hash)h(agorithm)e(from)h(gdbm)g(*/)596
1897 y(static)f(u32)i(tdb_hash\(TDB_DATA)d(*key\))596
1979 y({)640 2062 y(u32)j(value;)e(/*)i(Used)f(to)h(compute)e(the)i
(hash)f(value.)88 b(*/)640 2144 y(u32)134 b(i;)45 b(/*)f(Used)g(to)h
(cycle)f(through)g(random)f(values.)h(*/)640 2308 y(/*)h(Set)f(the)g
(initial)g(value)g(from)g(the)h(key)f(size.)g(*/)640
2390 y(for)h(\(value)e(=)i(0x238F13AF)e(*)i(key-)p Fa(>)p
Fe(dsize,)e(i=0;)h(i)h Fa(<)f Fe(key-)p Fa(>)p Fe(dsize;)f(i++\))685
2473 y(value)h(=)h(\(value)f(+)g(\(key-)p Fa(>)p Fe(dptr[i])f
Fa(<<)h Fe(\(i*5)g(\045)h(24\)\)\);)640 2637 y(return)f(\(1103515243)f
(*)i(value)f(+)g(12345\);)596 2719 y(})596 2884 y(/*)g(check)g(for)g
(an)h(out)f(of)h(bounds)e(access)h(-)h(if)f(it)h(is)f(out)h(of)f
(bounds)g(then)730 2966 y(see)g(if)h(the)f(database)g(has)g(been)g
(expanded)g(by)g(someone)g(else)g(and)g(expand)730 3048
y(if)h(necessary)730 3130 y(note)f(that)g("len")g(is)h(the)f(minimum)g
(length)g(needed)f(for)i(the)f(db)596 3212 y(*/)596 3295
y(static)f(int)i(tdb_oob\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g(len,)g(int)g
(probe\))596 3377 y({)640 3459 y(struct)g(stat)g(st;)640
3541 y(if)h(\(len)f Fa(<)p Fe(=)g(tdb-)p Fa(>)p Fe(map_size\))685
3623 y(return)g(0;)640 3706 y(if)h(\(tdb-)p Fa(>)p Fe(flags)e(&)h
(TDB_INTERNAL\))f({)685 3788 y(if)i(\(!probe\))e({)730
3870 y(TDB_LOG\(\(tdb,)g(0,"tdb_oob)g(len)h(\045d)h(beyond)e(internal)h
(malloc)g(size)g(\045d\\n",)820 3952 y(\(int\)len,)f(\(int\)tdb-)p
Fa(>)p Fe(map_size\)\);)685 4034 y(})685 4116 y(return)h
(TDB_ERRCODE\(TDB_ERR_IO,)d(-1\);)640 4199 y(})640 4363
y(if)k(\(fstat\(tdb-)p Fa(>)p Fe(fd,)d(&st\))i(==)h(-1\))685
4445 y(return)f(TDB_ERRCODE\(TDB_ERR_IO,)d(-1\);)640
4610 y(if)k(\(st.st_size)e Fa(<)h Fe(\(size_t\)len\))f({)685
4692 y(if)i(\(!probe\))e({)730 4774 y(TDB_LOG\(\(tdb,)g(0,"tdb_oob)g
(len)h(\045d)h(beyond)e(eof)i(at)f(\045d\\n",)820 4856
y(\(int\)len,)f(\(int\)st.st_size\)\);)685 4938 y(})685
5021 y(return)h(TDB_ERRCODE\(TDB_ERR_IO,)d(-1\);)640
5103 y(})640 5267 y(/*)k(Unmap,)f(update)f(size,)h(remap)g(*/)640
5349 y(tdb_munmap\(tdb\);)640 5432 y(tdb-)p Fa(>)p Fe(map_size)f(=)i
(st.st_size;)p Black 3601 5585 a Fd(43)p Black eop
%%Page: 44 44
44 43 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(tdb_mmap\(tdb\);)640 171 y(return)44
b(0;)596 253 y(})596 418 y(/*)g(write)g(a)h(lump)f(of)g(data)g(at)h(a)g
(specified)e(offset)h(*/)596 500 y(static)f(int)i
(tdb_write\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g(off,)g(void)g(*buf,)g
(tdb_len)g(len\))596 582 y({)640 664 y(if)h(\(tdb_oob\(tdb,)d(off)j(+)f
(len,)h(0\))f(!=)h(0\))685 747 y(return)f(-1;)640 911
y(if)h(\(tdb-)p Fa(>)p Fe(map_ptr\))685 993 y(memcpy\(off)e(+)i(\(char)
f(*\)tdb-)p Fa(>)p Fe(map_ptr,)e(buf,)i(len\);)596 1075
y(#ifdef)f(HAVE_PWRITE)640 1158 y(else)i(if)f(\(pwrite\(tdb-)p
Fa(>)p Fe(fd,)e(buf,)i(len,)g(off\))h(!=)f(\(ssize_t\)len\))f({)596
1240 y(#else)640 1322 y(else)i(if)f(\(lseek\(tdb-)p Fa(>)p
Fe(fd,)e(off,)i(SEEK_SET\))g(!=)g(off)730 1404 y(||)h(write\(tdb-)p
Fa(>)p Fe(fd,)d(buf,)i(len\))g(!=)h(\(ssize_t\)len\))d({)596
1486 y(#endif)685 1569 y(TDB_LOG\(\(tdb,)h(0,"tdb_write)g(failed)g(at)i
(\045d)f(len=\045d)g(\(\045s\)\\n",)865 1651 y(off,)g(len,)g
(strerror\(errno\)\)\);)685 1733 y(return)g(TDB_ERRCODE\(TDB_ERR_IO,)d
(-1\);)640 1815 y(})640 1897 y(return)j(0;)596 1979 y(})596
2144 y(/*)g(read)g(a)h(lump)f(of)g(data)h(at)f(a)h(specified)e(offset,)
h(maybe)g(convert)f(*/)596 2226 y(static)g(int)i(tdb_read\(TDB_CONTEXT)
c(*tdb,tdb_off)i(off,void)g(*buf,tdb_len)g(len,int)h(cv\))596
2308 y({)640 2390 y(if)h(\(tdb_oob\(tdb,)d(off)j(+)f(len,)h(0\))f(!=)h
(0\))685 2473 y(return)f(-1;)640 2637 y(if)h(\(tdb-)p
Fa(>)p Fe(map_ptr\))685 2719 y(memcpy\(buf,)e(off)h(+)h(\(char)f
(*\)tdb-)p Fa(>)p Fe(map_ptr,)e(len\);)596 2801 y(#ifdef)h(HAVE_PREAD)
640 2884 y(else)i(if)f(\(pread\(tdb-)p Fa(>)p Fe(fd,)e(buf,)i(len,)h
(off\))f(!=)g(\(ssize_t\)len\))f({)596 2966 y(#else)640
3048 y(else)i(if)f(\(lseek\(tdb-)p Fa(>)p Fe(fd,)e(off,)i(SEEK_SET\))g
(!=)g(off)730 3130 y(||)h(read\(tdb-)p Fa(>)p Fe(fd,)d(buf,)i(len\))g
(!=)h(\(ssize_t\)len\))e({)596 3212 y(#endif)685 3295
y(TDB_LOG\(\(tdb,)g(0,"tdb_read)g(failed)h(at)g(\045d)h(len=\045d)e
(\(\045s\)\\n",)865 3377 y(off,)h(len,)g(strerror\(errno\)\)\);)685
3459 y(return)g(TDB_ERRCODE\(TDB_ERR_IO,)d(-1\);)640
3541 y(})640 3623 y(if)k(\(cv\))685 3706 y(convert\(buf,)e(len\);)640
3788 y(return)h(0;)596 3870 y(})596 4034 y(/*)g(read)g(a)h(lump)f(of)g
(data,)g(allocating)g(the)g(space)g(for)g(it)h(*/)596
4116 y(static)e(char)h(*tdb_alloc_read\(TDB_CONTEXT)d(*tdb,)j(tdb_off)f
(offset,)h(tdb_len)g(len\))596 4199 y({)640 4281 y(char)h(*buf;)640
4445 y(if)g(\(!\(buf)f(=)g(malloc\(len\)\)\))f({)685
4527 y(TDB_LOG\(\(tdb,)g(0,"tdb_alloc_read)f(malloc)i(failed)f
(len=\045d)h(\(\045s\)\\n",)865 4610 y(len,)g(strerror\(errno\)\)\);)
685 4692 y(return)g(TDB_ERRCODE\(TDB_ERR_OOM,)d(buf\);)640
4774 y(})640 4856 y(if)k(\(tdb_read\(tdb,)d(offset,)i(buf,)g(len,)g
(0\))h(==)f(-1\))h({)685 4938 y(SAFE_FREE\(buf\);)685
5021 y(return)f(NULL;)640 5103 y(})640 5185 y(return)g(buf;)596
5267 y(})596 5432 y(/*)g(read/write)f(a)i(tdb_off)e(*/)p
Black 197 5585 a Fd(44)p Black eop
%%Page: 45 45
45 44 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(static)43 b(int)i(ofs_read\(TDB_CONTEXT)c(*tdb,)j
(tdb_off)g(offset,)f(tdb_off)h(*d\))596 171 y({)640 253
y(return)g(tdb_read\(tdb,)f(offset,)g(\(char*\)d,)h(sizeof\(*d\),)f
(DOCONV\(\)\);)596 336 y(})596 418 y(static)g(int)i
(ofs_write\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g(offset,)f(tdb_off)h(*d\))
596 500 y({)640 582 y(tdb_off)g(off)g(=)h(*d;)640 664
y(return)f(tdb_write\(tdb,)f(offset,)g(CONVERT\(off\),)g
(sizeof\(*d\)\);)596 747 y(})596 911 y(/*)h(read/write)f(a)i(record)f
(*/)596 993 y(static)f(int)i(rec_read\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g
(offset,)f(struct)h(list_struct)f(*rec\))596 1075 y({)640
1158 y(if)i(\(tdb_read\(tdb,)d(offset,)i(rec,)g
(sizeof\(*rec\),DOCONV\(\)\))d(==)k(-1\))685 1240 y(return)f(-1;)640
1322 y(if)h(\(TDB_BAD_MAGIC\(rec\)\))c({)685 1404 y(TDB_LOG\(\(tdb,)i
(0,"rec_read)g(bad)h(magic)g(0x\045x)g(at)h(offset=\045d\\n",)d(rec-)p
Fa(>)p Fe(magic,)h(offset\)\);)685 1486 y(return)h
(TDB_ERRCODE\(TDB_ERR_CORRUPT,)c(-1\);)640 1569 y(})640
1651 y(return)k(tdb_oob\(tdb,)f(rec-)p Fa(>)p Fe(next+sizeof\(*rec\),)e
(0\);)596 1733 y(})596 1815 y(static)i(int)i(rec_write\(TDB_CONTEXT)c
(*tdb,)j(tdb_off)g(offset,)f(struct)h(list_struct)f(*rec\))596
1897 y({)640 1979 y(struct)h(list_struct)f(r)i(=)f(*rec;)640
2062 y(return)g(tdb_write\(tdb,)f(offset,)g(CONVERT\(r\),)g
(sizeof\(r\)\);)596 2144 y(})596 2308 y(/*)h(read)g(a)h(freelist)e
(record)h(and)g(check)g(for)h(simple)f(errors)f(*/)596
2390 y(static)g(int)i(rec_free_read\(TDB_CONTEXT)40 b(*tdb,)k(tdb_off)g
(off,)g(struct)g(list_struct)f(*rec\))596 2473 y({)640
2555 y(if)i(\(tdb_read\(tdb,)d(off,)i(rec,)h
(sizeof\(*rec\),DOCONV\(\)\))c(==)j(-1\))685 2637 y(return)g(-1;)640
2719 y(if)h(\(rec-)p Fa(>)p Fe(magic)e(!=)h(TDB_FREE_MAGIC\))f({)685
2801 y(TDB_LOG\(\(tdb,)g(0,"rec_free_read)f(bad)i(magic)g(0x\045x)g(at)
h(offset=\045d\\n",)865 2884 y(rec-)p Fa(>)p Fe(magic,)d(off\)\);)685
2966 y(return)i(TDB_ERRCODE\(TDB_ERR_CORRUPT,)c(-1\);)640
3048 y(})640 3130 y(if)45 b(\(tdb_oob\(tdb,)d(rec-)p
Fa(>)p Fe(next+sizeof\(*rec\),)f(0\))k(!=)f(0\))685 3212
y(return)g(-1;)640 3295 y(return)g(0;)596 3377 y(})596
3541 y(/*)g(update)g(a)g(record)g(tailer)g(\(must)g(hold)g(allocation)f
(lock\))h(*/)596 3623 y(static)f(int)i(update_tailer\(TDB_CONTEXT)40
b(*tdb,)k(tdb_off)g(offset,)775 3706 y(const)g(struct)g(list_struct)f
(*rec\))596 3788 y({)640 3870 y(tdb_off)h(totalsize;)640
4034 y(/*)h(Offset)f(of)g(tailer)g(from)g(record)g(header)g(*/)640
4116 y(totalsize)g(=)g(sizeof\(*rec\))f(+)i(rec-)p Fa(>)p
Fe(rec_len;)640 4199 y(return)f(ofs_write\(tdb,)f(offset)g(+)i
(totalsize)e(-)i(sizeof\(tdb_off\),)775 4281 y(&totalsize\);)596
4363 y(})596 4527 y(static)e(tdb_off)h(tdb_dump_record\(TDB_CONTEXT)c
(*tdb,)k(tdb_off)g(offset\))596 4610 y({)640 4692 y(struct)g
(list_struct)f(rec;)640 4774 y(tdb_off)h(tailer_ofs,)f(tailer;)640
4938 y(if)i(\(tdb_read\(tdb,)d(offset,)i(\(char)g(*\)&rec,)g
(sizeof\(rec\),)e(DOCONV\(\)\))i(==)g(-1\))h({)685 5021
y(printf\("ERROR:)e(failed)g(to)i(read)f(record)g(at)g(\045u\\n",)g
(offset\);)685 5103 y(return)g(0;)640 5185 y(})640 5349
y(printf\(")g(rec:)g(offset=\045u)f(next=\045d)h(rec_len=\045d)f
(key_len=\045d)g(data_len=\045d)g(full_hash=0x\045x)g
(magic=0x\045x\\n",)954 5432 y(offset,)h(rec.next,)f(rec.rec_len,)g
(rec.key_len,)g(rec.data_len,)f(rec.full_hash,)h(rec.magic\);)p
Black 3601 5585 a Fd(45)p Black eop
%%Page: 46 46
46 45 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 171 a Fe(tailer_ofs)43 b(=)i(offset)f(+)h(sizeof\(rec\))e(+)h
(rec.rec_len)f(-)i(sizeof\(tdb_off\);)640 253 y(if)g(\(ofs_read\(tdb,)d
(tailer_ofs,)h(&tailer\))h(==)g(-1\))h({)685 336 y(printf\("ERROR:)e
(failed)g(to)i(read)f(tailer)g(at)g(\045u\\n",)g(tailer_ofs\);)685
418 y(return)g(rec.next;)640 500 y(})640 664 y(if)h(\(tailer)e(!=)i
(rec.rec_len)e(+)i(sizeof\(rec\)\))d({)685 747 y(printf\("ERROR:)h
(tailer)g(does)i(not)f(match)g(record!)g(tailer=\045u)f
(totalsize=\045u\\n",)775 829 y(\(unsigned\)tailer,)f
(\(unsigned\)\(rec.rec_len)f(+)k(sizeof\(rec\)\)\);)640
911 y(})640 993 y(return)f(rec.next;)596 1075 y(})596
1240 y(static)f(void)h(tdb_dump_chain\(TDB_CONTEXT)d(*tdb,)j(int)g(i\))
596 1322 y({)640 1404 y(tdb_off)g(rec_ptr,)f(top;)640
1569 y(top)i(=)f(TDB_HASH_TOP\(i\);)640 1733 y(tdb_lock\(tdb,)f(i,)h
(F_WRLCK\);)640 1897 y(if)h(\(ofs_read\(tdb,)d(top,)i(&rec_ptr\))g(==)g
(-1\))h({)685 1979 y(tdb_unlock\(tdb,)d(i,)j(F_WRLCK\);)685
2062 y(return;)640 2144 y(})640 2308 y(if)g(\(rec_ptr\))685
2390 y(printf\("hash=\045d\\n",)d(i\);)640 2555 y(while)i(\(rec_ptr\))g
({)685 2637 y(rec_ptr)g(=)g(tdb_dump_record\(tdb,)e(rec_ptr\);)640
2719 y(})640 2801 y(tdb_unlock\(tdb,)h(i,)h(F_WRLCK\);)596
2884 y(})596 3048 y(void)g(tdb_dump_all\(TDB_CONTEXT)c(*tdb\))596
3130 y({)640 3212 y(int)45 b(i;)640 3295 y(for)g(\(i=0;i)p
Fa(<)p Fe(tdb-)p Fa(>)p Fe(header.hash_size;i++\))39
b({)685 3377 y(tdb_dump_chain\(tdb,)j(i\);)640 3459 y(})640
3541 y(printf\("freelist:\\n"\);)640 3623 y(tdb_dump_chain\(tdb,)g
(-1\);)596 3706 y(})596 3870 y(void)i(tdb_printfreelist\(TDB_CONTEXT)c
(*tdb\))596 3952 y({)640 4034 y(long)45 b(total_free)e(=)h(0;)640
4116 y(tdb_off)g(offset,)g(rec_ptr;)640 4199 y(struct)g(list_struct)f
(rec;)640 4363 y(tdb_lock\(tdb,)g(-1,)h(F_WRLCK\);)640
4527 y(offset)g(=)h(FREELIST_TOP;)640 4692 y(/*)g(read)f(in)g(the)h
(freelist)e(top)i(*/)640 4774 y(if)g(\(ofs_read\(tdb,)d(offset,)i
(&rec_ptr\))f(==)i(-1\))f({)685 4856 y(return;)640 4938
y(})640 5103 y(printf\("freelist)e(top=[0x\04508x]\\n",)h(rec_ptr)g
(\);)640 5185 y(while)h(\(rec_ptr\))g({)685 5267 y(if)h
(\(tdb_read\(tdb,)d(rec_ptr,)i(\(char)g(*\)&rec,)f(sizeof\(rec\),)g
(DOCONV\(\)\))g(==)i(-)596 5349 y(1\))f({)730 5432 y(return;)p
Black 197 5585 a Fd(46)p Black eop
%%Page: 47 47
47 46 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(})685 253 y(if)45 b(\(rec.magic)e(!=)h
(TDB_FREE_MAGIC\))f({)730 336 y(printf\("bad)g(magic)h(0x\04508x)g(in)g
(free)g(list\\n",)g(rec.magic\);)730 418 y(return;)685
500 y(})685 664 y(printf\("entry)f(offset=[0x\04508x],)f(rec.rec_len)h
(=)i([0x\04508x)e(\(\045d\)]\\n",)h(rec.next,)f(rec.rec_len,)g
(rec.rec_len)g(\);)685 747 y(total_free)g(+=)i(rec.rec_len;)685
911 y(/*)g(move)f(to)g(the)h(next)f(record)g(*/)685 993
y(rec_ptr)g(=)g(rec.next;)640 1075 y(})640 1158 y(printf\("total)f
(rec_len)h(=)g([0x\04508x)g(\(\045d\)]\\n",)f(\(int\)total_free,)1268
1240 y(\(int\)total_free\);)640 1404 y(tdb_unlock\(tdb,)g(-1,)h
(F_WRLCK\);)596 1486 y(})596 1651 y(/*)g(Remove)g(an)g(element)g(from)g
(the)g(freelist.)89 b(Must)44 b(have)g(alloc)g(lock.)g(*/)596
1733 y(static)f(int)i(remove_from_freelist\(TDB_CONTEXT)39
b(*tdb,)44 b(tdb_off)g(off,)g(tdb_off)g(next\))596 1815
y({)640 1897 y(tdb_off)g(last_ptr,)f(i;)640 2062 y(/*)i(read)f(in)g
(the)h(freelist)e(top)i(*/)640 2144 y(last_ptr)f(=)g(FREELIST_TOP;)640
2226 y(while)g(\(ofs_read\(tdb,)f(last_ptr,)g(&i\))h(!=)h(-1)f(&&)h(i)g
(!=)f(0\))h({)685 2308 y(if)g(\(i)f(==)h(off\))f({)730
2390 y(/*)h(We've)e(found)h(it!)h(*/)730 2473 y(return)f
(ofs_write\(tdb,)e(last_ptr,)i(&next\);)685 2555 y(})685
2637 y(/*)h(Follow)e(chain)h(\(next)g(offset)g(is)h(at)f(start)g(of)h
(record\))e(*/)685 2719 y(last_ptr)h(=)g(i;)640 2801
y(})640 2884 y(TDB_LOG\(\(tdb,)f(0,"remove_from_freelist:)e(not)j(on)h
(list)f(at)g(off=\045d\\n",)f(off\)\);)640 2966 y(return)h
(TDB_ERRCODE\(TDB_ERR_CORRUPT,)c(-1\);)596 3048 y(})596
3212 y(/*)k(Add)g(an)h(element)e(into)i(the)f(freelist.)f(Merge)h
(adjacent)g(records)f(if)730 3295 y(neccessary.)g(*/)596
3377 y(static)g(int)i(tdb_free\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g
(offset,)f(struct)h(list_struct)f(*rec\))596 3459 y({)640
3541 y(tdb_off)h(right,)g(left;)640 3706 y(/*)h(Allocation)e(and)h
(tailer)g(lock)g(*/)640 3788 y(if)h(\(tdb_lock\(tdb,)d(-1,)j(F_WRLCK\))
e(!=)i(0\))685 3870 y(return)f(-1;)640 4034 y(/*)h(set)f(an)h(initial)e
(tailer,)h(so)g(if)h(we)f(fail)h(we)f(don't)g(leave)g(a)h(bogus)f
(record)g(*/)640 4116 y(update_tailer\(tdb,)e(offset,)i(rec\);)640
4281 y(/*)h(Look)f(right)g(first)g(\(I'm)g(an)h(Australian,)e(dammit\))
g(*/)640 4363 y(right)h(=)h(offset)f(+)g(sizeof\(*rec\))f(+)i(rec-)p
Fa(>)p Fe(rec_len;)640 4445 y(if)g(\(right)f(+)g(sizeof\(*rec\))f
Fa(<)p Fe(=)i(tdb-)p Fa(>)p Fe(map_size\))d({)685 4527
y(struct)i(list_struct)f(r;)685 4692 y(if)i(\(tdb_read\(tdb,)d(right,)i
(&r,)g(sizeof\(r\),)f(DOCONV\(\)\))h(==)g(-1\))h({)730
4774 y(TDB_LOG\(\(tdb,)e(0,)h("tdb_free:)f(right)h(read)g(failed)g(at)h
(\045u\\n",)f(right\)\);)730 4856 y(goto)g(left;)685
4938 y(})685 5103 y(/*)h(If)f(it's)g(free,)g(expand)g(to)h(include)e
(it.)i(*/)685 5185 y(if)g(\(r.magic)e(==)i(TDB_FREE_MAGIC\))d({)730
5267 y(if)j(\(remove_from_freelist\(tdb,)40 b(right,)k(r.next\))f(==)i
(-1\))f({)775 5349 y(TDB_LOG\(\(tdb,)e(0,)j("tdb_free:)e(right)h(free)g
(failed)g(at)h(\045u\\n",)e(right\)\);)775 5432 y(goto)h(left;)p
Black 3601 5585 a Fd(47)p Black eop
%%Page: 48 48
48 47 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 730 89 a Fe(})730 171 y(rec-)p Fa(>)p Fe(rec_len)43
b(+=)h(sizeof\(r\))g(+)g(r.rec_len;)685 253 y(})640 336
y(})596 500 y(left:)640 582 y(/*)h(Look)f(left)g(*/)640
664 y(left)h(=)f(offset)g(-)h(sizeof\(tdb_off\);)640
747 y(if)g(\(left)f Fa(>)g Fe(TDB_HASH_TOP\(tdb-)p Fa(>)p
Fe(header.hash_size-1\)\))39 b({)685 829 y(struct)44
b(list_struct)f(l;)685 911 y(tdb_off)h(leftsize;)685
1075 y(/*)h(Read)f(in)g(tailer)g(and)g(jump)h(back)f(to)g(header)g(*/)
685 1158 y(if)h(\(ofs_read\(tdb,)d(left,)i(&leftsize\))f(==)i(-1\))f({)
730 1240 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_free:)f(left)h(offset)g(read)g
(failed)g(at)h(\045u\\n",)f(left\)\);)730 1322 y(goto)g(update;)685
1404 y(})685 1486 y(left)g(=)h(offset)f(-)g(leftsize;)685
1651 y(/*)h(Now)f(read)g(in)h(record)e(*/)685 1733 y(if)i
(\(tdb_read\(tdb,)d(left,)i(&l,)g(sizeof\(l\),)g(DOCONV\(\)\))f(==)h
(-1\))h({)730 1815 y(TDB_LOG\(\(tdb,)e(0,)h("tdb_free:)f(left)h(read)h
(failed)e(at)i(\045u)f(\(\045u\)\\n",)g(left,)g(leftsize\)\);)730
1897 y(goto)g(update;)685 1979 y(})685 2144 y(/*)h(If)f(it's)g(free,)g
(expand)g(to)h(include)e(it.)i(*/)685 2226 y(if)g(\(l.magic)e(==)i
(TDB_FREE_MAGIC\))d({)730 2308 y(if)j(\(remove_from_freelist\(tdb,)40
b(left,)k(l.next\))g(==)g(-1\))g({)775 2390 y(TDB_LOG\(\(tdb,)e(0,)j
("tdb_free:)e(left)h(free)g(failed)g(at)h(\045u\\n",)f(left\)\);)775
2473 y(goto)g(update;)730 2555 y(})h(else)f({)775 2637
y(offset)g(=)g(left;)775 2719 y(rec-)p Fa(>)p Fe(rec_len)f(+=)h
(leftsize;)730 2801 y(})685 2884 y(})640 2966 y(})596
3130 y(update:)640 3212 y(if)h(\(update_tailer\(tdb,)c(offset,)j(rec\))
g(==)h(-1\))f({)685 3295 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_free:)f
(update_tailer)g(failed)h(at)g(\045u\\n",)g(offset\)\);)685
3377 y(goto)g(fail;)640 3459 y(})640 3623 y(/*)h(Now,)f(prepend)g(to)g
(free)g(list)g(*/)640 3706 y(rec-)p Fa(>)p Fe(magic)f(=)i
(TDB_FREE_MAGIC;)640 3870 y(if)g(\(ofs_read\(tdb,)d(FREELIST_TOP,)h
(&rec-)p Fa(>)p Fe(next\))g(==)h(-1)h(||)820 3952 y(rec_write\(tdb,)d
(offset,)i(rec\))g(==)g(-1)h(||)820 4034 y(ofs_write\(tdb,)d
(FREELIST_TOP,)h(&offset\))g(==)i(-1\))f({)685 4116 y(TDB_LOG\(\(tdb,)f
(0,)h("tdb_free)g(record)f(write)h(failed)g(at)h(offset=\045d\\n",)d
(offset\)\);)685 4199 y(goto)i(fail;)640 4281 y(})640
4445 y(/*)h(And)f(we're)g(done.)g(*/)640 4527 y(tdb_unlock\(tdb,)f(-1,)
h(F_WRLCK\);)640 4610 y(return)g(0;)640 4774 y(fail:)640
4856 y(tdb_unlock\(tdb,)f(-1,)h(F_WRLCK\);)640 4938 y(return)g(-1;)596
5021 y(})596 5267 y(/*)g(expand)g(a)g(file.)89 b(we)45
b(prefer)f(to)g(use)g(ftruncate,)g(as)g(that)g(is)h(what)f(posix)685
5349 y(says)g(to)h(use)f(for)g(mmap)h(expansion)e(*/)596
5432 y(static)g(int)i(expand_file\(TDB_CONTEXT)c(*tdb,)j(tdb_off)f
(size,)h(tdb_off)g(addition\))p Black 197 5585 a Fd(48)p
Black eop
%%Page: 49 49
49 48 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe({)640 171 y(char)45 b(buf[1024];)596
253 y(#if)f(HAVE_FTRUNCATE_EXTEND)640 336 y(if)h(\(ftruncate\(tdb-)p
Fa(>)p Fe(fd,)c(size+addition\))i(!=)h(0\))h({)685 418
y(TDB_LOG\(\(tdb,)e(0,)h("expand_file)f(ftruncate)g(to)i(\045d)f
(failed)g(\(\045s\)\\n",)865 500 y(size+addition,)e
(strerror\(errno\)\)\);)685 582 y(return)i(-1;)640 664
y(})596 747 y(#else)640 829 y(char)h(b)f(=)h(0;)596 993
y(#ifdef)e(HAVE_PWRITE)640 1075 y(if)i(\(pwrite\(tdb-)p
Fa(>)p Fe(fd,)87 b(&b,)44 b(1,)h(\(size+addition\))d(-)j(1\))f(!=)h
(1\))f({)596 1158 y(#else)640 1240 y(if)h(\(lseek\(tdb-)p
Fa(>)p Fe(fd,)d(\(size+addition\))g(-)j(1,)g(SEEK_SET\))e(!=)h
(\(size+addition\))f(-)596 1322 y(1)h(||)820 1404 y(write\(tdb-)p
Fa(>)p Fe(fd,)e(&b,)i(1\))h(!=)f(1\))h({)596 1486 y(#endif)685
1569 y(TDB_LOG\(\(tdb,)e(0,)h("expand_file)f(to)i(\045d)f(failed)g
(\(\045s\)\\n",)865 1651 y(size+addition,)e(strerror\(errno\)\)\);)685
1733 y(return)i(-1;)640 1815 y(})596 1897 y(#endif)640
2062 y(/*)h(now)f(fill)g(the)h(file)f(with)g(something.)f(This)h
(ensures)g(that)g(the)g(file)h(isn't)f(sparse,)f(which)h(would)g(be)775
2144 y(very)g(bad)g(if)h(we)f(ran)h(out)f(of)g(disk.)g(This)h(must)f
(be)g(done)g(with)h(write,)e(not)i(via)f(mmap)g(*/)640
2226 y(memset\(buf,)f(0x42,)h(sizeof\(buf\)\);)640 2308
y(while)g(\(addition\))f({)685 2390 y(int)i(n)f(=)h(addition)p
Fa(>)p Fe(sizeof\(buf\)?sizeof\(buf\):addit)o(ion;)596
2473 y(#ifdef)e(HAVE_PWRITE)685 2555 y(int)i(ret)f(=)g(pwrite\(tdb-)p
Fa(>)p Fe(fd,)f(buf,)h(n,)g(size\);)596 2637 y(#else)685
2719 y(int)h(ret;)685 2801 y(if)g(\(lseek\(tdb-)p Fa(>)p
Fe(fd,)d(size,)i(SEEK_SET\))f(!=)i(size\))730 2884 y(return)f(-1;)685
2966 y(ret)h(=)f(write\(tdb-)p Fa(>)p Fe(fd,)f(buf,)h(n\);)596
3048 y(#endif)685 3130 y(if)h(\(ret)f(!=)g(n\))h({)730
3212 y(TDB_LOG\(\(tdb,)e(0,)h("expand_file)f(write)h(of)g(\045d)h
(failed)f(\(\045s\)\\n",)909 3295 y(n,)h(strerror\(errno\)\)\);)730
3377 y(return)f(-1;)685 3459 y(})685 3541 y(addition)g(-=)g(n;)685
3623 y(size)g(+=)h(n;)640 3706 y(})640 3788 y(return)f(0;)596
3870 y(})596 4116 y(/*)g(expand)g(the)g(database)g(at)g(least)g(size)g
(bytes)g(by)h(expanding)e(the)h(underlying)730 4199 y(file)g(and)g
(doing)g(the)h(mmap)f(again)g(if)g(necessary)g(*/)596
4281 y(static)f(int)i(tdb_expand\(TDB_CONTEXT)c(*tdb,)j(tdb_off)f
(size\))596 4363 y({)640 4445 y(struct)h(list_struct)f(rec;)640
4527 y(tdb_off)h(offset;)640 4692 y(if)h(\(tdb_lock\(tdb,)d(-1,)j
(F_WRLCK\))e(==)i(-1\))f({)685 4774 y(TDB_LOG\(\(tdb,)f(0,)h("lock)g
(failed)g(in)h(tdb_expand\\n"\)\);)685 4856 y(return)f(-1;)640
4938 y(})640 5103 y(/*)h(must)f(know)g(about)g(any)g(previous)g
(expansions)f(by)i(another)e(process)h(*/)640 5185 y(tdb_oob\(tdb,)f
(tdb-)p Fa(>)p Fe(map_size)g(+)h(1,)h(1\);)640 5349 y(/*)g(always)f
(make)g(room)g(for)g(at)h(least)f(10)g(more)g(records,)g(and)g(round)
1089 5432 y(the)g(database)f(up)i(to)f(a)h(multiple)f(of)g
(TDB_PAGE_SIZE)f(*/)p Black 3601 5585 a Fd(49)p Black
eop
%%Page: 50 50
50 49 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(size)45 b(=)f(TDB_ALIGN\(tdb-)p Fa(>)p
Fe(map_size)d(+)k(size*10,)e(TDB_PAGE_SIZE\))g(-)h(tdb-)p
Fa(>)p Fe(map_size;)640 253 y(if)h(\(!\(tdb-)p Fa(>)p
Fe(flags)d(&)j(TDB_INTERNAL\)\))685 336 y(tdb_munmap\(tdb\);)640
500 y(/*)685 582 y(*)g(We)f(must)g(ensure)g(the)h(file)f(is)g(unmapped)
g(before)g(doing)g(this)685 664 y(*)h(to)f(ensure)g(consistency)f(with)
h(systems)g(like)g(OpenBSD)g(where)685 747 y(*)h(writes)f(and)g(mmaps)g
(are)g(not)h(consistent.)685 829 y(*/)640 993 y(/*)g(expand)f(the)g
(file)g(itself)g(*/)640 1075 y(if)h(\(!\(tdb-)p Fa(>)p
Fe(flags)d(&)j(TDB_INTERNAL\)\))e({)685 1158 y(if)i
(\(expand_file\(tdb,)d(tdb-)p Fa(>)p Fe(map_size,)g(size\))i(!=)h(0\))
730 1240 y(goto)f(fail;)640 1322 y(})640 1486 y(tdb-)p
Fa(>)p Fe(map_size)f(+=)h(size;)640 1651 y(if)h(\(tdb-)p
Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))685 1733 y(tdb-)p
Fa(>)p Fe(map_ptr)f(=)i(realloc\(tdb-)p Fa(>)p Fe(map_ptr,)c(tdb-)p
Fa(>)p Fe(map_size\);)640 1815 y(else)k({)685 1897 y(/*)730
1979 y(*)g(We)f(must)g(ensure)g(the)g(file)h(is)f(remapped)g(before)f
(adding)h(the)h(space)730 2062 y(*)g(to)f(ensure)g(consistency)f(with)h
(systems)g(like)g(OpenBSD)g(where)730 2144 y(*)h(writes)e(and)i(mmaps)f
(are)g(not)g(consistent.)730 2226 y(*/)685 2390 y(/*)h(We're)f(ok)g(if)
h(the)f(mmap)g(fails)g(as)h(we'll)f(fallback)f(to)i(read/write)e(*/)685
2473 y(tdb_mmap\(tdb\);)640 2555 y(})640 2719 y(/*)i(form)f(a)h(new)f
(freelist)f(record)h(*/)640 2801 y(memset\(&rec,'\\0',sizeof\(rec\)\);)
640 2884 y(rec.rec_len)f(=)i(size)f(-)h(sizeof\(rec\);)640
3048 y(/*)g(link)f(it)g(into)h(the)f(free)g(list)g(*/)640
3130 y(offset)g(=)h(tdb-)p Fa(>)p Fe(map_size)d(-)j(size;)640
3212 y(if)g(\(tdb_free\(tdb,)d(offset,)i(&rec\))g(==)g(-1\))685
3295 y(goto)g(fail;)640 3459 y(tdb_unlock\(tdb,)f(-1,)h(F_WRLCK\);)640
3541 y(return)g(0;)640 3623 y(fail:)640 3706 y(tdb_unlock\(tdb,)f(-1,)h
(F_WRLCK\);)640 3788 y(return)g(-1;)596 3870 y(})596
4034 y(/*)g(allocate)f(some)i(space)f(from)g(the)g(free)g(list.)g(The)h
(offset)e(returned)h(points)730 4116 y(to)h(a)f(unconnected)f
(list_struct)g(within)h(the)g(database)g(with)g(room)g(for)g(at)730
4199 y(least)g(length)g(bytes)g(of)g(total)g(data)730
4363 y(0)h(is)f(returned)g(if)g(the)g(space)g(could)g(not)h(be)f
(allocated)640 4445 y(*/)596 4527 y(static)f(tdb_off)h
(tdb_allocate\(TDB_CONTEXT)d(*tdb,)j(tdb_len)f(length,)909
4610 y(struct)h(list_struct)f(*rec\))596 4692 y({)640
4774 y(tdb_off)h(rec_ptr,)f(last_ptr,)h(newrec_ptr;)640
4856 y(struct)g(list_struct)f(newrec;)640 5021 y(if)i(\(tdb_lock\(tdb,)
d(-1,)j(F_WRLCK\))e(==)i(-1\))685 5103 y(return)f(0;)640
5267 y(/*)h(Extra)f(bytes)g(required)f(for)i(tailer)e(*/)640
5349 y(length)h(+=)h(sizeof\(tdb_off\);)p Black 197 5585
a Fd(50)p Black eop
%%Page: 51 51
51 50 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(again:)640 171 y(last_ptr)44 b(=)g(FREELIST_TOP;)640
336 y(/*)h(read)f(in)g(the)h(freelist)e(top)i(*/)640
418 y(if)g(\(ofs_read\(tdb,)d(FREELIST_TOP,)h(&rec_ptr\))g(==)i(-1\))
685 500 y(goto)f(fail;)640 664 y(/*)h(keep)f(looking)g(until)g(we)g
(find)g(a)h(freelist)e(record)h(big)h(enough)e(*/)640
747 y(while)h(\(rec_ptr\))g({)685 829 y(if)h(\(rec_free_read\(tdb,)c
(rec_ptr,)j(rec\))g(==)g(-1\))730 911 y(goto)g(fail;)685
1075 y(if)h(\(rec-)p Fa(>)p Fe(rec_len)d Fa(>)p Fe(=)j(length\))e({)730
1158 y(/*)i(found)e(it)i(-)g(now)f(possibly)f(split)h(it)h(up)89
b(*/)730 1240 y(if)45 b(\(rec-)p Fa(>)p Fe(rec_len)d
Fa(>)j Fe(length)e(+)i(MIN_REC_SIZE\))e({)775 1322 y(/*)h(Length)g(of)h
(left)f(piece)g(*/)775 1404 y(length)g(=)g(TDB_ALIGN\(length,)e
(TDB_ALIGNMENT\);)775 1569 y(/*)i(Right)g(piece)g(to)h(go)f(on)h(free)f
(list)g(*/)775 1651 y(newrec.rec_len)e(=)j(rec-)p Fa(>)p
Fe(rec_len)820 1733 y(-)f(\(sizeof\(*rec\))f(+)i(length\);)775
1815 y(newrec_ptr)e(=)i(rec_ptr)e(+)i(sizeof\(*rec\))e(+)h(length;)775
1979 y(/*)g(And)h(left)f(record)g(is)g(shortened)f(*/)775
2062 y(rec-)p Fa(>)p Fe(rec_len)g(=)h(length;)730 2144
y(})h(else)775 2226 y(newrec_ptr)e(=)i(0;)730 2390 y(/*)g(Remove)e
(allocated)h(record)f(from)i(the)f(free)g(list)g(*/)730
2473 y(if)h(\(ofs_write\(tdb,)d(last_ptr,)h(&rec-)p Fa(>)p
Fe(next\))g(==)i(-1\))775 2555 y(goto)f(fail;)730 2719
y(/*)h(Update)e(header:)h(do)g(this)h(before)e(we)i(drop)f(alloc)1806
2801 y(lock,)g(otherwise)f(tdb_free\(\))g(might)h(try)h(to)1806
2884 y(merge)f(with)g(us,)g(thinking)g(we're)g(free.)1806
2966 y(\(Thanks)g(Jeremy)f(Allison\).)h(*/)730 3048 y(rec-)p
Fa(>)p Fe(magic)f(=)i(TDB_MAGIC;)730 3130 y(if)g(\(rec_write\(tdb,)d
(rec_ptr,)h(rec\))h(==)h(-1\))775 3212 y(goto)f(fail;)730
3377 y(/*)h(Did)f(we)g(create)g(new)g(block?)g(*/)730
3459 y(if)h(\(newrec_ptr\))d({)775 3541 y(/*)i(Update)g(allocated)f
(record)h(tailer)g(\(we)2165 3623 y(shortened)f(it\).)h(*/)775
3706 y(if)g(\(update_tailer\(tdb,)e(rec_ptr,)h(rec\))i(==)f(-1\))820
3788 y(goto)g(fail;)775 3952 y(/*)g(Free)g(new)h(record)f(*/)775
4034 y(if)g(\(tdb_free\(tdb,)f(newrec_ptr,)g(&newrec\))g(==)i(-1\))820
4116 y(goto)f(fail;)730 4199 y(})730 4363 y(/*)h(all)f(done)g(-)h
(return)e(the)i(new)f(record)g(offset)g(*/)730 4445 y(tdb_unlock\(tdb,)
e(-1,)j(F_WRLCK\);)730 4527 y(return)f(rec_ptr;)685 4610
y(})685 4692 y(/*)h(move)f(to)g(the)h(next)f(record)g(*/)685
4774 y(last_ptr)g(=)g(rec_ptr;)685 4856 y(rec_ptr)g(=)g(rec-)p
Fa(>)p Fe(next;)640 4938 y(})640 5021 y(/*)h(we)f(didn't)g(find)g
(enough)g(space.)g(See)g(if)h(we)f(can)h(expand)e(the)775
5103 y(database)g(and)i(if)f(we)h(can)f(then)g(try)g(again)g(*/)640
5185 y(if)h(\(tdb_expand\(tdb,)d(length)i(+)g(sizeof\(*rec\)\))f(==)i
(0\))685 5267 y(goto)f(again;)640 5349 y(fail:)640 5432
y(tdb_unlock\(tdb,)f(-1,)h(F_WRLCK\);)p Black 3601 5585
a Fd(51)p Black eop
%%Page: 52 52
52 51 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(return)44 b(0;)596 171 y(})596 336
y(/*)g(initialise)f(a)i(new)f(database)g(with)g(a)g(specified)g(hash)g
(size)g(*/)596 418 y(static)f(int)i(tdb_new_database\(TDB_CONTEXT)40
b(*tdb,)k(int)g(hash_size\))596 500 y({)640 582 y(struct)g(tdb_header)f
(*newdb;)640 664 y(int)i(size,)f(ret)g(=)h(-1;)640 829
y(/*)g(We)f(make)g(it)h(up)f(in)h(memory,)f(then)g(write)g(it)g(out)h
(if)f(not)g(internal)g(*/)640 911 y(size)h(=)f(sizeof\(struct)f
(tdb_header\))g(+)h(\(hash_size+1\)*sizeof\(tdb_off\);)640
993 y(if)h(\(!\(newdb)e(=)i(calloc\(size,)e(1\)\)\))685
1075 y(return)h(TDB_ERRCODE\(TDB_ERR_OOM,)d(-1\);)640
1240 y(/*)k(Fill)f(in)g(the)h(header)f(*/)640 1322 y(newdb-)p
Fa(>)p Fe(version)f(=)h(TDB_VERSION;)640 1404 y(newdb-)p
Fa(>)p Fe(hash_size)e(=)j(hash_size;)596 1486 y(#ifdef)e(USE_SPINLOCKS)
640 1569 y(newdb-)p Fa(>)p Fe(rwlocks)g(=)h(size;)596
1651 y(#endif)640 1733 y(if)h(\(tdb-)p Fa(>)p Fe(flags)e(&)h
(TDB_INTERNAL\))f({)685 1815 y(tdb-)p Fa(>)p Fe(map_size)g(=)h(size;)
685 1897 y(tdb-)p Fa(>)p Fe(map_ptr)f(=)i(\(char)f(*\)newdb;)685
1979 y(memcpy\(&tdb-)p Fa(>)p Fe(header,)e(newdb,)h(sizeof\(tdb-)p
Fa(>)p Fe(header\)\);)685 2062 y(/*)i(Convert)e(the)i(`ondisk')e
(version)h(if)g(asked.)g(*/)685 2144 y(CONVERT\(*newdb\);)685
2226 y(return)g(0;)640 2308 y(})640 2390 y(if)h(\(lseek\(tdb-)p
Fa(>)p Fe(fd,)d(0,)j(SEEK_SET\))e(==)h(-1\))685 2473
y(goto)g(fail;)640 2637 y(if)h(\(ftruncate\(tdb-)p Fa(>)p
Fe(fd,)c(0\))k(==)f(-1\))685 2719 y(goto)g(fail;)640
2884 y(/*)h(This)f(creates)g(an)g(endian-converted)e(header,)i(as)g(if)
h(read)f(from)g(disk)g(*/)640 2966 y(CONVERT\(*newdb\);)640
3048 y(memcpy\(&tdb-)p Fa(>)p Fe(header,)e(newdb,)i(sizeof\(tdb-)p
Fa(>)p Fe(header\)\);)640 3130 y(/*)h(Don't)f(endian-convert)e(the)j
(magic)f(food!)g(*/)640 3212 y(memcpy\(newdb-)p Fa(>)p
Fe(magic_food,)d(TDB_MAGIC_FOOD,)h(strlen\(TDB_MAGIC_FOOD\)+1\);)640
3295 y(if)j(\(write\(tdb-)p Fa(>)p Fe(fd,)d(newdb,)i(size\))g(!=)g
(size\))685 3377 y(ret)h(=)f(-1;)640 3459 y(else)685
3541 y(ret)h(=)f(tdb_create_rwlocks\(tdb-)p Fa(>)p Fe(fd,)c
(hash_size\);)685 3706 y(fail:)640 3788 y(SAFE_FREE\(newdb\);)640
3870 y(return)k(ret;)596 3952 y(})596 4116 y(/*)g(Returns)g(0)g(on)h
(fail.)89 b(On)44 b(success,)g(return)f(offset)h(of)h(record,)e(and)i
(fills)730 4199 y(in)g(rec)f(*/)596 4281 y(static)f(tdb_off)h
(tdb_find\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)g(key,)g(u32)g(hash,)730
4363 y(struct)g(list_struct)f(*r\))596 4445 y({)640 4527
y(tdb_off)h(rec_ptr;)640 4692 y(/*)h(read)f(in)g(the)h(hash)f(top)g(*/)
640 4774 y(if)h(\(ofs_read\(tdb,)d(TDB_HASH_TOP\(hash\),)g(&rec_ptr\))h
(==)i(-1\))685 4856 y(return)f(0;)640 5021 y(/*)h(keep)f(looking)g
(until)g(we)g(find)g(the)h(right)f(record)f(*/)640 5103
y(while)h(\(rec_ptr\))g({)685 5185 y(if)h(\(rec_read\(tdb,)d(rec_ptr,)i
(r\))g(==)h(-1\))730 5267 y(return)f(0;)685 5432 y(if)h
(\(!TDB_DEAD\(r\))d(&&)j(hash==r-)p Fa(>)p Fe(full_hash)d(&&)i
(key.dsize==r-)p Fa(>)p Fe(key_len\))d({)p Black 197
5585 a Fd(52)p Black eop
%%Page: 53 53
53 52 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 730 89 a Fe(char)44 b(*k;)730 171 y(/*)h(a)f(very)g(likely)g(hit)
g(-)h(read)f(the)h(key)f(*/)730 253 y(k)h(=)f(tdb_alloc_read\(tdb,)e
(rec_ptr)i(+)g(sizeof\(*r\),)954 336 y(r-)p Fa(>)p Fe(key_len\);)730
418 y(if)h(\(!k\))775 500 y(return)f(0;)730 664 y(if)h
(\(memcmp\(key.dptr,)c(k,)k(key.dsize\))e(==)i(0\))f({)775
747 y(SAFE_FREE\(k\);)775 829 y(return)g(rec_ptr;)730
911 y(})730 993 y(SAFE_FREE\(k\);)685 1075 y(})685 1158
y(rec_ptr)g(=)g(r-)p Fa(>)p Fe(next;)640 1240 y(})640
1322 y(return)g(TDB_ERRCODE\(TDB_ERR_NOEXIST,)c(0\);)596
1404 y(})596 1569 y(/*)k(If)h(they)f(do)g(lockkeys,)f(check)h(that)h
(this)f(hash)g(is)g(one)h(they)f(locked)g(*/)596 1651
y(static)f(int)i(tdb_keylocked\(TDB_CONTEXT)40 b(*tdb,)k(u32)h(hash\))
596 1733 y({)640 1815 y(u32)g(i;)640 1897 y(if)g(\(!tdb-)p
Fa(>)p Fe(lockedkeys\))685 1979 y(return)f(1;)640 2062
y(for)h(\(i)f(=)h(0;)f(i)h Fa(<)g Fe(tdb-)p Fa(>)p Fe(lockedkeys[0];)c
(i++\))685 2144 y(if)k(\(tdb-)p Fa(>)p Fe(lockedkeys[i+1])c(==)j
(hash\))730 2226 y(return)g(1;)640 2308 y(return)g
(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c(0\);)596 2390 y(})596
2555 y(/*)k(As)h(tdb_find,)e(but)h(if)h(you)f(succeed,)f(keep)i(the)f
(lock)g(*/)596 2637 y(static)f(tdb_off)h(tdb_find_lock\(TDB_CONTEXT)d
(*tdb,)j(TDB_DATA)f(key,)h(int)h(locktype,)954 2719 y(struct)f
(list_struct)f(*rec\))596 2801 y({)640 2884 y(u32)i(hash,)f(rec_ptr;)
640 3048 y(hash)h(=)f(tdb_hash\(&key\);)640 3130 y(if)h
(\(!tdb_keylocked\(tdb,)c(hash\)\))685 3212 y(return)j(0;)640
3295 y(if)h(\(tdb_lock\(tdb,)d(BUCKET\(hash\),)h(locktype\))g(==)i
(-1\))685 3377 y(return)f(0;)640 3459 y(if)h(\(!\(rec_ptr)e(=)i
(tdb_find\(tdb,)d(key,)i(hash,)g(rec\)\)\))685 3541 y(tdb_unlock\(tdb,)
e(BUCKET\(hash\),)h(locktype\);)640 3623 y(return)h(rec_ptr;)596
3706 y(})596 3870 y(enum)g(TDB_ERROR)f(tdb_error\(TDB_CONTEXT)e(*tdb\))
596 3952 y({)640 4034 y(return)j(tdb-)p Fa(>)p Fe(ecode;)596
4116 y(})596 4281 y(static)f(struct)h(tdb_errname)f({)640
4363 y(enum)i(TDB_ERROR)e(ecode;)h(const)g(char)g(*estring;)596
4445 y(})g(emap[])g(=)h({)f({TDB_SUCCESS,)f("Success"},)865
4527 y({TDB_ERR_CORRUPT,)e("Corrupt)j(database"},)865
4610 y({TDB_ERR_IO,)e("IO)j(Error"},)865 4692 y({TDB_ERR_LOCK,)d
("Locking)h(error"},)865 4774 y({TDB_ERR_OOM,)f("Out)i(of)h(memory"},)
865 4856 y({TDB_ERR_EXISTS,)d("Record)h(exists"},)865
4938 y({TDB_ERR_NOLOCK,)f("Lock)i(exists)f(on)i(other)f(keys"},)865
5021 y({TDB_ERR_NOEXIST,)d("Record)j(does)g(not)h(exist"})e(};)596
5185 y(/*)h(Error)g(string)g(for)g(the)g(last)h(tdb)f(error)g(*/)596
5267 y(const)g(char)g(*tdb_errorstr\(TDB_CONTEXT)c(*tdb\))596
5349 y({)640 5432 y(u32)45 b(i;)p Black 3601 5585 a Fd(53)p
Black eop
%%Page: 54 54
54 53 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(for)45 b(\(i)f(=)h(0;)f(i)h Fa(<)g
Fe(sizeof\(emap\))d(/)j(sizeof\(struct)e(tdb_errname\);)f(i++\))685
171 y(if)j(\(tdb-)p Fa(>)p Fe(ecode)e(==)h(emap[i].ecode\))730
253 y(return)g(emap[i].estring;)640 336 y(return)g("Invalid)g(error)g
(code";)596 418 y(})596 582 y(/*)g(update)g(an)g(entry)g(in)h(place)f
(-)g(this)h(only)f(works)g(if)g(the)h(new)f(data)g(size)730
664 y(is)h Fa(<)p Fe(=)f(the)g(old)h(data)f(size)g(and)g(the)h(key)f
(exists.)730 747 y(on)h(failure)e(return)h(-1)596 829
y(*/)596 911 y(static)f(int)i(tdb_update\(TDB_CONTEXT)c(*tdb,)j
(TDB_DATA)f(key,)h(TDB_DATA)g(dbuf\))596 993 y({)640
1075 y(struct)g(list_struct)f(rec;)640 1158 y(tdb_off)h(rec_ptr;)640
1240 y(int)h(ret)f(=)h(-1;)640 1404 y(/*)g(find)f(entry)g(*/)640
1486 y(if)h(\(!\(rec_ptr)e(=)i(tdb_find_lock\(tdb,)c(key,)k(F_WRLCK,)e
(&rec\)\)\))685 1569 y(return)h(-1;)640 1733 y(/*)h(must)f(be)g(long)h
(enough)e(key,)i(data)f(and)g(tailer)g(*/)640 1815 y(if)h
(\(rec.rec_len)e Fa(<)h Fe(key.dsize)g(+)g(dbuf.dsize)f(+)i
(sizeof\(tdb_off\)\))d({)685 1897 y(tdb-)p Fa(>)p Fe(ecode)h(=)i
(TDB_SUCCESS;)e(/*)h(Not)h(really)e(an)i(error)f(*/)685
1979 y(goto)g(out;)640 2062 y(})640 2226 y(if)h(\(tdb_write\(tdb,)d
(rec_ptr)i(+)g(sizeof\(rec\))f(+)i(rec.key_len,)954 2308
y(dbuf.dptr,)e(dbuf.dsize\))g(==)i(-1\))685 2390 y(goto)f(out;)640
2555 y(if)h(\(dbuf.dsize)e(!=)h(rec.data_len\))f({)685
2637 y(/*)i(update)e(size)i(*/)685 2719 y(rec.data_len)e(=)i
(dbuf.dsize;)685 2801 y(ret)g(=)f(rec_write\(tdb,)f(rec_ptr,)g(&rec\);)
640 2884 y(})i(else)685 2966 y(ret)g(=)f(0;)640 3048
y(out:)640 3130 y(tdb_unlock\(tdb,)f(BUCKET\(rec.full_hash\),)e
(F_WRLCK\);)640 3212 y(return)j(ret;)596 3295 y(})596
3459 y(/*)g(find)g(an)h(entry)f(in)g(the)g(database)g(given)g(a)h(key)f
(*/)596 3541 y(TDB_DATA)f(tdb_fetch\(TDB_CONTEXT)e(*tdb,)j(TDB_DATA)g
(key\))596 3623 y({)640 3706 y(tdb_off)g(rec_ptr;)640
3788 y(struct)g(list_struct)f(rec;)640 3870 y(TDB_DATA)h(ret;)640
4034 y(/*)h(find)f(which)g(hash)g(bucket)g(it)g(is)h(in)f(*/)640
4116 y(if)h(\(!\(rec_ptr)e(=)i
(tdb_find_lock\(tdb,key,F_RDLCK,&rec\)\)\))685 4199 y(return)f
(tdb_null;)640 4363 y(ret.dptr)g(=)g(tdb_alloc_read\(tdb,)e(rec_ptr)i
(+)g(sizeof\(rec\))f(+)i(rec.key_len,)865 4445 y(rec.data_len\);)640
4527 y(ret.dsize)f(=)g(rec.data_len;)640 4610 y(tdb_unlock\(tdb,)f
(BUCKET\(rec.full_hash\),)e(F_RDLCK\);)640 4692 y(return)j(ret;)596
4774 y(})596 4938 y(/*)g(check)g(if)g(an)h(entry)f(in)g(the)h(database)
e(exists)730 5103 y(note)h(that)g(1)h(is)f(returned)g(if)g(the)h(key)f
(is)h(found)f(and)g(0)h(is)f(returned)g(if)g(not)g(found)730
5185 y(this)g(doesn't)g(match)g(the)g(conventions)f(in)i(the)f(rest)g
(of)h(this)f(module,)f(but)i(is)730 5267 y(compatible)e(with)h(gdbm)596
5349 y(*/)596 5432 y(int)g(tdb_exists\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)f
(key\))p Black 197 5585 a Fd(54)p Black eop
%%Page: 55 55
55 54 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe({)640 171 y(struct)44 b(list_struct)f(rec;)640
336 y(if)i(\(tdb_find_lock\(tdb,)c(key,)k(F_RDLCK,)e(&rec\))h(==)h(0\))
685 418 y(return)f(0;)640 500 y(tdb_unlock\(tdb,)f
(BUCKET\(rec.full_hash\),)e(F_RDLCK\);)640 582 y(return)j(1;)596
664 y(})596 829 y(/*)g(record)g(lock)g(stops)g(delete)g(underneath)f
(*/)596 911 y(static)g(int)i(lock_record\(TDB_CONTEXT)c(*tdb,)j
(tdb_off)f(off\))596 993 y({)640 1075 y(return)h(off)g(?)h
(tdb_brlock\(tdb,)d(off,)j(F_RDLCK,)e(F_SETLKW,)g(0\))i(:)g(0;)596
1158 y(})596 1240 y(/*)685 1322 y(Write)f(locks)g(override)g(our)g(own)
g(fcntl)g(readlocks,)f(so)i(check)f(it)g(here.)685 1404
y(Note)g(this)g(is)h(meant)f(to)g(be)h(F_SETLK,)e(*not*)h(F_SETLKW,)g
(as)g(it's)g(not)685 1486 y(an)h(error)f(to)g(fail)g(to)h(get)f(the)g
(lock)h(here.)596 1569 y(*/)596 1733 y(static)e(int)i
(write_lock_record\(TDB_CONTEXT)40 b(*tdb,)k(tdb_off)f(off\))596
1815 y({)640 1897 y(struct)h(tdb_traverse_lock)e(*i;)640
1979 y(for)j(\(i)f(=)h(&tdb-)p Fa(>)p Fe(travlocks;)d(i;)i(i)h(=)g(i-)p
Fa(>)p Fe(next\))685 2062 y(if)g(\(i-)p Fa(>)p Fe(off)e(==)i(off\))730
2144 y(return)f(-1;)640 2226 y(return)g(tdb_brlock\(tdb,)e(off,)j
(F_WRLCK,)e(F_SETLK,)h(1\);)596 2308 y(})596 2473 y(/*)685
2555 y(Note)g(this)g(is)h(meant)f(to)g(be)h(F_SETLK,)e(*not*)h
(F_SETLKW,)g(as)g(it's)g(not)685 2637 y(an)h(error)f(to)g(fail)g(to)h
(get)f(the)g(lock)h(here.)596 2719 y(*/)596 2884 y(static)e(int)i
(write_unlock_record\(TDB_CONTEXT)39 b(*tdb,)44 b(tdb_off)g(off\))596
2966 y({)640 3048 y(return)g(tdb_brlock\(tdb,)e(off,)j(F_UNLCK,)e
(F_SETLK,)h(0\);)596 3130 y(})596 3212 y(/*)g(fcntl)g(locks)g(don't)g
(stack:)g(avoid)g(unlocking)f(someone)h(else's)g(*/)596
3295 y(static)f(int)i(unlock_record\(TDB_CONTEXT)40 b(*tdb,)k(tdb_off)g
(off\))596 3377 y({)640 3459 y(struct)g(tdb_traverse_lock)e(*i;)640
3541 y(u32)j(count)f(=)g(0;)640 3706 y(if)h(\(off)f(==)g(0\))685
3788 y(return)g(0;)640 3870 y(for)h(\(i)f(=)h(&tdb-)p
Fa(>)p Fe(travlocks;)d(i;)i(i)h(=)g(i-)p Fa(>)p Fe(next\))685
3952 y(if)g(\(i-)p Fa(>)p Fe(off)e(==)i(off\))730 4034
y(count++;)640 4116 y(return)f(\(count)g(==)g(1)h(?)g(tdb_brlock\(tdb,)
d(off,)i(F_UNLCK,)g(F_SETLKW,)f(0\))i(:)f(0\);)596 4199
y(})596 4363 y(/*)g(actually)f(delete)h(an)h(entry)f(in)g(the)h
(database)e(given)h(the)g(offset)g(*/)596 4445 y(static)f(int)i
(do_delete\(TDB_CONTEXT)c(*tdb,)j(tdb_off)g(rec_ptr,)f(struct)h
(list_struct*rec\))596 4527 y({)640 4610 y(tdb_off)g(last_ptr,)f(i;)640
4692 y(struct)h(list_struct)f(lastrec;)640 4856 y(if)i(\(tdb-)p
Fa(>)p Fe(read_only\))d(return)i(-1;)640 5021 y(if)h
(\(write_lock_record\(tdb,)c(rec_ptr\))i(==)i(-1\))f({)685
5103 y(/*)h(Someone)e(traversing)g(here:)h(mark)h(it)f(as)h(dead)f(*/)
685 5185 y(rec-)p Fa(>)p Fe(magic)f(=)i(TDB_DEAD_MAGIC;)685
5267 y(return)f(rec_write\(tdb,)e(rec_ptr,)i(rec\);)640
5349 y(})640 5432 y(write_unlock_record\(tdb,)d(rec_ptr\);)p
Black 3601 5585 a Fd(55)p Black eop
%%Page: 56 56
56 55 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 171 a Fe(/*)45 b(find)f(previous)f(record)h(in)h(hash)f
(chain)g(*/)640 253 y(if)h(\(ofs_read\(tdb,)d(TDB_HASH_TOP\(rec-)p
Fa(>)p Fe(full_hash\),)e(&i\))45 b(==)f(-1\))685 336
y(return)g(-1;)640 418 y(for)h(\(last_ptr)e(=)i(0;)f(i)h(!=)f(rec_ptr;)
g(last_ptr)f(=)i(i,)f(i)h(=)g(lastrec.next\))685 500
y(if)g(\(rec_read\(tdb,)d(i,)j(&lastrec\))e(==)h(-1\))730
582 y(return)g(-1;)640 747 y(/*)h(unlink)f(it:)g(next)g(ptr)g(is)h(at)f
(start)g(of)h(record.)f(*/)640 829 y(if)h(\(last_ptr)e(==)i(0\))685
911 y(last_ptr)f(=)g(TDB_HASH_TOP\(rec-)p Fa(>)p Fe(full_hash\);)640
993 y(if)h(\(ofs_write\(tdb,)d(last_ptr,)h(&rec-)p Fa(>)p
Fe(next\))g(==)i(-1\))685 1075 y(return)f(-1;)640 1240
y(/*)h(recover)e(the)i(space)f(*/)640 1322 y(if)h(\(tdb_free\(tdb,)d
(rec_ptr,)i(rec\))g(==)g(-1\))685 1404 y(return)g(-1;)640
1486 y(return)g(0;)596 1569 y(})596 1733 y(/*)g(Uses)g(traverse)g
(lock:)g(0)g(=)h(finish,)f(-1)g(=)h(error,)f(other)g(=)g(record)g
(offset)g(*/)596 1815 y(static)f(int)i(tdb_next_lock\(TDB_CONTEXT)40
b(*tdb,)k(struct)g(tdb_traverse_lock)e(*tlock,)775 1897
y(struct)i(list_struct)f(*rec\))596 1979 y({)640 2062
y(int)i(want_next)e(=)i(\(tlock-)p Fa(>)p Fe(off)e(!=)h(0\);)640
2226 y(/*)h(No)f(traversal)g(allows)f(if)i(you've)f(called)g
(tdb_lockkeys\(\))e(*/)640 2308 y(if)j(\(tdb-)p Fa(>)p
Fe(lockedkeys\))685 2390 y(return)f(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c
(-1\);)640 2555 y(/*)45 b(Lock)f(each)g(chain)g(from)g(the)h(start)f
(one.)g(*/)640 2637 y(for)h(\(;)f(tlock-)p Fa(>)p Fe(hash)f
Fa(<)i Fe(tdb-)p Fa(>)p Fe(header.hash_size;)c(tlock-)p
Fa(>)p Fe(hash++\))h({)685 2719 y(if)j(\(tdb_lock\(tdb,)d(tlock-)p
Fa(>)p Fe(hash,)h(F_WRLCK\))g(==)i(-1\))730 2801 y(return)f(-1;)685
2966 y(/*)h(No)f(previous)g(record?)88 b(Start)44 b(at)h(top)f(of)g
(chain.)g(*/)685 3048 y(if)h(\(!tlock-)p Fa(>)p Fe(off\))d({)730
3130 y(if)j(\(ofs_read\(tdb,)d(TDB_HASH_TOP\(tlock-)p
Fa(>)p Fe(hash\),)999 3212 y(&tlock-)p Fa(>)p Fe(off\))h(==)h(-1\))775
3295 y(goto)g(fail;)685 3377 y(})h(else)f({)730 3459
y(/*)h(Otherwise)e(unlock)h(the)g(previous)f(record.)h(*/)730
3541 y(unlock_record\(tdb,)e(tlock-)p Fa(>)p Fe(off\);)685
3623 y(})685 3788 y(if)j(\(want_next\))e({)730 3870 y(/*)i(We)f(have)g
(offset)g(of)g(old)h(record:)e(grab)i(next)f(*/)730 3952
y(if)h(\(rec_read\(tdb,)d(tlock-)p Fa(>)p Fe(off,)h(rec\))h(==)h(-1\))
775 4034 y(goto)f(fail;)730 4116 y(tlock-)p Fa(>)p Fe(off)f(=)i(rec-)p
Fa(>)p Fe(next;)685 4199 y(})685 4363 y(/*)g(Iterate)e(through)h(chain)
g(*/)685 4445 y(while\()g(tlock-)p Fa(>)p Fe(off\))f({)730
4527 y(tdb_off)h(current;)730 4610 y(if)h(\(rec_read\(tdb,)d(tlock-)p
Fa(>)p Fe(off,)h(rec\))h(==)h(-1\))775 4692 y(goto)f(fail;)730
4774 y(if)h(\(!TDB_DEAD\(rec\)\))d({)775 4856 y(/*)i(Woohoo:)g(we)g
(found)g(one!)h(*/)775 4938 y(lock_record\(tdb,)d(tlock-)p
Fa(>)p Fe(off\);)775 5021 y(return)i(tlock-)p Fa(>)p
Fe(off;)730 5103 y(})730 5185 y(/*)h(Try)f(to)g(clean)g(dead)g(ones)h
(from)f(old)g(traverses)f(*/)730 5267 y(current)h(=)g(tlock-)p
Fa(>)p Fe(off;)730 5349 y(tlock-)p Fa(>)p Fe(off)f(=)i(rec-)p
Fa(>)p Fe(next;)730 5432 y(do_delete\(tdb,)d(current,)i(rec\);)p
Black 197 5585 a Fd(56)p Black eop
%%Page: 57 57
57 56 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(})685 171 y(tdb_unlock\(tdb,)42 b(tlock-)p
Fa(>)p Fe(hash,)h(F_WRLCK\);)685 253 y(want_next)g(=)i(0;)640
336 y(})640 418 y(/*)g(We)f(finished)g(iteration)f(without)h(finding)f
(anything)h(*/)640 500 y(return)g(TDB_ERRCODE\(TDB_SUCCESS,)d(0\);)640
664 y(fail:)640 747 y(tlock-)p Fa(>)p Fe(off)i(=)i(0;)640
829 y(tdb_unlock\(tdb,)e(tlock-)p Fa(>)p Fe(hash,)f(F_WRLCK\);)640
911 y(return)i(-1;)596 993 y(})596 1158 y(/*)g(traverse)f(the)i(entire)
f(database)f(-)i(calling)e(fn\(tdb,)h(key,)g(data\))g(on)h(each)f
(element.)730 1240 y(return)g(-1)g(on)h(error)f(or)g(the)h(record)e
(count)h(traversed)730 1322 y(if)h(fn)f(is)g(NULL)h(then)f(it)g(is)h
(not)f(called)730 1404 y(a)h(non-zero)e(return)h(value)g(from)g(fn\(\))
g(indicates)g(that)g(the)g(traversal)f(should)h(stop)685
1486 y(*/)596 1569 y(int)g(tdb_traverse\(TDB_CONTEXT)d(*tdb,)j
(tdb_traverse_func)e(fn,)i(void)g(*state\))596 1651 y({)640
1733 y(TDB_DATA)g(key,)g(dbuf;)640 1815 y(struct)g(list_struct)f(rec;)
640 1897 y(struct)h(tdb_traverse_lock)e(tl)j(=)f({)h(NULL,)f(0,)g(0)h
(};)640 1979 y(int)g(ret,)f(count)g(=)g(0;)640 2144 y(/*)h(This)f(was)g
(in)h(the)f(initializaton,)f(above,)g(but)i(the)f(IRIX)g(compiler)685
2226 y(*)h(did)f(not)g(like)h(it.)89 b(crh)685 2308 y(*/)640
2390 y(tl.next)44 b(=)h(tdb-)p Fa(>)p Fe(travlocks.next;)640
2555 y(/*)g(fcntl)f(locks)g(don't)g(stack:)g(beware)f(traverse)h
(inside)g(traverse)f(*/)640 2637 y(tdb-)p Fa(>)p Fe(travlocks.next)f(=)
j(&tl;)640 2801 y(/*)g(tdb_next_lock)d(places)i(locks)g(on)h(the)f
(record)g(returned,)f(and)i(its)f(chain)g(*/)640 2884
y(while)g(\(\(ret)g(=)h(tdb_next_lock\(tdb,)d(&tl,)i(&rec\)\))g
Fa(>)g Fe(0\))h({)685 2966 y(count++;)685 3048 y(/*)g(now)f(read)g(the)
g(full)h(record)e(*/)685 3130 y(key.dptr)h(=)g(tdb_alloc_read\(tdb,)e
(tl.off)i(+)g(sizeof\(rec\),)909 3212 y(rec.key_len)f(+)i
(rec.data_len\);)685 3295 y(if)g(\(!key.dptr\))e({)730
3377 y(tdb_unlock\(tdb,)f(tl.hash,)i(F_WRLCK\);)730 3459
y(unlock_record\(tdb,)e(tl.off\);)730 3541 y(tdb-)p Fa(>)p
Fe(travlocks.next)g(=)i(tl.next;)730 3623 y(return)g(-1;)685
3706 y(})685 3788 y(key.dsize)f(=)i(rec.key_len;)685
3870 y(dbuf.dptr)e(=)i(key.dptr)f(+)g(rec.key_len;)685
3952 y(dbuf.dsize)f(=)i(rec.data_len;)685 4116 y(/*)g(Drop)f(chain)g
(lock,)g(call)g(out)g(*/)685 4199 y(tdb_unlock\(tdb,)e(tl.hash,)i
(F_WRLCK\);)685 4281 y(if)h(\(fn)f(&&)g(fn\(tdb,)g(key,)g(dbuf,)g
(state\)\))g({)730 4363 y(/*)h(They)f(want)g(us)g(to)h(terminate)e
(traversal)g(*/)730 4445 y(unlock_record\(tdb,)f(tl.off\);)730
4527 y(tdb-)p Fa(>)p Fe(travlocks.next)g(=)i(tl.next;)730
4610 y(SAFE_FREE\(key.dptr\);)730 4692 y(return)g(count;)685
4774 y(})685 4856 y(SAFE_FREE\(key.dptr\);)640 4938 y(})640
5021 y(tdb-)p Fa(>)p Fe(travlocks.next)e(=)j(tl.next;)640
5103 y(if)g(\(ret)f Fa(<)h Fe(0\))685 5185 y(return)f(-1;)640
5267 y(else)685 5349 y(return)g(count;)596 5432 y(})p
Black 3601 5585 a Fd(57)p Black eop
%%Page: 58 58
58 57 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(/*)44 b(find)g(the)g(first)g(entry)g(in)h(the)f
(database)g(and)g(return)g(its)g(key)h(*/)596 253 y(TDB_DATA)e
(tdb_firstkey\(TDB_CONTEXT)e(*tdb\))596 336 y({)640 418
y(TDB_DATA)j(key;)640 500 y(struct)g(list_struct)f(rec;)640
664 y(/*)i(release)e(any)i(old)f(lock)g(*/)640 747 y
(unlock_record\(tdb,)e(tdb-)p Fa(>)p Fe(travlocks.off\);)640
829 y(tdb-)p Fa(>)p Fe(travlocks.off)g(=)j(tdb-)p Fa(>)p
Fe(travlocks.hash)c(=)k(0;)640 993 y(if)g(\(tdb_next_lock\(tdb,)c
(&tdb-)p Fa(>)p Fe(travlocks,)i(&rec\))h Fa(<)p Fe(=)g(0\))685
1075 y(return)g(tdb_null;)640 1158 y(/*)h(now)f(read)g(the)h(key)f(*/)
640 1240 y(key.dsize)g(=)g(rec.key_len;)640 1322 y(key.dptr)g
(=tdb_alloc_read\(tdb,tdb-)p Fa(>)p Fe(travlocks.off)o(+sizeo)o(f\(rec)
o(\),key.)o(dsize\))o(;)640 1404 y(tdb_unlock\(tdb,)f(BUCKET\(tdb-)p
Fa(>)p Fe(travlocks.hash\),)d(F_WRLCK\);)640 1486 y(return)k(key;)596
1569 y(})596 1733 y(/*)g(find)g(the)g(next)h(entry)f(in)g(the)g
(database,)g(returning)f(its)h(key)h(*/)596 1815 y(TDB_DATA)e
(tdb_nextkey\(TDB_CONTEXT)e(*tdb,)j(TDB_DATA)f(oldkey\))596
1897 y({)640 1979 y(u32)i(oldhash;)640 2062 y(TDB_DATA)f(key)g(=)h
(tdb_null;)640 2144 y(struct)f(list_struct)f(rec;)640
2226 y(char)i(*k)f(=)h(NULL;)640 2390 y(/*)g(Is)f(locked)g(key)g(the)h
(old)f(key?)89 b(If)45 b(so,)f(traverse)f(will)i(be)f(reliable.)f(*/)
640 2473 y(if)i(\(tdb-)p Fa(>)p Fe(travlocks.off\))c({)685
2555 y(if)k(\(tdb_lock\(tdb,tdb-)p Fa(>)p Fe(travlocks.hash,F_W)o
(RLCK\)\))730 2637 y(return)f(tdb_null;)685 2719 y(if)h
(\(rec_read\(tdb,)d(tdb-)p Fa(>)p Fe(travlocks.off,)g(&rec\))i(==)g(-1)
865 2801 y(||)g(!\(k)g(=)h(tdb_alloc_read\(tdb,tdb-)p
Fa(>)p Fe(travlocks.off+s)o(izeof)o(\(rec\),)999 2884
y(rec.key_len\)\))865 2966 y(||)f(memcmp\(k,)f(oldkey.dptr,)g
(oldkey.dsize\))g(!=)h(0\))h({)730 3048 y(/*)g(No,)f(it)g(wasn't:)g
(unlock)g(it)g(and)h(start)f(from)g(scratch)f(*/)730
3130 y(unlock_record\(tdb,)f(tdb-)p Fa(>)p Fe(travlocks.off\);)730
3212 y(tdb_unlock\(tdb,)g(tdb-)p Fa(>)p Fe(travlocks.hash,)g
(F_WRLCK\);)730 3295 y(tdb-)p Fa(>)p Fe(travlocks.off)g(=)i(0;)685
3377 y(})685 3541 y(SAFE_FREE\(k\);)640 3623 y(})640
3788 y(if)h(\(!tdb-)p Fa(>)p Fe(travlocks.off\))c({)685
3870 y(/*)k(No)f(previous)g(element:)f(do)i(normal)e(find,)h(and)h
(lock)f(record)g(*/)685 3952 y(tdb-)p Fa(>)p Fe(travlocks.off)e(=)j
(tdb_find_lock\(tdb,)c(oldkey,)j(F_WRLCK,)f(&rec\);)685
4034 y(if)i(\(!tdb-)p Fa(>)p Fe(travlocks.off\))730 4116
y(return)f(tdb_null;)685 4199 y(tdb-)p Fa(>)p Fe(travlocks.hash)e(=)i
(BUCKET\(rec.full_hash\);)685 4281 y(lock_record\(tdb,)e(tdb-)p
Fa(>)p Fe(travlocks.off\);)640 4363 y(})640 4445 y(oldhash)i(=)h(tdb-)p
Fa(>)p Fe(travlocks.hash;)640 4610 y(/*)g(Grab)f(next)g(record:)g
(locks)g(chain)g(and)g(returned)g(record,)775 4692 y(unlocks)f(old)i
(record)f(*/)640 4774 y(if)h(\(tdb_next_lock\(tdb,)c(&tdb-)p
Fa(>)p Fe(travlocks,)i(&rec\))h Fa(>)g Fe(0\))h({)685
4856 y(key.dsize)e(=)i(rec.key_len;)685 4938 y(key.dptr)f(=)g
(tdb_alloc_read\(tdb,)e(tdb-)p Fa(>)p Fe(travlocks.off+sizeof\(rec\),)
909 5021 y(key.dsize\);)685 5103 y(/*)j(Unlock)e(the)i(chain)f(of)g
(this)g(new)h(record)f(*/)685 5185 y(tdb_unlock\(tdb,)e(tdb-)p
Fa(>)p Fe(travlocks.hash,)g(F_WRLCK\);)640 5267 y(})640
5349 y(/*)j(Unlock)f(the)g(chain)g(of)g(old)h(record)f(*/)640
5432 y(tdb_unlock\(tdb,)f(BUCKET\(oldhash\),)f(F_WRLCK\);)p
Black 197 5585 a Fd(58)p Black eop
%%Page: 59 59
59 58 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(return)44 b(key;)596 171 y(})596 336
y(/*)g(delete)g(an)g(entry)g(in)h(the)f(database)g(given)g(a)g(key)h
(*/)596 418 y(int)f(tdb_delete\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)f(key\))
596 500 y({)640 582 y(tdb_off)h(rec_ptr;)640 664 y(struct)g
(list_struct)f(rec;)640 747 y(int)i(ret;)640 911 y(if)g(\(!\(rec_ptr)e
(=)i(tdb_find_lock\(tdb,)c(key,)k(F_WRLCK,)e(&rec\)\)\))685
993 y(return)h(-1;)640 1075 y(ret)h(=)f(do_delete\(tdb,)f(rec_ptr,)g
(&rec\);)640 1158 y(tdb_unlock\(tdb,)g(BUCKET\(rec.full_hash\),)e
(F_WRLCK\);)640 1240 y(return)j(ret;)596 1322 y(})596
1486 y(/*)g(store)g(an)g(element)g(in)h(the)f(database,)f(replacing)h
(any)g(existing)f(element)730 1569 y(with)h(the)g(same)h(key)730
1733 y(return)f(0)g(on)h(success,)e(-1)i(on)f(failure)596
1815 y(*/)596 1897 y(int)g(tdb_store\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)g
(key,)g(TDB_DATA)f(dbuf,)h(int)h(flag\))596 1979 y({)640
2062 y(struct)f(list_struct)f(rec;)640 2144 y(u32)i(hash;)640
2226 y(tdb_off)f(rec_ptr;)640 2308 y(char)h(*p)f(=)h(NULL;)640
2390 y(int)g(ret)f(=)h(0;)640 2555 y(/*)g(find)f(which)g(hash)g(bucket)
g(it)g(is)h(in)f(*/)640 2637 y(hash)h(=)f(tdb_hash\(&key\);)640
2719 y(if)h(\(!tdb_keylocked\(tdb,)c(hash\)\))685 2801
y(return)j(-1;)640 2884 y(if)h(\(tdb_lock\(tdb,)d(BUCKET\(hash\),)h
(F_WRLCK\))g(==)i(-1\))685 2966 y(return)f(-1;)640 3130
y(/*)h(check)f(for)g(it)h(existing,)e(on)h(insert.)g(*/)640
3212 y(if)h(\(flag)f(==)g(TDB_INSERT\))f({)685 3295 y(if)i
(\(tdb_exists\(tdb,)d(key\)\))i({)730 3377 y(tdb-)p Fa(>)p
Fe(ecode)f(=)i(TDB_ERR_EXISTS;)730 3459 y(goto)f(fail;)685
3541 y(})640 3623 y(})h(else)f({)685 3706 y(/*)h(first)f(try)g
(in-place)f(update,)h(on)h(modify)e(or)i(replace.)e(*/)685
3788 y(if)i(\(tdb_update\(tdb,)d(key,)i(dbuf\))g(==)g(0\))730
3870 y(goto)g(out;)685 3952 y(if)h(\(flag)f(==)g(TDB_MODIFY)f(&&)i
(tdb-)p Fa(>)p Fe(ecode)e(==)h(TDB_ERR_NOEXIST\))730
4034 y(goto)g(fail;)640 4116 y(})640 4199 y(/*)h(reset)f(the)g(error)g
(code)g(potentially)f(set)i(by)f(the)g(tdb_update\(\))f(*/)640
4281 y(tdb-)p Fa(>)p Fe(ecode)g(=)i(TDB_SUCCESS;)640
4445 y(/*)g(delete)f(any)g(existing)f(record)h(-)h(if)f(it)h(doesn't)f
(exist)g(we)g(don't)1089 4527 y(care.)88 b(Doing)44 b(this)h(first)f
(reduces)f(fragmentation,)g(and)h(avoids)1089 4610 y(coalescing)f(with)
h(`allocated')f(block)h(before)g(it's)g(updated.)f(*/)640
4692 y(if)i(\(flag)f(!=)g(TDB_INSERT\))685 4774 y(tdb_delete\(tdb,)e
(key\);)640 4938 y(/*)j(Copy)f(key+value)f(*before*)h(allocating)f
(free)h(space)g(in)h(case)f(malloc)775 5021 y(fails)g(and)g(we)h(are)f
(left)g(with)g(a)h(dead)f(spot)g(in)h(the)f(tdb.)g(*/)640
5185 y(if)h(\(!\(p)f(=)h(\(char)f(*\)malloc\(key.dsize)d(+)k
(dbuf.dsize\)\)\))e({)685 5267 y(tdb-)p Fa(>)p Fe(ecode)g(=)i
(TDB_ERR_OOM;)685 5349 y(goto)f(fail;)640 5432 y(})p
Black 3601 5585 a Fd(59)p Black eop
%%Page: 60 60
60 59 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 171 a Fe(memcpy\(p,)44 b(key.dptr,)f(key.dsize\);)640
253 y(memcpy\(p+key.dsize,)f(dbuf.dptr,)h(dbuf.dsize\);)640
418 y(/*)i(now)f(we're)g(into)g(insert)g(/)h(modify)f(/)g(replace)g(of)
g(a)h(record)f(which)685 500 y(*)h(we)f(know)g(could)g(not)h(be)f
(optimised)g(by)g(an)h(in-place)e(store)h(\(for)685 582
y(*)h(various)e(reasons\).)89 b(*/)640 664 y(if)45 b(\(!\(rec_ptr)e(=)i
(tdb_allocate\(tdb,)d(key.dsize)h(+)i(dbuf.dsize,)e(&rec\)\)\))685
747 y(goto)h(fail;)640 911 y(/*)h(Read)f(hash)g(top)g(into)h(next)f
(ptr)g(*/)640 993 y(if)h(\(ofs_read\(tdb,)d(TDB_HASH_TOP\(hash\),)g
(&rec.next\))h(==)i(-1\))685 1075 y(goto)f(fail;)640
1240 y(rec.key_len)f(=)i(key.dsize;)640 1322 y(rec.data_len)e(=)i
(dbuf.dsize;)640 1404 y(rec.full_hash)e(=)i(hash;)640
1486 y(rec.magic)f(=)g(TDB_MAGIC;)640 1651 y(/*)h(write)f(out)g(and)g
(point)g(the)h(top)f(of)h(the)f(hash)g(chain)g(at)h(it)f(*/)640
1733 y(if)h(\(rec_write\(tdb,)d(rec_ptr,)i(&rec\))g(==)g(-1)820
1815 y(||)g(tdb_write\(tdb,)f(rec_ptr+sizeof\(rec\),)e(p,)k
(key.dsize+dbuf.dsize\)==-)596 1897 y(1)820 1979 y(||)f
(ofs_write\(tdb,)f(TDB_HASH_TOP\(hash\),)e(&rec_ptr\))j(==)g(-1\))g({)
640 2062 y(fail:)685 2144 y(/*)h(Need)f(to)g(tdb_unallocate\(\))e(here)
j(*/)685 2226 y(ret)g(=)f(-1;)640 2308 y(})640 2390 y(out:)640
2473 y(SAFE_FREE\(p\);)640 2555 y(tdb_unlock\(tdb,)f(BUCKET\(hash\),)f
(F_WRLCK\);)640 2637 y(return)i(ret;)596 2719 y(})596
2884 y(static)f(int)i(tdb_already_open\(dev_t)c(device,)909
2966 y(ino_t)j(ino\))596 3048 y({)640 3130 y(TDB_CONTEXT)f(*i;)640
3295 y(for)i(\(i)f(=)h(tdbs;)f(i;)g(i)h(=)g(i-)p Fa(>)p
Fe(next\))e({)685 3377 y(if)i(\(i-)p Fa(>)p Fe(device)e(==)h(device)g
(&&)h(i-)p Fa(>)p Fe(inode)e(==)h(ino\))h({)730 3459
y(return)f(1;)685 3541 y(})640 3623 y(})640 3788 y(return)g(0;)596
3870 y(})596 4034 y(/*)g(open)g(the)g(database,)g(creating)f(it)i(if)f
(necessary)730 4199 y(The)g(open_flags)f(and)i(mode)f(are)g(passed)g
(straight)g(to)g(the)g(open)h(call)f(on)g(the)730 4281
y(database)f(file.)h(A)h(flags)f(value)g(of)h(O_WRONLY)e(is)i(invalid.)
e(The)h(hash)h(size)730 4363 y(is)g(advisory,)e(use)h(zero)g(for)h(a)f
(default)g(value.)730 4527 y(Return)g(is)g(NULL)g(on)h(error,)f(in)g
(which)g(case)g(errno)g(is)h(also)f(set.)89 b(Don't)730
4610 y(try)44 b(to)h(call)f(tdb_error)f(or)i(tdb_errname,)e(just)h(do)g
(strerror\(errno\).)730 4774 y(@param)g(name)g(may)g(be)h(NULL)f(for)g
(internal)g(databases.)f(*/)596 4856 y(TDB_CONTEXT)f(*tdb_open\(const)h
(char)h(*name,)g(int)g(hash_size,)f(int)i(tdb_flags,)954
4938 y(int)f(open_flags,)f(mode_t)h(mode\))596 5021 y({)640
5103 y(return)g(tdb_open_ex\(name,)e(hash_size,)h(tdb_flags,)g
(open_flags,)g(mode,)h(NULL\);)596 5185 y(})596 5432
y(TDB_CONTEXT)e(*tdb_open_ex\(const)g(char)i(*name,)g(int)h(hash_size,)
e(int)h(tdb_flags,)p Black 197 5585 a Fd(60)p Black eop
%%Page: 61 61
61 60 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 775 89 a Fe(int)44 b(open_flags,)f(mode_t)h(mode,)775
171 y(tdb_log_func)f(log_fn\))596 253 y({)640 336 y(TDB_CONTEXT)g
(*tdb;)640 418 y(struct)h(stat)g(st;)640 500 y(int)h(rev)f(=)h(0,)f
(locked;)640 664 y(if)h(\(!\(tdb)f(=)g(calloc\(1,)g(sizeof)f
(*tdb\)\)\))h({)685 747 y(/*)h(Can't)f(log)g(this)g(*/)685
829 y(errno)g(=)h(ENOMEM;)685 911 y(goto)f(fail;)640
993 y(})640 1075 y(tdb-)p Fa(>)p Fe(fd)g(=)h(-1;)640
1158 y(tdb-)p Fa(>)p Fe(name)f(=)g(NULL;)640 1240 y(tdb-)p
Fa(>)p Fe(map_ptr)f(=)i(NULL;)640 1322 y(tdb-)p Fa(>)p
Fe(lockedkeys)e(=)h(NULL;)640 1404 y(tdb-)p Fa(>)p Fe(flags)f(=)i
(tdb_flags;)640 1486 y(tdb-)p Fa(>)p Fe(open_flags)e(=)h(open_flags;)
640 1569 y(tdb-)p Fa(>)p Fe(log_fn)f(=)i(log_fn;)640
1733 y(if)g(\(\(open_flags)e(&)h(O_ACCMODE\))f(==)i(O_WRONLY\))e({)685
1815 y(TDB_LOG\(\(tdb,)g(0,)h("tdb_open_ex:)f(can't)h(open)g(tdb)g
(\045s)h(write-only\\n",)775 1897 y(name\)\);)685 1979
y(errno)f(=)h(EINVAL;)685 2062 y(goto)f(fail;)640 2144
y(})640 2308 y(if)h(\(hash_size)e(==)h(0\))685 2390 y(hash_size)f(=)i
(DEFAULT_HASH_SIZE;)640 2473 y(if)g(\(\(open_flags)e(&)h(O_ACCMODE\))f
(==)i(O_RDONLY\))e({)685 2555 y(tdb-)p Fa(>)p Fe(read_only)g(=)h(1;)685
2637 y(/*)h(read)f(only)g(databases)f(don't)h(do)h(locking)e(or)i
(clear)f(if)g(first)g(*/)685 2719 y(tdb-)p Fa(>)p Fe(flags)f(|=)i
(TDB_NOLOCK;)685 2801 y(tdb-)p Fa(>)p Fe(flags)e(&=)i
(~TDB_CLEAR_IF_FIRST;)640 2884 y(})640 3048 y(/*)g(internal)e
(databases)h(don't)g(mmap)g(or)g(lock,)g(and)h(start)f(off)g(cleared)g
(*/)640 3130 y(if)h(\(tdb-)p Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))f({)
685 3212 y(tdb-)p Fa(>)p Fe(flags)g(|=)i(\(TDB_NOLOCK)e(|)h
(TDB_NOMMAP\);)685 3295 y(tdb-)p Fa(>)p Fe(flags)f(&=)i
(~TDB_CLEAR_IF_FIRST;)685 3377 y(tdb_new_database\(tdb,)c(hash_size\);)
685 3459 y(goto)j(internal;)640 3541 y(})640 3706 y(if)h(\(\(tdb-)p
Fa(>)p Fe(fd)e(=)i(open\(name,)e(open_flags,)g(mode\)\))h(==)g(-1\))h
({)685 3788 y(TDB_LOG\(\(tdb,)e(5,)h("tdb_open_ex:)f(could)h(not)g
(open)g(file)h(\045s:)f(\045s\\n",)775 3870 y(name,)g
(strerror\(errno\)\)\);)685 3952 y(goto)g(fail;)g(/*)h(errno)f(set)g
(by)h(open\(2\))e(*/)640 4034 y(})640 4199 y(/*)i(ensure)f(there)g(is)g
(only)g(one)h(process)e(initialising)g(at)i(once)f(*/)640
4281 y(if)h(\(tdb_brlock\(tdb,)d(GLOBAL_LOCK,)h(F_WRLCK,)g(F_SETLKW,)h
(0\))g(==)h(-1\))f({)685 4363 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_open_ex:)f
(failed)h(to)g(get)h(global)e(lock)i(on)f(\045s:)g(\045s\\n",)775
4445 y(name,)g(strerror\(errno\)\)\);)685 4527 y(goto)g(fail;)g(/*)h
(errno)f(set)g(by)h(tdb_brlock)e(*/)640 4610 y(})640
4774 y(/*)i(we)f(need)g(to)h(zero)f(database)g(if)g(we)h(are)f(the)g
(only)g(one)h(with)f(it)g(open)h(*/)640 4856 y(if)g(\(\(locked)e(=)i
(\(tdb_brlock\(tdb,)d(ACTIVE_LOCK,)h(F_WRLCK,)g(F_SETLK,)h(0\))g(==)h
(0\)\))820 4938 y(&&)f(\(tdb_flags)f(&)i(TDB_CLEAR_IF_FIRST\)\))c({)685
5021 y(open_flags)i(|=)i(O_CREAT;)685 5103 y(if)g(\(ftruncate\(tdb-)p
Fa(>)p Fe(fd,)c(0\))k(==)f(-1\))h({)730 5185 y(TDB_LOG\(\(tdb,)e(0,)h
("tdb_open_ex:)f(")820 5267 y("failed)g(to)i(truncate)e(\045s:)i
(\045s\\n",)820 5349 y(name,)f(strerror\(errno\)\)\);)730
5432 y(goto)g(fail;)g(/*)h(errno)f(set)g(by)g(ftruncate)g(*/)p
Black 3601 5585 a Fd(61)p Black eop
%%Page: 62 62
62 61 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 685 89 a Fe(})640 171 y(})640 336 y(if)45 b(\(read\(tdb-)p
Fa(>)p Fe(fd,)d(&tdb-)p Fa(>)p Fe(header,)h(sizeof\(tdb-)p
Fa(>)p Fe(header\)\))e(!=)k(sizeof\(tdb-)596 418 y Fa(>)p
Fe(header\))820 500 y(||)f(strcmp\(tdb-)p Fa(>)p Fe(header.magic_food,)
c(TDB_MAGIC_FOOD\))i(!=)j(0)820 582 y(||)f(\(tdb-)p Fa(>)p
Fe(header.version)e(!=)i(TDB_VERSION)685 664 y(&&)h(!\(rev)f(=)g
(\(tdb-)p Fa(>)p Fe(header.version==TDB_BYTEREV\(TDB_VER)o(SION\))o
(\)\)\)\))39 b({)685 747 y(/*)45 b(its)f(not)g(a)h(valid)f(database)f
(-)i(possibly)f(initialise)f(it)h(*/)685 829 y(if)h(\(!\(open_flags)d
(&)j(O_CREAT\))e(||)i(tdb_new_database\(tdb,)c(hash_size\))i(==)i(-)596
911 y(1\))f({)730 993 y(errno)g(=)h(EIO;)f(/*)g(ie)h(bad)f(format)g(or)
g(something)g(*/)730 1075 y(goto)g(fail;)685 1158 y(})685
1240 y(rev)h(=)f(\(tdb-)p Fa(>)p Fe(flags)f(&)i(TDB_CONVERT\);)640
1322 y(})640 1404 y(if)g(\(!rev\))685 1486 y(tdb-)p Fa(>)p
Fe(flags)e(&=)i(~TDB_CONVERT;)640 1569 y(else)g({)685
1651 y(tdb-)p Fa(>)p Fe(flags)e(|=)i(TDB_CONVERT;)685
1733 y(convert\(&tdb-)p Fa(>)p Fe(header,)c(sizeof\(tdb-)p
Fa(>)p Fe(header\)\);)640 1815 y(})640 1897 y(if)k(\(fstat\(tdb-)p
Fa(>)p Fe(fd,)d(&st\))i(==)h(-1\))685 1979 y(goto)f(fail;)640
2144 y(/*)h(Is)f(it)h(already)e(in)i(the)f(open)g(list?)89
b(If)45 b(so,)f(fail.)g(*/)640 2226 y(if)h
(\(tdb_already_open\(st.st_dev,)40 b(st.st_ino\)\))j({)685
2308 y(TDB_LOG\(\(tdb,)g(2,)h("tdb_open_ex:)f(")775 2390
y("\045s)h(\(\045d,\045d\))g(is)g(already)g(open)g(in)h(this)f
(process\\n",)775 2473 y(name,)g(st.st_dev,)f(st.st_ino\)\);)685
2555 y(errno)h(=)h(EBUSY;)685 2637 y(goto)f(fail;)640
2719 y(})640 2884 y(if)h(\(!\(tdb-)p Fa(>)p Fe(name)e(=)h(\(char)g
(*\)strdup\(name\)\)\))e({)685 2966 y(errno)i(=)h(ENOMEM;)685
3048 y(goto)f(fail;)640 3130 y(})640 3295 y(tdb-)p Fa(>)p
Fe(map_size)f(=)i(st.st_size;)640 3377 y(tdb-)p Fa(>)p
Fe(device)e(=)i(st.st_dev;)640 3459 y(tdb-)p Fa(>)p Fe(inode)e(=)i
(st.st_ino;)640 3541 y(tdb-)p Fa(>)p Fe(locked)e(=)i(calloc\(tdb-)p
Fa(>)p Fe(header.hash_size+1,)39 b(sizeof\(tdb-)p Fa(>)p
Fe(locked[0]\)\);)640 3623 y(if)45 b(\(!tdb-)p Fa(>)p
Fe(locked\))d({)685 3706 y(TDB_LOG\(\(tdb,)h(2,)h("tdb_open_ex:)f(")775
3788 y("failed)g(to)i(allocate)e(lock)i(structure)e(for)h(\045s\\n",)
775 3870 y(name\)\);)685 3952 y(errno)g(=)h(ENOMEM;)685
4034 y(goto)f(fail;)640 4116 y(})640 4199 y(tdb_mmap\(tdb\);)640
4281 y(if)h(\(locked\))e({)685 4363 y(if)i(\(!tdb-)p
Fa(>)p Fe(read_only\))730 4445 y(tdb_clear_spinlocks\(tdb\);)685
4527 y(if)g(\(tdb_brlock\(tdb,)d(ACTIVE_LOCK,)h(F_UNLCK,)g(F_SETLK,)h
(0\))g(==)h(-1\))f({)730 4610 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_open_ex:)f
(")820 4692 y("failed)g(to)i(take)f(ACTIVE_LOCK)f(on)h(\045s:)h
(\045s\\n",)820 4774 y(name,)f(strerror\(errno\)\)\);)730
4856 y(goto)g(fail;)685 4938 y(})640 5021 y(})640 5103
y(/*)h(leave)f(this)g(lock)g(in)h(place)f(to)g(indicate)g(it's)g(in)g
(use)h(*/)640 5185 y(if)g(\(tdb_brlock\(tdb,)d(ACTIVE_LOCK,)h(F_RDLCK,)
g(F_SETLKW,)h(0\))g(==)h(-1\))685 5267 y(goto)f(fail;)640
5432 y(internal:)p Black 197 5585 a Fd(62)p Black eop
%%Page: 63 63
63 62 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(/*)45 b(Internal)e(\(memory-only\))g(databases)g
(skip)h(all)h(the)f(code)g(above)g(to)685 171 y(*)h(do)f(with)g(disk)h
(files,)e(and)i(resume)f(here)g(by)g(releasing)g(their)685
253 y(*)h(global)f(lock)g(and)g(hooking)g(into)g(the)g(active)g(list.)g
(*/)640 336 y(if)h(\(tdb_brlock\(tdb,)d(GLOBAL_LOCK,)h(F_UNLCK,)g
(F_SETLKW,)h(0\))g(==)h(-1\))685 418 y(goto)f(fail;)640
500 y(tdb-)p Fa(>)p Fe(next)g(=)g(tdbs;)640 582 y(tdbs)h(=)f(tdb;)640
664 y(return)g(tdb;)640 829 y(fail:)640 911 y({)h(int)f(save_errno)f(=)
i(errno;)640 1075 y(if)g(\(!tdb\))685 1158 y(return)f(NULL;)640
1322 y(if)h(\(tdb-)p Fa(>)p Fe(map_ptr\))d({)685 1404
y(if)j(\(tdb-)p Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))730
1486 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(map_ptr\);)685 1569
y(else)730 1651 y(tdb_munmap\(tdb\);)640 1733 y(})640
1815 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(name\);)640 1897 y(if)h(\(tdb-)p
Fa(>)p Fe(fd)e(!=)i(-1\))685 1979 y(close\(tdb-)p Fa(>)p
Fe(fd\);)640 2062 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(locked\);)640
2144 y(errno)f(=)h(save_errno;)640 2226 y(return)f(NULL;)640
2308 y(})596 2390 y(})596 2555 y(/*)g(close)g(a)h(database)e(*/)596
2637 y(int)h(tdb_close\(TDB_CONTEXT)d(*tdb\))596 2719
y({)640 2801 y(TDB_CONTEXT)i(**i;)640 2884 y(int)i(ret)f(=)h(0;)640
3048 y(if)g(\(tdb-)p Fa(>)p Fe(map_ptr\))d({)685 3130
y(if)j(\(tdb-)p Fa(>)p Fe(flags)e(&)h(TDB_INTERNAL\))730
3212 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(map_ptr\);)685 3295
y(else)730 3377 y(tdb_munmap\(tdb\);)640 3459 y(})640
3541 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(name\);)640 3623 y(if)h(\(tdb-)p
Fa(>)p Fe(fd)e(!=)i(-1\))685 3706 y(ret)g(=)f(close\(tdb-)p
Fa(>)p Fe(fd\);)640 3788 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(locked\);)640
3870 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(lockedkeys\);)640
4034 y(/*)h(Remove)f(from)g(contexts)f(list)h(*/)640
4116 y(for)h(\(i)f(=)h(&tdbs;)f(*i;)g(i)h(=)f(&\(*i\)-)p
Fa(>)p Fe(next\))f({)685 4199 y(if)i(\(*i)f(==)g(tdb\))h({)730
4281 y(*i)g(=)f(tdb-)p Fa(>)p Fe(next;)730 4363 y(break;)685
4445 y(})640 4527 y(})640 4692 y(memset\(tdb,)f(0,)i(sizeof\(*tdb\)\);)
640 4774 y(SAFE_FREE\(tdb\);)640 4938 y(return)f(ret;)596
5021 y(})596 5185 y(/*)g(lock/unlock)f(entire)h(database)f(*/)596
5267 y(int)h(tdb_lockall\(TDB_CONTEXT)d(*tdb\))596 5349
y({)640 5432 y(u32)k(i;)p Black 3601 5585 a Fd(63)p Black
eop
%%Page: 64 64
64 63 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 171 a Fe(/*)45 b(There)f(are)g(no)h(locks)f(on)g(read-only)f
(dbs)i(*/)640 253 y(if)g(\(tdb-)p Fa(>)p Fe(read_only\))685
336 y(return)f(TDB_ERRCODE\(TDB_ERR_LOCK,)d(-1\);)640
418 y(if)k(\(tdb-)p Fa(>)p Fe(lockedkeys\))685 500 y(return)f
(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c(-1\);)640 582 y(for)45
b(\(i)f(=)h(0;)f(i)h Fa(<)g Fe(tdb-)p Fa(>)p Fe(header.hash_size;)c
(i++\))685 664 y(if)k(\(tdb_lock\(tdb,)d(i,)j(F_WRLCK\)\))730
747 y(break;)640 911 y(/*)g(If)f(error,)g(release)g(locks)g(we)g
(have...)g(*/)640 993 y(if)h(\(i)f Fa(<)h Fe(tdb-)p Fa(>)p
Fe(header.hash_size\))c({)685 1075 y(u32)k(j;)685 1240
y(for)g(\()f(j)h(=)f(0;)h(j)g Fa(<)f Fe(i;)h(j++\))730
1322 y(tdb_unlock\(tdb,)d(j,)j(F_WRLCK\);)685 1404 y(return)f
(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c(-1\);)640 1486 y(})640
1651 y(return)k(0;)596 1733 y(})596 1815 y(void)g
(tdb_unlockall\(TDB_CONTEXT)c(*tdb\))596 1897 y({)640
1979 y(u32)45 b(i;)640 2062 y(for)g(\(i=0;)f(i)g Fa(<)h
Fe(tdb-)p Fa(>)p Fe(header.hash_size;)c(i++\))685 2144
y(tdb_unlock\(tdb,)h(i,)j(F_WRLCK\);)596 2226 y(})596
2390 y(int)f(tdb_lockkeys\(TDB_CONTEXT)d(*tdb,)j(u32)g(number,)g
(TDB_DATA)f(keys[]\))596 2473 y({)640 2555 y(u32)i(i,)f(j,)h(hash;)640
2719 y(/*)g(Can't)f(lock)g(more)g(keys)g(if)h(already)e(locked)h(*/)640
2801 y(if)h(\(tdb-)p Fa(>)p Fe(lockedkeys\))685 2884
y(return)f(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c(-1\);)640 2966
y(if)45 b(\(!\(tdb-)p Fa(>)p Fe(lockedkeys)d(=)i(malloc\(sizeof\(u32\))
e(*)j(\(number+1\)\)\)\))685 3048 y(return)f(TDB_ERRCODE\(TDB_ERR_OOM,)
d(-1\);)640 3130 y(/*)k(First)f(number)g(in)g(array)g(is)h(#)f(keys)g
(*/)640 3212 y(tdb-)p Fa(>)p Fe(lockedkeys[0])e(=)j(number;)640
3377 y(/*)g(Insertion)e(sort)h(by)h(bucket)f(*/)640 3459
y(for)h(\(i)f(=)h(0;)f(i)h Fa(<)g Fe(number;)e(i++\))h({)685
3541 y(hash)g(=)h(tdb_hash\(&keys[i]\);)685 3623 y(for)g(\(j)f(=)h(0;)f
(j)h Fa(<)f Fe(i)h(&&)g(BUCKET\(tdb-)p Fa(>)p Fe(lockedkeys[j+1]\))40
b Fa(<)k Fe(BUCKET\(hash\);)f(j++\);)730 3706 y(memmove\(&tdb-)p
Fa(>)p Fe(lockedkeys[j+2],)d(&tdb-)p Fa(>)p Fe(lockedkeys[j+1],)h
(sizeof\(u32\))i(*)h(\(i-)596 3788 y(j\)\);)685 3870
y(tdb-)p Fa(>)p Fe(lockedkeys[j+1])e(=)i(hash;)640 3952
y(})640 4034 y(/*)h(Finally,)e(lock)h(in)h(order)f(*/)640
4116 y(for)h(\(i)f(=)h(0;)f(i)h Fa(<)g Fe(number;)e(i++\))685
4199 y(if)i(\(tdb_lock\(tdb,)d(i,)j(F_WRLCK\)\))730 4281
y(break;)640 4445 y(/*)g(If)f(error,)g(release)g(locks)g(we)g(have...)g
(*/)640 4527 y(if)h(\(i)f Fa(<)h Fe(number\))f({)685
4610 y(for)h(\()f(j)h(=)f(0;)h(j)g Fa(<)f Fe(i;)h(j++\))730
4692 y(tdb_unlock\(tdb,)d(j,)j(F_WRLCK\);)685 4774 y(SAFE_FREE\(tdb-)p
Fa(>)p Fe(lockedkeys\);)685 4856 y(return)f
(TDB_ERRCODE\(TDB_ERR_NOLOCK,)c(-1\);)640 4938 y(})640
5021 y(return)k(0;)596 5103 y(})596 5267 y(/*)g(Unlock)g(the)g(keys)g
(previously)f(locked)h(by)h(tdb_lockkeys\(\))d(*/)596
5349 y(void)i(tdb_unlockkeys\(TDB_CONTEXT)c(*tdb\))596
5432 y({)p Black 197 5585 a Fd(64)p Black eop
%%Page: 65 65
65 64 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 640 89 a Fe(u32)45 b(i;)640 171 y(for)g(\(i)f(=)h(0;)f(i)h
Fa(<)g Fe(tdb-)p Fa(>)p Fe(lockedkeys[0];)c(i++\))685
253 y(tdb_unlock\(tdb,)h(tdb-)p Fa(>)p Fe(lockedkeys[i+1],)g
(F_WRLCK\);)640 336 y(SAFE_FREE\(tdb-)p Fa(>)p Fe(lockedkeys\);)596
418 y(})596 582 y(/*)i(lock/unlock)f(one)h(hash)g(chain.)g(This)g(is)h
(meant)f(to)g(be)h(used)f(to)h(reduce)730 664 y(contention)e(-)i(it)f
(cannot)g(guarantee)f(how)i(many)f(records)g(will)g(be)g(locked)g(*/)
596 747 y(int)g(tdb_chainlock\(TDB_CONTEXT)c(*tdb,)k(TDB_DATA)g(key\))
596 829 y({)640 911 y(return)g(tdb_lock\(tdb,)f
(BUCKET\(tdb_hash\(&key\)\),)e(F_WRLCK\);)596 993 y(})596
1075 y(void)j(tdb_chainunlock\(TDB_CONTEXT)c(*tdb,)k(TDB_DATA)f(key\))
596 1158 y({)640 1240 y(tdb_unlock\(tdb,)g(BUCKET\(tdb_hash\(&key\)\),)
e(F_WRLCK\);)596 1322 y(})596 1569 y(/*)j(register)f(a)i(loging)f
(function)f(*/)596 1651 y(void)h(tdb_logging_function\(TDB_CONTEXT)39
b(*tdb,)44 b(void)g(\(*fn\)\(TDB_CONTEXT)e(*,)j(int)f(,)h(const)f(char)
g(*,)g(...\)\))596 1733 y({)640 1815 y(tdb-)p Fa(>)p
Fe(log_fn)f(=)i(fn;)596 1897 y(})596 2144 y(/*)f(reopen)g(a)g(tdb)h(-)f
(this)h(is)f(used)g(after)g(a)h(fork)f(to)h(ensure)e(that)i(we)f(have)g
(an)h(independent)730 2226 y(seek)f(pointer)g(from)g(our)g(parent)g
(and)g(to)h(re-establish)e(locks)h(*/)596 2308 y(int)g
(tdb_reopen\(TDB_CONTEXT)d(*tdb\))596 2390 y({)640 2473
y(struct)j(stat)g(st;)640 2637 y(tdb_munmap\(tdb\);)640
2719 y(close\(tdb-)p Fa(>)p Fe(fd\);)640 2801 y(tdb-)p
Fa(>)p Fe(fd)g(=)h(open\(tdb-)p Fa(>)p Fe(name,)d(tdb-)p
Fa(>)p Fe(open_flags)g(&)j(~\(O_CREAT|O_TRUNC\),)c(0\);)640
2884 y(if)k(\(tdb-)p Fa(>)p Fe(fd)e(==)i(-1\))f({)685
2966 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_reopen:)f(open)h(failed)g
(\(\045s\)\\n",)g(strerror\(errno\)\)\);)685 3048 y(goto)g(fail;)640
3130 y(})640 3212 y(fstat\(tdb-)p Fa(>)p Fe(fd,)f(&st\);)640
3295 y(if)i(\(st.st_ino)e(!=)h(tdb-)p Fa(>)p Fe(inode)g(||)g(st.st_dev)
f(!=)i(tdb-)p Fa(>)p Fe(device\))e({)685 3377 y(TDB_LOG\(\(tdb,)g(0,)h
("tdb_reopen:)f(file)h(dev/inode)g(has)g(changed!\\n"\)\);)685
3459 y(goto)g(fail;)640 3541 y(})640 3623 y(tdb_mmap\(tdb\);)640
3706 y(if)h(\(tdb_brlock\(tdb,)d(ACTIVE_LOCK,)h(F_RDLCK,)g(F_SETLKW,)h
(0\))g(==)h(-1\))f({)685 3788 y(TDB_LOG\(\(tdb,)f(0,)h("tdb_reopen:)f
(failed)h(to)g(obtain)g(active)g(lock\\n"\)\);)685 3870
y(goto)g(fail;)640 3952 y(})640 4116 y(return)g(0;)596
4281 y(fail:)640 4363 y(tdb_close\(tdb\);)640 4445 y(return)g(-1;)596
4527 y(})596 4692 y(/*)g(reopen)g(all)g(tdb's)g(*/)596
4774 y(int)g(tdb_reopen_all\(void\))596 4856 y({)640
4938 y(TDB_CONTEXT)f(*tdb;)640 5103 y(for)i(\(tdb=tdbs;)e(tdb;)h(tdb)g
(=)h(tdb-)p Fa(>)p Fe(next\))e({)685 5185 y(if)i(\(tdb_reopen\(tdb\))d
(!=)i(0\))h(return)f(-1;)640 5267 y(})640 5432 y(return)g(0;)p
Black 3601 5585 a Fd(65)p Black eop
%%Page: 66 66
66 65 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(})596 263 y Fd(Code:)g(/home/mikal/opensour)o
(ce/trivsql/tdb.c)596 429 y Fe(#ifndef)43 b(__SPINLOCK_H__)596
511 y(#define)g(__SPINLOCK_H__)596 675 y(#if)h(HAVE_CONFIG_H)596
757 y(#include)f Fa(<)p Fe(config.h)p Fa(>)596 840 y
Fe(#endif)596 1004 y(#include)g Fa(<)p Fe(trivsql_tdb.h)p
Fa(>)596 1168 y Fe(#ifdef)g(USE_SPINLOCKS)596 1333 y(#define)g
(RWLOCK_BIAS)g(0x1000UL)596 1497 y(/*)h(OS)h(SPECIFIC)e(*/)596
1579 y(#define)g(MAX_BUSY_LOOPS)g(1000)596 1662 y(#undef)g
(USE_SCHED_YIELD)596 1826 y(/*)h(ARCH)g(SPECIFIC)g(*/)596
1908 y(/*)g(We)h(should)e(make)h(sure)h(these)f(are)g(padded)g(to)g(a)h
(cache)f(line)g(*/)596 1990 y(#if)g(defined\(SPARC_SPINLOCKS\))596
2072 y(typedef)f(volatile)h(char)g(spinlock_t;)596 2155
y(#elif)g(defined\(POWERPC_SPINLOCKS\))596 2237 y(typedef)f(volatile)h
(unsigned)f(long)h(spinlock_t;)596 2319 y(#elif)g
(defined\(INTEL_SPINLOCKS\))596 2401 y(typedef)f(volatile)h(int)g
(spinlock_t;)596 2483 y(#elif)g(defined\(MIPS_SPINLOCKS\))596
2566 y(typedef)f(volatile)h(unsigned)f(long)h(spinlock_t;)596
2648 y(#else)596 2730 y(#error)f(Need)h(to)h(implement)e(spinlock)h
(code)g(in)g(spinlock.h)596 2812 y(#endif)596 2977 y(typedef)f(struct)h
({)640 3059 y(spinlock_t)f(lock;)640 3141 y(volatile)h(int)g(count;)596
3223 y(})g(tdb_rwlock_t;)596 3388 y(int)g(tdb_spinlock\(TDB_CONTEXT)d
(*tdb,)j(int)g(list,)g(int)g(rw_type\);)596 3470 y(int)g
(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k(int)h(list,)f(int)g(rw_type\);)
596 3552 y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g(int)g
(hash_size\);)596 3634 y(int)g(tdb_clear_spinlocks\(TDB_CONTEXT)39
b(*tdb\);)596 3799 y(#else)44 b(/*)g(!USE_SPINLOCKS)e(*/)596
3881 y(#if)i(0)596 3963 y(#define)f(tdb_create_rwlocks\(fd,)e
(hash_size\))i(0)596 4045 y(#define)g(tdb_spinlock\(tdb,)f(list,)i
(rw_type\))g(\(-1\))596 4127 y(#define)f(tdb_spinunlock\(tdb,)f(list,)i
(rw_type\))f(\(-1\))596 4209 y(#else)596 4292 y(int)h
(tdb_spinlock\(TDB_CONTEXT)d(*tdb,)j(int)g(list,)g(int)g(rw_type\);)596
4374 y(int)g(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k(int)h(list,)f(int)g
(rw_type\);)596 4456 y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g
(int)g(hash_size\);)596 4538 y(#endif)596 4620 y(int)g
(tdb_clear_spinlocks\(TDB_CONTEXT)39 b(*tdb\);)596 4703
y(#endif)596 4867 y(#endif)596 5041 y Fd(Code:)20 b
(/home/mikal/opensour)o(ce/trivsql/trivsql_spinlock.h)596
5207 y Fe(Trivsql)43 b(0.1)h(-)p Fa(>)h Fe(0.2)596 5371
y(20020605)e(Michael)h(Still)g(\(mikal@stillhq.com\))640
5453 y(Added)g(functions)g(mapping)f(the)i(ADO)f(recordset)f(interface)
p Black 197 5585 a Fd(66)p Black eop
%%Page: 67 67
67 66 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(20020606)43 b(Michael)h(Still)g
(\(mikal@stillhq.com\))640 253 y(Improved)g(error)g(reporting)596
418 y(Trivsql)f(0.2)h(-)p Fa(>)h Fe(0.3)596 582 y(20020606)e(Michael)h
(Still)g(\(mikal@stillhq.com\))640 664 y(SQL)h(parsing)e(fixes)596
829 y(Trivsql)g(0.3)h(-)p Fa(>)h Fe(0.3.1)596 993 y(20020606)e(Michael)
h(Still)g(\(mikal@stillhq.com\))640 1075 y(Bug)h(fixes)596
1240 y(Trivsql)e(0.3.1)h(-)p Fa(>)h Fe(0.3.2)596 1404
y(20020606)e(Michael)h(Still)g(\(mikal@stillhq.com\))640
1486 y(ALTER)g(TABLE)g(command)596 1651 y(20020607)f(Michael)h(Still)g
(\(mikal@stillhq.com\))640 1733 y(The)h(key)f(names)g(for)g(the)h
(cells)f(are)g(now)g(stored)g(in)h(the)f(recordset)f(to)i(enable)f(up-)
596 1815 y(datable)f(recordsets)g(to)i(be)f(implemented)f(soon...)596
1979 y(20020608)g(Michael)h(Still)g(\(mikal@stillhq.com\))640
2062 y(Updateable)f(recordsets)h(now)g(work)596 2226
y(Trivsql)f(0.2)h(-)p Fa(>)h Fe(0.3)596 2400 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/ChangeLog)596 2566
y Fe(#)44 b(This)g(file)g(is)h(a)g(shell)f(script)f(that)i(caches)e
(the)i(results)e(of)i(configure)596 2648 y(#)f(tests)g(run)g(on)h(this)
f(system)g(so)g(they)h(can)f(be)g(shared)g(between)g(configure)596
2730 y(#)g(scripts)g(and)g(configure)f(runs.)89 b(It)45
b(is)f(not)h(useful)e(on)i(other)f(systems.)596 2812
y(#)g(If)h(it)f(contains)g(results)f(you)i(don't)f(want)g(to)g(keep,)g
(you)h(may)f(remove)g(or)g(edit)g(it.)596 2894 y(#)596
2977 y(#)g(By)h(default,)e(configure)g(uses)i(./config.cache)d(as)j
(the)f(cache)g(file,)596 3059 y(#)g(creating)g(it)g(if)h(it)f(does)g
(not)h(exist)f(already.)88 b(You)44 b(can)h(give)f(configure)596
3141 y(#)g(the)h(--cache-file=FILE)c(option)j(to)h(use)f(a)h(different)
e(cache)h(file;)g(that)g(is)596 3223 y(#)g(what)g(configure)g(does)g
(when)g(it)g(calls)g(configure)g(scripts)f(in)596 3305
y(#)h(subdirectories,)e(so)j(they)f(share)g(the)g(cache.)596
3388 y(#)g(Giving)g(--cache-file=/dev/null)d(disables)j(caching,)f(for)
h(debugging)g(configure.)596 3470 y(#)g(config.status)f(only)h(pays)g
(attention)f(to)i(the)f(cache)g(file)g(if)h(you)f(give)g(it)h(the)596
3552 y(#)f(--recheck)f(option)h(to)h(rerun)f(configure.)596
3634 y(#)596 3716 y(ac_cv_exeext=${ac_cv_exeext=no})596
3799 y(ac_cv_header_dlfcn_h=${ac_cv_header_)o(dlfcn_)o(h=yes})596
3881 y(ac_cv_header_stdc=${ac_cv_header_std)o(c=yes})596
3963 y(ac_cv_lib_dl_dlopen=${ac_cv_lib_dl_d)o(lopen=)o(yes})596
4045 y(ac_cv_lib_fl_yywrap=${ac_cv_lib_fl_y)o(ywrap=)o(yes})596
4127 y(ac_cv_lib_m_atan=${ac_cv_lib_m_atan=)o(yes})596
4209 y(ac_cv_path_LD=${ac_cv_path_LD=/usr/b)o(in/ld})596
4292 y(ac_cv_path_NM=${ac_cv_path_NM='/usr/)o(bin/nm)38
b(-B'})596 4374 y(ac_cv_path_install=${ac_cv_path_inst)o(all='/)o
(usr/bi)o(n/inst)o(all)h(-c'})596 4456 y
(ac_cv_prog_CC=${ac_cv_prog_CC=gcc})596 4538 y
(ac_cv_prog_CPP=${ac_cv_prog_CPP='gcc)f(-E'})596 4620
y(ac_cv_prog_LEX=${ac_cv_prog_LEX=flex)o(})596 4703 y
(ac_cv_prog_LN_S=${ac_cv_prog_LN_S='l)o(n)h(-s'})596
4785 y(ac_cv_prog_RANLIB=${ac_cv_prog_RANLI)o(B=ranl)o(ib})596
4867 y(ac_cv_prog_YACC=${ac_cv_prog_YACC='b)o(ison)g(-y'})596
4949 y(ac_cv_prog_cc_cross=${ac_cv_prog_cc_)o(cross=)o(no})596
5031 y(ac_cv_prog_cc_g=${ac_cv_prog_cc_g=ye)o(s})596
5114 y(ac_cv_prog_cc_works=${ac_cv_prog_cc_)o(works=)o(yes})596
5196 y(ac_cv_prog_gcc=${ac_cv_prog_gcc=yes})596 5278
y(ac_cv_prog_gnu_ld=${ac_cv_prog_gnu_l)o(d=yes})596 5360
y(ac_cv_prog_lex_root=${ac_cv_prog_lex)o(_root=)o(lex.yy)o(})596
5442 y(ac_cv_prog_lex_yytext_pointer=${ac_c)o(v_prog)o(_lex_y)o(ytext_)
o(pointe)o(r=yes})p Black 3601 5585 a Fd(67)p Black eop
%%Page: 68 68
68 67 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(ac_cv_prog_make_make_set=${ac_cv_pro)o(g_make)o
(_make_)o(set=ye)o(s})596 171 y(lt_cv_dlopen=${lt_cv_dlopen=dlopen})596
253 y(lt_cv_dlopen_libs=${lt_cv_dlopen_lib)o(s=-ldl)o(})596
336 y(lt_cv_dlopen_self=${lt_cv_dlopen_sel)o(f=yes})596
418 y(lt_cv_dlopen_self_static=${lt_cv_dlo)o(pen_se)o(lf_sta)o(tic=no)o
(})596 592 y Fd(Code:)g(/home/mikal/opensour)o
(ce/trivsql/con\002g.cache)685 757 y Fe(Copyright)43
b(\(C\))i(Michael)e(Still)h(2002)685 922 y(This)g(program)g(is)g(free)h
(software;)e(you)h(can)h(redistribute)d(it)j(and/or)f(modify)685
1004 y(it)h(under)f(the)g(terms)g(of)g(the)h(GNU)f(General)g(Public)g
(License)f(as)i(published)e(by)685 1086 y(the)i(Free)f(Software)f
(Foundation;)g(either)h(version)g(2)g(of)h(the)f(License,)g(or)685
1168 y(\(at)h(your)f(option\))f(any)i(later)f(version.)685
1333 y(This)g(program)g(is)g(distributed)f(in)i(the)f(hope)g(that)h(it)
f(will)g(be)h(useful,)685 1415 y(but)g(WITHOUT)e(ANY)h(WARRANTY;)g
(without)f(even)i(the)f(implied)g(warranty)f(of)685 1497
y(MERCHANTABILITY)f(or)j(FITNESS)f(FOR)g(A)h(PARTICULAR)e(PURPOSE.)88
b(See)44 b(the)685 1579 y(GNU)h(General)e(Public)h(License)g(for)g
(more)g(details.)685 1744 y(You)h(should)e(have)h(received)g(a)h(copy)f
(of)g(the)h(GNU)f(General)g(Public)f(License)685 1826
y(along)h(with)g(this)g(program;)g(if)g(not,)h(write)f(to)g(the)g(Free)
h(Software)685 1908 y(Foundation,)e(Inc.,)h(675)g(Mass)h(Ave,)f
(Cambridge,)f(MA)h(02139,)g(USA.)596 2082 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/Copyright)596 2248
y Fe(#!/bin/bash)596 2412 y(function)43 b(verify)h(\(\){)775
2494 y(loclearn=0)775 2576 y(if)g([)h("\045$3\045")f(=)g("\0452\045")g
(])775 2659 y(then)865 2741 y(loclearn=1)775 2823 y(elif)g([)h
("\045$3\045")e(=)i("\0451\045")f(])775 2905 y(then)865
2987 y(loclearn=1)775 3070 y(fi)775 3234 y(locdisplay=0)775
3316 y(if)g([)h("\045$34\045")f(=)g("\0452\045")g(])775
3398 y(then)865 3481 y(locdisplay=1)775 3563 y(elif)g([)h("\045$4\045")
e(=)i("\0451\045")f(])775 3645 y(then)865 3727 y(locdisplay=1)775
3809 y(fi)775 3974 y(touch)g(testout/$2)775 4056 y(echo)g(-n)g("$2:)h
(\\"$1\\")e(")775 4138 y(echo)h("$1")g Fa(>)h Fe(testout/$2.new)775
4220 y(echo)f("")g Fa(>>)h Fe(testout/$2.new)775 4302
y(echo)f("$1")g(|)h(./sample)e(foo.tdb)h Fa(>>)g Fe(testout/$2.new)775
4467 y(if)g([)h($?)f(==)h(139)f(])775 4549 y(then)865
4631 y(echo)g("Core)g(dump")g Fa(>)g Fe(testout/$2.new)865
4713 y(rm)g(core)775 4796 y(fi)775 4960 y(if)g([)h(`diff)f(testout/$2)f
(testout/$2.new)g(|)h(wc)h(-l)f(|)h(tr)f(-d)h(")g("`)f(-gt)g(0)h(])775
5042 y(then)865 5124 y(if)f([)h("\045$loclearn\045")d(=)j("\0451\045")f
(])865 5207 y(then)954 5289 y(echo)g("[NEW)g(RESULT)g(LEARNT]")640
5371 y(cp)h(testout/$2.new)d(testout/$2)865 5453 y(else)p
Black 197 5585 a Fd(68)p Black eop
%%Page: 69 69
69 68 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 954 89 a Fe(echo)44 b(-n)h("[FAIL")640 171 y(touch)f
(testout/$2.prev)954 253 y(if)h([)f(`diff)g(testout/$2.prev)f
(testout/$2.new)f(|)j(wc)f(-l)h(|)f(tr)h(-d)f(")h("`)g(-)596
336 y(gt)f(0)h(])954 418 y(then)1044 500 y(echo)f(")h(NEW]")730
582 y(echo)f("---------------------------------------)o(------)o
(------)o(------)o(---)596 664 y(--")730 747 y(cat)g(testout/$2.new)730
829 y(echo)g("---------------------------------------)o(------)o
(------)o(------)o(---)596 911 y(--")954 993 y(else)1044
1075 y(echo)g(")h(OLD]")954 1158 y(fi)865 1240 y(fi)775
1322 y(else)865 1404 y(echo)f("[PASS]")775 1486 y(fi)775
1651 y(if)g([)h("\045$locdisplay\045")d(=)j("\0451\045")f(])775
1733 y(then)865 1815 y(echo)g("")865 1897 y(cat)g(testout/$2.new)865
1979 y(echo)g("")775 2062 y(fi)775 2226 y(#)h(We)f(remember)f(last)i
(time)f(as)g(well)775 2308 y(mv)g(testout/$2.new)f(testout/$2.prev)596
2390 y(})596 2555 y(####################################)o(######)o
(######)o(######)o(######)o(######)o(#)596 2719 y(echo)h("Parsing)f
(command)h(line)g(variables")596 2801 y(result=0)596
2966 y(learn=0)222 b(#)45 b(Don't)f(learn)g(the)g(output)g(as)h
(correct)596 3048 y(display=0)132 b(#)45 b(Don't)f(display)g(output)596
3212 y(while)g([)g($result)g(-lt)g(1)h(])596 3295 y(do)685
3377 y(getopts)f("ld")g(arg)685 3459 y(result=$?)685
3623 y(if)h([)f($result)g(-lt)g(1)h(])685 3706 y(then)775
3788 y(case)f($arg)g(in)640 3870 y(\\?)h(\))640 3952
y(echo)g("Usage:)e($0)i([-l]")640 4034 y(echo)g("")640
4116 y(echo)g("l:)f(Learn)g(that)g(the)g(current)g(output)g(is)g
(\\"correct\\"")640 4199 y(echo)h("d:)f(Display)f(the)i(current)e
(output")954 4281 y(echo)h("")640 4363 y(exit)h(0)f(;;)640
4527 y(l)h(\))640 4610 y(if)g([)g("\045$optarg\045")d(=)j("\045\045")f
(])954 4692 y(then)1044 4774 y(echo)g("Learning)f(all)i(new)f(values")
1044 4856 y(learn=1)954 4938 y(else)1044 5021 y(echo)g("Learning)f(new)
i(values)e(for)i($optarg")1044 5103 y(learn=$optarg)954
5185 y(fi)g(;;)640 5349 y(d)g(\))640 5432 y(if)g([)g("\045$optarg\045")
d(=)j("\045\045")f(])p Black 3601 5585 a Fd(69)p Black
eop
%%Page: 70 70
70 69 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 954 89 a Fe(then)1044 171 y(echo)44 b("Displaying)f(values")1044
253 y(display=1)954 336 y(else)1044 418 y(echo)h("Displaying)f(value)h
(for)g($optarg")1044 500 y(display=$optarg)954 582 y(fi)h(;;)775
664 y(esac)685 747 y(fi)596 829 y(done)596 993 y(echo)f("Removing)f
(old)h(db")596 1075 y(rm)g(foo.tdb)596 1240 y(echo)g("Creating)f(db")
596 1322 y(verify)g("CREATE)h(TABLE)g(foo)g(\(cola,)g(colb,)g(colc\);")
g(create001)f($learn)h($display)596 1404 y(verify)f("CREATE)h(TABLE)g
(hyphen-hyphen)f(\(hyphen-col\);")f(create002)h($learn)h($display)596
1486 y(verify)f("CREATE)h(TABLE)g(mIxEdCaSe)f(\(cola\);")h(create003)f
($learn)h($display)596 1569 y(verify)f("CREATE)h(TABLE)g(singlecol)f
(\('foo'\);")h(create004)f($learn)h($display)596 1651
y(verify)f("CREATE)h(TABLE)g(cepConfig)f(\(version\);")g(create005)h
($learn)f($display)596 1815 y(if)h([)h("\045$1\045")e(=)i
("\045create\045")e(])596 1897 y(then)685 1979 y(exit)596
2062 y(fi)596 2226 y(echo)h("")596 2308 y(echo)g("Insert)f(into)h
(table")596 2390 y(verify)f("INSERT)h(INTO)g(foo)g(\(cola,)g(colb,)g
(colc\))g(VALUES)g(\('duck',)g('chicken',)f('frog'\);")g(in-)596
2473 y(sert001)g($learn)h($display)596 2555 y(verify)f("INSERT)h(INTO)g
(foo)g(\(cola,)g(colb\))g(VALUES)g(\('duck',)g('hamster'\);")e(in-)596
2637 y(sert002)h($learn)h($display)596 2719 y(verify)f("INSERT)h(INTO)g
(foo)g(\(cola,)g(colc\))g(VALUES)g(\('banana',)f('frog'\);")h
(insert003)f($learn)h($display)596 2801 y(verify)f("INSERT)h(INTO)g
(banana)g(\(cola\))g(VALUES)g(\('chicken'\);")e(insert004)i($learn)f
($display)596 2884 y(verify)g("INSERT)h(INTO)g(foo)g(\(cola\))g(VALUES)
g(\('this-has-hyphens'\);")d(insert005)j($learn)f($display)596
2966 y(verify)g("INSERT)h(INTO)g(hyphen-hyphen)f(\(hyphen-col\))g
(VALUES)g(\('567'\);")h(insert006)f($learn)h($display)596
3048 y(verify)f("INSERT)h(INTO)g(mIxEdCaSe)f(\(cola\))h(VALUES)g
(\('567'\);")f(insert007)h($learn)g($display)596 3130
y(verify)f("INSERT)h(INTO)g(cepConfig)f(\(mainwindowsizex\))f(VALUES)i
(\('224'\);")g(insert008)f($learn)h($display)596 3295
y(if)g([)h("\045$1\045")e(=)i("\045insert\045")e(])596
3377 y(then)685 3459 y(exit)596 3541 y(fi)596 3706 y(echo)h("")596
3788 y(echo)g("Select)f(tests")596 3870 y(verify)g("SELECT)h(cola,)g
(colb,)g(colc)g(FROM)g(foo;")g(sel001)g($learn)g($display)596
3952 y(verify)f("SELECT)h(*)h(FROM)f(foo;")g(sel002)g($learn)f
($display)596 4034 y(verify)g("SELECT)h(cola,)g(colc)g(FROM)g(foo;")g
(sel003)g($learn)g($display)596 4116 y(verify)f("SELECT)h(cola,)g
(colb,)g(colc)g(FROM)g(foo)h(WHERE)f(cola)g(=)g('duck';")g(sel004)g
($learn)g($display)596 4199 y(verify)f("SELECT)h(*)h(FROM)f
(nosuchtable;")e(sel005)i($learn)g($display)596 4281
y(verify)f("SELECT)h(cola)g(FROM)g(foo;")g(sel006)g($learn)g($display)
596 4445 y(echo)g("")596 4527 y(echo)g("Alter)f(tests")596
4610 y(verify)g("ALTER)h(foo)g(ADD)h(COLUMN)f(cold;")f(alter001)h
($learn)g($display)596 4692 y(verify)f("SELECT)h(*)h(FROM)f(foo;")g
(alter002)f($learn)h($display)596 4774 y(verify)f("INSERT)h(INTO)g(foo)
g(\(cola,)g(cold\))g(VALUES\('duck',)f('gerkin'\);")g(alter003)g
($learn)h($display)596 4856 y(verify)f("SELECT)h(*)h(FROM)f(foo;")g
(alter004)f($learn)h($display)596 5021 y(echo)g("")596
5103 y(echo)g("Update)f(tests")596 5185 y(verify)g("CREATE)h(TABLE)g
(upd)g(\(one,)g(two\);")g(update001)f($learn)h($display)596
5267 y(verify)f("INSERT)h(INTO)g(upd)g(\(one,)g(two\))h(VALUES\('a',)e
('b'\);")g(update002)h($learn)g($display)596 5349 y(verify)f("SELECT)h
(*)h(FROM)f(upd;")g(update003)f($learn)h($display)596
5432 y(verify)f("UPDATE)h(upd)g(SET)h(one)f(=)h('c';")f(update004)f
($learn)h($display)p Black 197 5585 a Fd(70)p Black eop
%%Page: 71 71
71 70 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(verify)43 b("SELECT)h(*)h(FROM)f(upd;")g(update005)f
($learn)h($display)596 171 y(verify)f("INSERT)h(INTO)g(upd)g(\(one,)g
(two\))h(VALUES\('e',)e('f'\);")g(update006)h($learn)g($display)596
253 y(verify)f("UPDATE)h(upd)g(SET)h(two)f(=)h('g')f(WHERE)g(two)g(=)h
('f';")f(update007)f($learn)h($display)596 336 y(verify)f("SELECT)h(*)h
(FROM)f(upd;")g(update008)f($learn)h($display)596 500
y(echo)g("")596 582 y(echo)g("Selection)f(tree)h(tests")596
664 y(verify)f("SELECT)h(*)h(FROM)f(foo)g(WHERE)g(cola)g(=)h('duck')f
(AND)g(colb)g(=)h('chicken';")e(sel-)596 747 y(tree001)g($learn)h
($display)596 829 y(verify)f("SELECT)h(*)h(FROM)f(foo)g(WHERE)g(cola)g
(=)h('duck')f(OR)g(colb)g(=)h('chicken';")e(sel-)596
911 y(tree002)g($learn)h($display)596 1085 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/test.sh)596 1251
y Fe(#include)43 b("trivsql_tdb.h")596 1333 y(#include)g
("trivsql_spinlock.h")596 1497 y(#ifndef)g(TRIVSQL_HEADER)596
1579 y(#define)g(TRIVSQL_HEADER)596 1744 y(#ifdef)g(__cplusplus)596
1826 y(extern)g("C")596 1908 y({)596 1990 y(#endif)596
2155 y(#define)g(TRIVSQL_FALSE)g(0)596 2237 y(#define)g(TRIVSQL_TRUE)g
(1)596 2401 y(#define)g(TRIVSQL_NOSUCHTABLE)f(2)596 2483
y(#define)h(TRIVSQL_BADVALUES)f(3)596 2566 y(#define)h
(TRIVSQL_MEMORYERROR)f(4)596 2648 y(#define)h(TRIVSQL_TDBNULLKEY)f(5)
596 2730 y(#define)h(TRIVSQL_TDBNULLDATA)f(6)596 2812
y(#define)h(TRIVSQL_TDBSTOREERROR)e(7)596 2894 y(#define)i
(TRIVSQL_NOSUCHCOLUMN)f(8)596 2977 y(#define)h(TRIVSQL_NOROWSTOUPDATE)e
(9)596 3059 y(#define)i(TRIVSQL_BADSELCOLARG)f(10)596
3141 y(#define)h(TRIVSQL_DBOPENFAIL)f(11)596 3305 y(#define)h(SELTRUE)h
(1)596 3388 y(#define)f(SELFALSE)h(0)596 3552 y(typedef)f(int)h
(\(*trivsql_selectorfunc\))d(\(char)j(*arg1,)g(char)g(*arg2\);)596
3716 y(typedef)f(struct)h(trivsql_internal_seltreenode)596
3799 y({)685 3881 y(char)g(*selArgOne;)685 3963 y(int)h(selColOne;)685
4045 y(char)f(*selArgTwo;)685 4127 y(int)h(selColTwo;)685
4209 y(trivsql_selectorfunc)d(selector;)685 4292 y(struct)i
(trivsql_internal_seltreenode)c(*left,)k(*right;)596
4374 y(})g(trivsql_seltreenode;)596 4538 y(typedef)f(struct)h
(trivsql_internal_col)596 4620 y({)685 4703 y(char)g(*val;)685
4785 y(char)g(*key;)685 4867 y(struct)g(trivsql_internal_col)d(*next;)
596 4949 y(})j(trivsql_col;)596 5114 y(typedef)f(struct)h
(trivsql_internal_row)596 5196 y({)685 5278 y(trivsql_col)f(*cols;)685
5360 y(struct)h(trivsql_internal_row)d(*next,)j(*prev;)596
5442 y(})g(trivsql_row;)p Black 3601 5585 a Fd(71)p Black
eop
%%Page: 72 72
72 71 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 171 a Fe(typedef)43 b(struct)h(trivsql_internal_rs)596
253 y({)685 336 y(int)h(numCols;)685 418 y(int)g(numRows;)685
500 y(trivsql_row)e(*rows;)685 582 y(trivsql_row)g(*currentRow;)685
747 y(char)h(*tname;)685 829 y(char)g(*cols;)685 993
y(int)h(errno;)685 1075 y(char)f(*errstring;)596 1158
y(})g(trivsql_recordset;)596 1322 y(typedef)f(struct)h
(trivsql_internal_state)596 1404 y({)685 1486 y(TDB_CONTEXT)f(*db;)685
1569 y(trivsql_recordset)f(*rs;)685 1651 y(trivsql_seltreenode)g
(*seltree;)685 1733 y(char)i(*table;)596 1815 y(})g(trivsql_state;)596
1979 y(//)g(Internal)f(functions)596 2062 y(trivsql_state)f
(*trivsql_init\(char)g(*\);)596 2144 y(void)i(trivsql_docreate\(char)d
(*,)j(char)h(*\);)596 2226 y(void)f(trivsql_doinsert\(char)d(*,)j(char)
h(*,)f(char)g(*\);)596 2308 y(void)g(trivsql_doselect\(char)d(*,)j
(char)h(*\);)596 2390 y(void)f(trivsql_doalter\(char)d(*,)k(char)f
(*\);)596 2555 y(int)g(*trivsql_parsecols\(char)d(*,)j(char)g(*,)h(int)
f(*\);)596 2637 y(int)g(trivsql_findcol\(char)d(*,)k(char)f(*,)g(char)h
(*\);)596 2719 y(void)f(trivsql_addrow\(trivsql_recordset)39
b(*,)45 b(char)f(*,)g(int,)g(int)h(*\);)596 2801 y(char)f
(*trivsql_getallcolumns\(char)c(*\);)596 2884 y(trivsql_recordset)h
(*trivsql_makers\(\);)596 2966 y(trivsql_seltreenode)g
(*trivsql_makest\(\);)596 3048 y(trivsql_seltreenode*)g
(trivsql_makesel\(trivsql_selectorfunc,)e(char)44 b(*,)g(char)g(*\);)
596 3130 y(trivsql_seltreenode*)d
(trivsql_makeslr\(trivsql_selectorfunc,)999 3212 y(trivsql_seltreenode)
h(*,)999 3295 y(trivsql_seltreenode)g(*\);)596 3377 y(int)i
(trivsql_executeselector\(trivsql_seltre)o(enode)38 b(*,)45
b(int\);)596 3541 y(void)f(trivsql_checktable\(char)d(*,)j
(trivsql_recordset)e(*\);)596 3706 y(void)i
(*trivsql_xmalloc\(size_t\);)596 3788 y(void)g
(trivsql_dbwrite\(trivsql_state)c(*,)k(char)g(*,)h(char)f(*\);)596
3870 y(char)g(*trivsql_dbread\(trivsql_state)c(*,)k(char)g(*\);)596
3952 y(char)g(*trivsql_xsnprintf\(char)d(*,)j(...\);)596
4034 y(void)g(trivsql_xfree\(void)d(*\);)596 4116 y(void)j
(*trivsql_xrealloc\(void)d(*,)j(size_t\);)596 4199 y(int)g
(trivsql_min\(int,)e(int\);)596 4281 y(int)i
(trivsql_initok\(trivsql_state)c(*\);)596 4445 y(//)k(Selectors)596
4527 y(int)g(trivsql_selequal\(char)d(*,)k(char)f(*\);)596
4610 y(int)g(trivsql_sellike\(char)d(*,)k(char)f(*\);)596
4692 y(int)g(trivsql_selor\(int,)e(int\);)596 4774 y(int)i
(trivsql_seland\(int,)d(int\);)596 4938 y(//)j(Interface)f(methods)596
5021 y(trivsql_state)f(*trivsql_opendb\(char)g(*\);)596
5103 y(trivsql_recordset)f(*trivsql_execute\(trivsql_state)f(*,)45
b(char)f(*\);)596 5185 y(int)g(trivsql_gettext\(char)d(*,)k(int\);)596
5267 y(void)f(trivsql_displayrs\(trivsql_recordset)39
b(*\);)596 5349 y(void)44 b(trivsql_rsmovefirst\(trivsql_recordset)38
b(*\);)596 5432 y(void)44 b(trivsql_rsmovenext\(trivsql_recordset)38
b(*\);)p Black 197 5585 a Fd(72)p Black eop
%%Page: 73 73
73 72 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(int)44 b(trivsql_rseof\(trivsql_recordset)39
b(*\);)596 171 y(int)44 b(trivsql_rsbof\(trivsql_recordset)39
b(*\);)596 253 y(char)44 b(*trivsql_rsfield\(trivsql_recordset)39
b(*,)44 b(int\);)596 336 y(void)g(trivsql_updaters\(trivsql_state)39
b(*,)45 b(trivsql_recordset)d(*,)i(char)h(*,)f(char)g(*\);)596
418 y(void)g(trivsql_rsupdatefield\(trivsql_state)39
b(*,)44 b(trivsql_recordset)e(*,)865 500 y(int,)i(char)g(*newval\);)596
664 y(#ifdef)f(__cplusplus)596 747 y(})596 829 y(#endif)596
993 y(#endif)596 1168 y Fd(Code:)20 b(/home/mikal/opensour)o
(ce/trivsql/trivsql.h)596 1333 y Fe(#ifndef)43 b(__SPINLOCK_H__)596
1415 y(#define)g(__SPINLOCK_H__)596 1579 y(#if)h(HAVE_CONFIG_H)596
1662 y(#include)f Fa(<)p Fe(config.h)p Fa(>)596 1744
y Fe(#endif)596 1908 y(#include)g Fa(<)p Fe(trivsql_tdb.h)p
Fa(>)596 2072 y Fe(#ifdef)g(USE_SPINLOCKS)596 2237 y(#define)g
(RWLOCK_BIAS)g(0x1000UL)596 2401 y(/*)h(OS)h(SPECIFIC)e(*/)596
2483 y(#define)g(MAX_BUSY_LOOPS)g(1000)596 2566 y(#undef)g
(USE_SCHED_YIELD)596 2730 y(/*)h(ARCH)g(SPECIFIC)g(*/)596
2812 y(/*)g(We)h(should)e(make)h(sure)h(these)f(are)g(padded)g(to)g(a)h
(cache)f(line)g(*/)596 2894 y(#if)g(defined\(SPARC_SPINLOCKS\))596
2977 y(typedef)f(volatile)h(char)g(spinlock_t;)596 3059
y(#elif)g(defined\(POWERPC_SPINLOCKS\))596 3141 y(typedef)f(volatile)h
(unsigned)f(long)h(spinlock_t;)596 3223 y(#elif)g
(defined\(INTEL_SPINLOCKS\))596 3305 y(typedef)f(volatile)h(int)g
(spinlock_t;)596 3388 y(#elif)g(defined\(MIPS_SPINLOCKS\))596
3470 y(typedef)f(volatile)h(unsigned)f(long)h(spinlock_t;)596
3552 y(#else)596 3634 y(#error)f(Need)h(to)h(implement)e(spinlock)h
(code)g(in)g(spinlock.h)596 3716 y(#endif)596 3881 y(typedef)f(struct)h
({)640 3963 y(spinlock_t)f(lock;)640 4045 y(volatile)h(int)g(count;)596
4127 y(})g(tdb_rwlock_t;)596 4292 y(int)g(tdb_spinlock\(TDB_CONTEXT)d
(*tdb,)j(int)g(list,)g(int)g(rw_type\);)596 4374 y(int)g
(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k(int)h(list,)f(int)g(rw_type\);)
596 4456 y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g(int)g
(hash_size\);)596 4538 y(int)g(tdb_clear_spinlocks\(TDB_CONTEXT)39
b(*tdb\);)596 4703 y(#else)44 b(/*)g(!USE_SPINLOCKS)e(*/)596
4785 y(#if)i(0)596 4867 y(#define)f(tdb_create_rwlocks\(fd,)e
(hash_size\))i(0)596 4949 y(#define)g(tdb_spinlock\(tdb,)f(list,)i
(rw_type\))g(\(-1\))596 5031 y(#define)f(tdb_spinunlock\(tdb,)f(list,)i
(rw_type\))f(\(-1\))596 5114 y(#else)596 5196 y(int)h
(tdb_spinlock\(TDB_CONTEXT)d(*tdb,)j(int)g(list,)g(int)g(rw_type\);)596
5278 y(int)g(tdb_spinunlock\(TDB_CONTEXT)c(*tdb,)k(int)h(list,)f(int)g
(rw_type\);)596 5360 y(int)g(tdb_create_rwlocks\(int)d(fd,)j(unsigned)g
(int)g(hash_size\);)596 5442 y(#endif)p Black 3601 5585
a Fd(73)p Black eop
%%Page: 74 74
74 73 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(int)44 b(tdb_clear_spinlocks\(TDB_CONTEXT)39
b(*tdb\);)596 171 y(#endif)596 336 y(#endif)596 510 y
Fd(Code:)20 b(/home/mikal/opensour)o(ce/trivsql/trivsql_spinlock.h)596
675 y Fe(#ifndef)43 b(__TDB_H__)596 757 y(#define)g(__TDB_H__)596
922 y(/*)730 1004 y(Unix)h(SMB/Netbios)f(implementation.)730
1086 y(Version)h(3.0)730 1168 y(Samba)g(database)f(functions)730
1251 y(Copyright)g(\(C\))i(Andrew)e(Tridgell)h(1999)730
1415 y(This)g(program)g(is)g(free)g(software;)g(you)g(can)g
(redistribute)f(it)i(and/or)f(modify)730 1497 y(it)h(under)e(the)i
(terms)f(of)g(the)h(GNU)f(General)g(Public)f(License)h(as)h(published)e
(by)730 1579 y(the)h(Free)g(Software)g(Foundation;)f(either)h(version)f
(2)i(of)g(the)f(License,)f(or)730 1662 y(\(at)h(your)g(option\))g(any)g
(later)g(version.)730 1826 y(This)g(program)g(is)g(distributed)f(in)i
(the)f(hope)g(that)g(it)h(will)f(be)h(useful,)730 1908
y(but)f(WITHOUT)g(ANY)g(WARRANTY;)g(without)f(even)h(the)h(implied)e
(warranty)h(of)730 1990 y(MERCHANTABILITY)e(or)j(FITNESS)e(FOR)i(A)f
(PARTICULAR)g(PURPOSE.)88 b(See)44 b(the)730 2072 y(GNU)g(General)g
(Public)g(License)f(for)i(more)f(details.)730 2237 y(You)g(should)g
(have)g(received)g(a)g(copy)h(of)f(the)g(GNU)h(General)e(Public)h
(License)730 2319 y(along)g(with)g(this)g(program;)g(if)g(not,)g(write)
g(to)h(the)f(Free)g(Software)730 2401 y(Foundation,)f(Inc.,)h(675)g
(Mass)g(Ave,)h(Cambridge,)e(MA)h(02139,)g(USA.)596 2483
y(*/)596 2648 y(#ifdef)88 b(__cplusplus)596 2730 y(extern)43
b("C")i({)596 2812 y(#endif)596 2977 y(#include)e Fa(<)p
Fe(stdlib.h)p Fa(>)596 3059 y Fe(#include)g Fa(<)p Fe(stdio.h)p
Fa(>)596 3141 y Fe(#include)g Fa(<)p Fe(fcntl.h)p Fa(>)596
3223 y Fe(#include)g Fa(<)p Fe(unistd.h)p Fa(>)596 3305
y Fe(#include)g Fa(<)p Fe(string.h)p Fa(>)596 3388 y
Fe(#include)g Fa(<)p Fe(fcntl.h)p Fa(>)596 3470 y Fe(#include)g
Fa(<)p Fe(sys/mman.h)p Fa(>)596 3552 y Fe(#include)g
Fa(<)p Fe(sys/stat.h)p Fa(>)596 3634 y Fe(#include)g
Fa(<)p Fe(sys/time.h)p Fa(>)596 3799 y Fe(/*)h(flags)g(to)g
(tdb_store\(\))f(*/)596 3881 y(#define)g(TDB_REPLACE)g(1)596
3963 y(#define)g(TDB_INSERT)g(2)596 4045 y(#define)g(TDB_MODIFY)g(3)596
4209 y(/*)h(flags)g(for)g(tdb_open\(\))f(*/)596 4292
y(#define)g(TDB_DEFAULT)g(0)i(/*)f(just)g(a)h(readability)e(place)h
(holder)g(*/)596 4374 y(#define)f(TDB_CLEAR_IF_FIRST)f(1)596
4456 y(#define)h(TDB_INTERNAL)g(2)i(/*)f(don't)g(store)g(on)h(disk)f
(*/)596 4538 y(#define)f(TDB_NOLOCK)133 b(4)45 b(/*)f(don't)g(do)h(any)
f(locking)g(*/)596 4620 y(#define)f(TDB_NOMMAP)133 b(8)45
b(/*)f(don't)g(use)g(mmap)h(*/)596 4703 y(#define)e(TDB_CONVERT)g(16)i
(/*)f(convert)g(endian)g(\(internal)f(use\))h(*/)596
4867 y(#define)f(TDB_ERRCODE\(code,)f(ret\))i(\(\(tdb-)p
Fa(>)p Fe(ecode)f(=)i(\(code\)\),)e(ret\))596 5031 y(/*)h(error)g
(codes)g(*/)596 5114 y(enum)g(TDB_ERROR)f({TDB_SUCCESS=0,)f
(TDB_ERR_CORRUPT,)g(TDB_ERR_IO,)h(TDB_ERR_LOCK,)685 5196
y(TDB_ERR_OOM,)g(TDB_ERR_EXISTS,)f(TDB_ERR_NOEXIST,)g(TDB_ERR_NOLOCK)h
(};)596 5360 y(#ifndef)g(u32)596 5442 y(#define)g(u32)h(unsigned)p
Black 197 5585 a Fd(74)p Black eop
%%Page: 75 75
75 74 bop Black 0 TeXcolorgray Black 2034 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(#endif)596 253 y(typedef)43 b(struct)h({)640
336 y(char)h(*dptr;)640 418 y(size_t)f(dsize;)596 500
y(})g(TDB_DATA;)596 664 y(typedef)f(u32)h(tdb_len;)596
747 y(typedef)f(u32)h(tdb_off;)596 911 y(/*)g(this)g(is)h(stored)e(at)i
(the)f(front)g(of)h(every)f(database)f(*/)596 993 y(struct)g
(tdb_header)g({)640 1075 y(char)i(magic_food[32];)d(/*)i(for)h
(/etc/magic)e(*/)640 1158 y(u32)i(version;)e(/*)i(version)e(of)i(the)f
(code)g(*/)640 1240 y(u32)h(hash_size;)e(/*)h(number)g(of)h(hash)f
(entries)f(*/)640 1322 y(tdb_off)h(rwlocks;)640 1404
y(tdb_off)g(reserved[31];)596 1486 y(};)596 1651 y(struct)f
(tdb_lock_type)g({)640 1733 y(u32)i(count;)640 1815 y(u32)g(ltype;)596
1897 y(};)596 2062 y(struct)e(tdb_traverse_lock)f({)640
2144 y(struct)i(tdb_traverse_lock)e(*next;)640 2226 y(u32)j(off;)640
2308 y(u32)g(hash;)596 2390 y(};)596 2555 y(/*)f(this)g(is)h(the)f
(context)g(structure)f(that)h(is)h(returned)e(from)h(a)h(db)f(open)h
(*/)596 2637 y(typedef)e(struct)h(tdb_context)f({)640
2719 y(char)i(*name;)e(/*)i(the)f(name)g(of)h(the)f(database)g(*/)640
2801 y(void)h(*map_ptr;)e(/*)h(where)g(it)h(is)f(currently)g(mapped)f
(*/)640 2884 y(int)i(fd;)f(/*)g(open)h(file)f(descriptor)f(for)h(the)h
(database)e(*/)640 2966 y(tdb_len)h(map_size;)f(/*)i(how)f(much)g
(space)g(has)h(been)f(mapped)g(*/)640 3048 y(int)h(read_only;)e(/*)h
(opened)g(read-only)f(*/)640 3130 y(struct)h(tdb_lock_type)f(*locked;)g
(/*)i(array)f(of)g(chain)g(locks)g(*/)640 3212 y(enum)h(TDB_ERROR)e
(ecode;)h(/*)g(error)g(code)g(for)h(last)f(tdb)g(error)g(*/)640
3295 y(struct)g(tdb_header)f(header;)h(/*)g(a)h(cached)f(copy)g(of)h
(the)f(header)g(*/)640 3377 y(u32)h(flags;)e(/*)i(the)f(flags)g(passed)
g(to)h(tdb_open)e(*/)640 3459 y(u32)i(*lockedkeys;)d(/*)j(array)f(of)g
(locked)g(keys:)g(first)g(is)h(#keys)f(*/)640 3541 y(struct)g
(tdb_traverse_lock)e(travlocks;)h(/*)i(current)e(traversal)h(locks)g
(*/)640 3623 y(struct)g(tdb_context)f(*next;)h(/*)g(all)h(tdbs)f(to)g
(avoid)g(multiple)g(opens)g(*/)640 3706 y(dev_t)g(device;)g(/*)g
(uniquely)g(identifies)f(this)h(tdb)h(*/)640 3788 y(ino_t)f(inode;)g
(/*)h(uniquely)e(identifies)g(this)h(tdb)h(*/)640 3870
y(void)g(\(*log_fn\)\(struct)d(tdb_context)h(*tdb,)h(int)g(level,)g
(const)g(char)g(*,)g(...\);)g(/*)h(log-)596 3952 y(ging)f(function)f
(*/)640 4034 y(int)i(open_flags;)e(/*)h(flags)g(used)g(in)h(the)f(open)
g(-)h(needed)f(by)g(reopen)g(*/)596 4116 y(})g(TDB_CONTEXT;)596
4281 y(typedef)f(int)h(\(*tdb_traverse_func\)\(TDB_CONTEXT)c(*,)k
(TDB_DATA,)g(TDB_DATA,)f(void)h(*\);)596 4363 y(typedef)f(void)h
(\(*tdb_log_func\)\(TDB_CONTEXT)d(*,)j(int)g(,)h(const)f(char)g(*,)h
(...\);)596 4527 y(TDB_CONTEXT)d(*tdb_open\(const)h(char)h(*name,)g
(int)g(hash_size,)f(int)i(tdb_flags,)954 4610 y(int)f(open_flags,)f
(mode_t)h(mode\);)596 4692 y(TDB_CONTEXT)e(*tdb_open_ex\(const)g(char)i
(*name,)g(int)h(hash_size,)e(int)h(tdb_flags,)775 4774
y(int)g(open_flags,)f(mode_t)h(mode,)775 4856 y(tdb_log_func)f
(log_fn\);)596 5021 y(int)h(tdb_reopen\(TDB_CONTEXT)d(*tdb\);)596
5103 y(int)j(tdb_reopen_all\(void\);)596 5185 y(void)g
(tdb_logging_function\(TDB_CONTEXT)39 b(*tdb,)44 b(tdb_log_func\);)596
5267 y(enum)g(TDB_ERROR)f(tdb_error\(TDB_CONTEXT)e(*tdb\);)596
5349 y(const)j(char)g(*tdb_errorstr\(TDB_CONTEXT)c(*tdb\);)596
5432 y(TDB_DATA)j(tdb_fetch\(TDB_CONTEXT)e(*tdb,)j(TDB_DATA)g(key\);)p
Black 3601 5585 a Fd(75)p Black eop
%%Page: 76 76
76 75 bop Black 0 TeXcolorgray Black 197 -132 a Fd(trivsql:)21
b(A)g(trivial)f(SQL)h(engine)g(for)g(your)f(application)p
Black 596 89 a Fe(int)44 b(tdb_delete\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)f
(key\);)596 171 y(int)h(tdb_store\(TDB_CONTEXT)d(*tdb,)j(TDB_DATA)g
(key,)g(TDB_DATA)f(dbuf,)h(int)h(flag\);)596 253 y(int)f
(tdb_close\(TDB_CONTEXT)d(*tdb\);)596 336 y(TDB_DATA)i
(tdb_firstkey\(TDB_CONTEXT)e(*tdb\);)596 418 y(TDB_DATA)i
(tdb_nextkey\(TDB_CONTEXT)e(*tdb,)j(TDB_DATA)f(key\);)596
500 y(int)h(tdb_traverse\(TDB_CONTEXT)d(*tdb,)j(tdb_traverse_func)e
(fn,)i(void)g(*state\);)596 582 y(int)g(tdb_exists\(TDB_CONTEXT)d
(*tdb,)j(TDB_DATA)f(key\);)596 664 y(int)h(tdb_lockkeys\(TDB_CONTEXT)d
(*tdb,)j(u32)g(number,)g(TDB_DATA)f(keys[]\);)596 747
y(void)h(tdb_unlockkeys\(TDB_CONTEXT)c(*tdb\);)596 829
y(int)k(tdb_lockall\(TDB_CONTEXT)d(*tdb\);)596 911 y(void)j
(tdb_unlockall\(TDB_CONTEXT)c(*tdb\);)596 1075 y(/*)k(Low)g(level)g
(locking)g(functions:)f(use)h(with)h(care)f(*/)596 1158
y(int)g(tdb_chainlock\(TDB_CONTEXT)c(*tdb,)k(TDB_DATA)g(key\);)596
1240 y(void)g(tdb_chainunlock\(TDB_CONTEXT)c(*tdb,)k(TDB_DATA)f(key\);)
596 1404 y(/*)h(Debug)g(functions.)f(Not)h(used)h(in)f(production.)f
(*/)596 1486 y(void)h(tdb_dump_all\(TDB_CONTEXT)c(*tdb\);)596
1569 y(void)k(tdb_printfreelist\(TDB_CONTEXT)c(*tdb\);)596
1733 y(extern)j(TDB_DATA)h(tdb_null;)596 1897 y(#ifdef)88
b(__cplusplus)596 1979 y(})596 2062 y(#endif)596 2226
y(#endif)43 b(/*)i(tdb.h)f(*/)596 2400 y Fd(Code:)20
b(/home/mikal/opensour)o(ce/trivsql/trivsql_tdb.h)197
2801 y Fh(Conc)n(lusion)596 2943 y Fg(This)28 b(paper)g(has)g
(described)f Fi(trivsql)p Fg(,)g(a)h(SQL)g(engine)h(which)g(can)f(be)g
(embedded)f(into)j(your)596 3034 y(code.)25 b(This)i(code)f(is)g(still)
h(a)f(work)g(in)h(pr)o(ogr)o(ess,)e(and)h(updates)f(on)i(it's)f
(development)g(can)g(be)596 3126 y(found)20 b(at)h(http://www)-8
b(.stillhq.com)197 3372 y Fj(Notes)p Black 596 3518 a
Fg(1.)p Black 69 w(Ther)o(e)25 b(ar)o(e)g(also)g(functions)i(which)g
(allow)f(you)g(to)h(do)e(slightly)i(mor)o(e)f(inter)o(esting)g(opera-)
728 3610 y(tions,)c(such)f(as)g(enumerating)g(all)f(of)h(the)g(keys)g
(de\002ned)f(in)h(the)g(database.)p Black 596 3743 a(2.)p
Black 69 w(The)f(Samba)e(team)h(needs)g(to)h(stor)o(e)f(a)g(lar)o(ge)f
(amount)j(of)e(information)h(about)g(user)f(connec-)728
3834 y(tions.)24 b(This)g(ranges)f(fr)o(om)g(the)g(name)h(of)f(all)g
(logged)h(on)f(users,)g(to)h(the)g(locks)f(on)h(\002les)g(that)728
3925 y(those)c(users)g(curr)o(ently)f(hold.)h(At)f(the)g(moment)i(this)
f(information)g(is)g(stor)o(ed)f(in)h(a)f(series)g(of)728
4016 y(\(key)-9 b(,)21 b(value\))f Fi(TDB)i Fg(databases)e(\()p
Fi(TDB)i Fg(is)f(outside)h(the)f(scope)h(of)f(this)h(paper)-6
b(.)19 b(A)i(brief)g(sum-)728 4108 y(mary)29 b(is)h(that)g(it)f(is)h(a)
f(very)g(powerful)g(GDBM)g(like)h(\(key)-9 b(,)28 b(value\))h(pair)f
(database)g(which)728 4199 y(supports)i(concurr)o(ent)f(access)g(and)f
(locking.)j(It)e(has)g(also)g(had)g(a)g(SQL)g(implementation)728
4290 y(built)f(on)f(top)g(of)g(it,)g(although)h(the)f(Samba)e(team)i
(doesn't)g(use)g(this\),)g(with)h(several)e(keys)728
4382 y(for)21 b(each)f(user)6 b('s)21 b(information.)h(It)e(is)i(now)f
(possible)h(to)f(simply)g(save)g(a)f(string)h(r)o(epr)o(esenta-)728
4473 y(tion)27 b(of)g(a)e(str)o(uctur)o(e)h(describing)g(the)h(user)-6
b(,)25 b(and)h(r)o(ecover)f(that)h(str)o(uctur)o(e)g(each)g(time)g(it)h
(is)728 4564 y(needed.)p Black 197 5585 a Fd(76)p Black
eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
