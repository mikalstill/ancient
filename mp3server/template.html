<html>

<head>
<link rel="stylesheet" type="text/css" href="/local/style.css"
      media="screen" />
<title>MP3 server: %(song)s</title>
</head>

<body>

<script type="text/javascript">
//<![CDATA[
    function makeHttpRequest(url, callback_function, return_xml)
    {
    var http_request, response, i;

    var activex_ids = ['MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP',
                       'Microsoft.XMLHTTP'];

    if (window.XMLHttpRequest) { // Mozilla, Safari, IE7+...
        http_request = new XMLHttpRequest();
	if (http_request.overrideMimeType) {
	    http_request.overrideMimeType('text/xml');
	}
    } else if (window.ActiveXObject) { // IE6 and older
        for (i = 0; i < activex_ids.length; i++) {
	    try {
	        http_request = new ActiveXObject(activex_ids[i]);
	    } catch (e) {}
        }
    }

    if (!http_request) {
        return false;
    }

    http_request.onreadystatechange = function() {
        if (http_request.readyState !== 4) {
            // not ready yet
            return;
        }
        if (http_request.status !== 200) {
            // ready, but not OK
            return;
        }
        if (return_xml) {
            response = http_request.responseXML;
        } else {
            response = http_request.responseText;
        }
        // invoke the callback
        callback_function(response);
    };

    http_request.open('GET', url, true);
    http_request.send(null);
    }

    function donothing(text){}


    var myListener = new Object();
    
    /**
     * Initialisation
     */
    myListener.onInit = function()
    {
        this.position = 0;
	this.ended = 0;
    };
    /**
     * Update
     */
    myListener.onUpdate = function()
    {
        document.getElementById("info_position").innerHTML = this.position + "ms";
        document.getElementById("info_duration").innerHTML = this.duration + "ms";
        document.getElementById("info_bytes").innerHTML = this.bytesLoaded;

        var isPlaying = (this.isPlaying == "true");
	document.getElementById("playerplay").style.display = (isPlaying) ? "none" : "block";
        document.getElementById("playerpause").style.display = (isPlaying) ? "block" : "none";
        
        var timelineWidth = 160;
        var sliderWidth = 40;
        var sliderPositionMin = 40;
        var sliderPositionMax = sliderPositionMin + timelineWidth - sliderWidth;
        var sliderPosition = sliderPositionMin + Math.round((timelineWidth - sliderWidth) * this.position / this.duration);
        
        if (sliderPosition < sliderPositionMin) {
             sliderPosition = sliderPositionMin;
        }
        if (sliderPosition > sliderPositionMax) {
             sliderPosition = sliderPositionMax;
        }
        
	document.getElementById("playerslider").style.left = sliderPosition + "px";

	if ((this.duration > 0) && (this.duration - this.position < 1000)) {
	     if (this.ended == 0) {
	          makeHttpRequest("/done/" + this.position + "_" + this.duration + "/%(id)s", donothing);
	          this.ended = 1;
             }
        }

	if ((this.ended == 1) && (this.position == 0)) {
	    setTimeout('window.location.reload()', 1500);
        }
    };
    
    function getFlashObject()
    {
        return document.getElementById("myFlash");
    }
    function pause()
    {
        getFlashObject().SetVariable("method:pause", "");
    }
    function stop()
    {
        getFlashObject().SetVariable("method:stop", "");
    }
    function setPosition()
    {
        var position = document.getElementById("inputPosition").value;
        getFlashObject().SetVariable("method:setPosition", position);
    }
    function setVolume()
    {
        var volume = document.getElementById("inputVolume").value;
        getFlashObject().SetVariable("method:setVolume", volume);
    }

    function play()
    {
        if (myListener.position == 0) {
            getFlashObject().SetVariable("method:setUrl",
                                         "mp3/%(id)s");
        }
        getFlashObject().SetVariable("method:play", "");
        getFlashObject().SetVariable("enabled", "true");
    }

//]]>
</script>
<!--[if IE]>
<script type="text/javascript" event="FSCommand(command,args)" for="myFlash">
eval(args);
</script>
<![endif]-->




<object class="playerpreview" id="myFlash" 
        type="application/x-shockwave-flash"
        data="/local/player_mp3_js.swf" width="1" height="1">
    <param name="movie" value="/medias/player_mp3_js.swf" />
    <param name="AllowScriptAccess" value="always" />
    <param name="FlashVars" value="listener=myListener&amp;interval=500" />
</object>

<div id="playercontroller">
    <div id="playerplay" class="button play">
        <a href="javascript:play()" >PLAY</a>
    </div>
    <div id="playerpause" class="button pause">
        <a href="javascript:pause()">PAUSE</a>
    </div>
    <div id="playerstop" class="button stop">
        <a href="javascript:stop()">STOP</a>
    </div>
    <div class="timeline"><a id="playerslider" href="#slider">SLIDER</a></div>
</div>

<table width=100%%>
<tr>
<td width=50%%>
    Artist: %(artist)s<br/>
    Album: %(album)s<br/>
    Song: <i>%(number)s %(song)s</i><br/>
    Play count: %(plays)s<br/>
    Skip count: %(skips)s<br/><br/>
    Tags: %(tags)s<br/><br/>
    Paths: %(paths)s
</td>
<td>
    Buffering: <span id="info_bytes"></span> bytes<br/>
    Position: <span id="info_position"></span><br/>
    Duration: <span id="info_duration"></span><br/>
</td>
</tr>
</table>

<br/><br/>

<img src="%(graph)s">

<script type="text/javascript">
setTimeout('play()', 1500);
</script>

</body>
</html>